<!DOCTYPE html><html lang="en-US"><head><title>Modeling memory objects in gem5: Ports</title><meta property="og:title" content="Modeling memory objects in gem5: Ports"><meta charset="UTF-8"><meta name="viewport" content="width=device-width,height=device-height,initial-scale=1.0"><meta name="apple-mobile-web-app-capable" content="yes"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta property="og:type" content="website"><meta name="twitter:card" content="summary"><style>@media screen{body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container button{-webkit-tap-highlight-color:transparent;-webkit-appearance:none;appearance:none;background-color:transparent;border:0;color:inherit;cursor:pointer;font-size:inherit;opacity:.8;outline:none;padding:0;transition:opacity .2s linear}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button:disabled,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button:disabled,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button:disabled,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container button:disabled{cursor:not-allowed;opacity:.15!important}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button:hover,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button:hover,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button:hover,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container button:hover{opacity:1}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button:hover:active,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button:hover:active,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button:hover:active,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container button:hover:active{opacity:.6}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button:hover:not(:disabled),body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button:hover:not(:disabled),body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button:hover:not(:disabled),body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container button:hover:not(:disabled){transition:none}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=prev],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=prev],body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button.bespoke-marp-presenter-info-page-prev{background:transparent url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSJub25lIiBzdHJva2U9IiNmZmYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgc3Ryb2tlLXdpZHRoPSI1IiBkPSJNNjggOTAgMjggNTBsNDAtNDAiLz48L3N2Zz4=") no-repeat 50%;background-size:contain;overflow:hidden;text-indent:100%;white-space:nowrap}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=next],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=next],body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button.bespoke-marp-presenter-info-page-next{background:transparent url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSJub25lIiBzdHJva2U9IiNmZmYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgc3Ryb2tlLXdpZHRoPSI1IiBkPSJtMzIgOTAgNDAtNDAtNDAtNDAiLz48L3N2Zz4=") no-repeat 50%;background-size:contain;overflow:hidden;text-indent:100%;white-space:nowrap}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=fullscreen],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=fullscreen]{background:transparent url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48ZGVmcz48c3R5bGU+LmF7ZmlsbDpub25lO3N0cm9rZTojZmZmO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2Utd2lkdGg6NXB4fTwvc3R5bGU+PC9kZWZzPjxyZWN0IHdpZHRoPSI4MCIgaGVpZ2h0PSI2MCIgeD0iMTAiIHk9IjIwIiBjbGFzcz0iYSIgcng9IjUuNjciLz48cGF0aCBkPSJNNDAgNzBIMjBWNTBtMjAgMEwyMCA3MG00MC00MGgyMHYyMG0tMjAgMCAyMC0yMCIgY2xhc3M9ImEiLz48L3N2Zz4=") no-repeat 50%;background-size:contain;overflow:hidden;text-indent:100%;white-space:nowrap}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button.exit[data-bespoke-marp-osc=fullscreen],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button.exit[data-bespoke-marp-osc=fullscreen]{background-image:url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48ZGVmcz48c3R5bGU+LmF7ZmlsbDpub25lO3N0cm9rZTojZmZmO3N0cm9rZS1saW5lY2FwOnJvdW5kO3N0cm9rZS1saW5lam9pbjpyb3VuZDtzdHJva2Utd2lkdGg6NXB4fTwvc3R5bGU+PC9kZWZzPjxyZWN0IHdpZHRoPSI4MCIgaGVpZ2h0PSI2MCIgeD0iMTAiIHk9IjIwIiBjbGFzcz0iYSIgcng9IjUuNjciLz48cGF0aCBkPSJNMjAgNTBoMjB2MjBtLTIwIDAgMjAtMjBtNDAgMEg2MFYzMG0yMCAwTDYwIDUwIiBjbGFzcz0iYSIvPjwvc3ZnPg==")}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=presenter],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=presenter]{background:transparent url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSJub25lIiBzdHJva2U9IiNmZmYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgc3Ryb2tlLXdpZHRoPSI1IiBkPSJNODcuOCA0Ny41Qzg5IDUwIDg3LjcgNTIgODUgNTJIMzVhOC43IDguNyAwIDAgMS03LjItNC41bC0xNS42LTMxQzExIDE0IDEyLjIgMTIgMTUgMTJoNTBhOC44IDguOCAwIDAgMSA3LjIgNC41ek02MCA1MnYzNm0tMTAgMGgyME00NSA0MmgyMCIvPjwvc3ZnPg==") no-repeat 50%;background-size:contain;overflow:hidden;text-indent:100%;white-space:nowrap}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container button.bespoke-marp-presenter-note-bigger{background:transparent url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBzdHJva2U9IiNmZmYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgc3Ryb2tlLXdpZHRoPSI1IiBkPSJNMTIgNTBoODBNNTIgOTBWMTAiLz48L3N2Zz4=") no-repeat 50%;background-size:contain;overflow:hidden;text-indent:100%;white-space:nowrap}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container button.bespoke-marp-presenter-note-smaller{background:transparent url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48cGF0aCBmaWxsPSJub25lIiBzdHJva2U9IiNmZmYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCIgc3Ryb2tlLXdpZHRoPSI1IiBkPSJNMTIgNTBoODAiLz48L3N2Zz4=") no-repeat 50%;background-size:contain;overflow:hidden;text-indent:100%;white-space:nowrap}}@keyframes __bespoke_marp_transition_reduced_outgoing__{0%{opacity:1}to{opacity:0}}@keyframes __bespoke_marp_transition_reduced_incoming__{0%{mix-blend-mode:plus-lighter;opacity:0}to{mix-blend-mode:plus-lighter;opacity:1}}.bespoke-marp-note,.bespoke-marp-osc,.bespoke-progress-parent{display:none;transition:none}@media screen{::view-transition-group(*){animation-duration:var(--marp-bespoke-transition-animation-duration,.5s);animation-timing-function:ease}::view-transition-new(*),::view-transition-old(*){animation-delay:0s;animation-direction:var(--marp-bespoke-transition-animation-direction,normal);animation-duration:var(--marp-bespoke-transition-animation-duration,.5s);animation-fill-mode:both;animation-name:var(--marp-bespoke-transition-animation-name,var(--marp-bespoke-transition-animation-name-fallback,__bespoke_marp_transition_no_animation__));mix-blend-mode:normal}::view-transition-old(*){--marp-bespoke-transition-animation-name-fallback:__bespoke_marp_transition_reduced_outgoing__;animation-timing-function:ease}::view-transition-new(*){--marp-bespoke-transition-animation-name-fallback:__bespoke_marp_transition_reduced_incoming__;animation-timing-function:ease}::view-transition-new(root),::view-transition-old(root){animation-timing-function:linear}::view-transition-new(__bespoke_marp_transition_osc__),::view-transition-old(__bespoke_marp_transition_osc__){animation-duration:0s!important;animation-name:__bespoke_marp_transition_osc__!important}::view-transition-new(__bespoke_marp_transition_osc__){opacity:0!important}.bespoke-marp-transition-warming-up::view-transition-group(*),.bespoke-marp-transition-warming-up::view-transition-new(*),.bespoke-marp-transition-warming-up::view-transition-old(*){animation-play-state:paused!important}body,html{height:100%;margin:0}body{background:#000;overflow:hidden}svg.bespoke-marp-slide{content-visibility:hidden;opacity:0;pointer-events:none;z-index:-1}svg.bespoke-marp-slide:not(.bespoke-marp-active) *{view-transition-name:none!important}svg.bespoke-marp-slide.bespoke-marp-active{content-visibility:visible;opacity:1;pointer-events:auto;z-index:0}svg.bespoke-marp-slide.bespoke-marp-active.bespoke-marp-active-ready *{animation-name:__bespoke_marp__!important}@supports not (content-visibility:hidden){svg.bespoke-marp-slide[data-bespoke-marp-load=hideable]{display:none}svg.bespoke-marp-slide[data-bespoke-marp-load=hideable].bespoke-marp-active{display:block}}}@media screen and (prefers-reduced-motion:reduce){svg.bespoke-marp-slide *{view-transition-name:none!important}}@media screen{[data-bespoke-marp-fragment=inactive]{visibility:hidden}body[data-bespoke-view=""] .bespoke-marp-parent,body[data-bespoke-view=next] .bespoke-marp-parent{inset:0;position:absolute}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc{view-transition-name:__bespoke_marp_transition_osc__;background:rgba(0,0,0,.65);border-radius:7px;bottom:50px;color:#fff;contain:paint;display:block;font-family:Helvetica,Arial,sans-serif;font-size:16px;left:50%;line-height:0;opacity:1;padding:12px;position:absolute;touch-action:manipulation;transform:translateX(-50%);transition:opacity .2s linear;-webkit-user-select:none;user-select:none;white-space:nowrap;will-change:transform;z-index:1}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>*,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>*{margin-left:6px}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>:first-child,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>:first-child{margin-left:0}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>span,body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>span{opacity:.8}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>span[data-bespoke-marp-osc=page],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>span[data-bespoke-marp-osc=page]{display:inline-block;min-width:140px;text-align:center}body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=fullscreen],body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=next],body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=presenter],body[data-bespoke-view=""] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=prev],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=fullscreen],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=next],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=presenter],body[data-bespoke-view=next] .bespoke-marp-parent>.bespoke-marp-osc>button[data-bespoke-marp-osc=prev]{height:32px;line-height:32px;width:32px}body[data-bespoke-view=""] .bespoke-marp-parent.bespoke-marp-inactive,body[data-bespoke-view=next] .bespoke-marp-parent.bespoke-marp-inactive{cursor:none}body[data-bespoke-view=""] .bespoke-marp-parent.bespoke-marp-inactive>.bespoke-marp-osc,body[data-bespoke-view=next] .bespoke-marp-parent.bespoke-marp-inactive>.bespoke-marp-osc{opacity:0;pointer-events:none}body[data-bespoke-view=""] svg.bespoke-marp-slide,body[data-bespoke-view=next] svg.bespoke-marp-slide{height:100%;left:0;position:absolute;top:0;width:100%}body[data-bespoke-view=""] .bespoke-progress-parent{background:#222;display:flex;height:5px;width:100%}body[data-bespoke-view=""] .bespoke-progress-parent+.bespoke-marp-parent{top:5px}body[data-bespoke-view=""] .bespoke-progress-parent .bespoke-progress-bar{background:#0288d1;flex:0 0 0;transition:flex-basis .2s cubic-bezier(0,1,1,1)}body[data-bespoke-view=next]{background:transparent}body[data-bespoke-view=presenter]{background:#161616}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container{display:grid;font-family:Helvetica,Arial,sans-serif;grid-template:"current dragbar next" minmax(140px,1fr) "current dragbar note" 2fr "info    dragbar note" 3em;grid-template-columns:minmax(3px,var(--bespoke-marp-presenter-split-ratio,66%)) 0 minmax(3px,1fr);height:100%;left:0;position:absolute;top:0;width:100%}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-parent{grid-area:current;overflow:hidden;position:relative}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-parent svg.bespoke-marp-slide{height:calc(100% - 40px);left:20px;pointer-events:none;position:absolute;top:20px;-webkit-user-select:none;user-select:none;width:calc(100% - 40px)}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-parent svg.bespoke-marp-slide.bespoke-marp-active{filter:drop-shadow(0 3px 10px rgba(0,0,0,.5))}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-dragbar-container{background:#0288d1;cursor:col-resize;grid-area:dragbar;margin-left:-3px;opacity:0;position:relative;transition:opacity .4s linear .1s;width:6px;z-index:10}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-dragbar-container:hover{opacity:1}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-dragbar-container.active{opacity:1;transition-delay:0s}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-next-container{background:#222;cursor:pointer;display:none;grid-area:next;overflow:hidden;position:relative}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-next-container.active{display:block}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-next-container iframe.bespoke-marp-presenter-next{background:transparent;border:0;display:block;filter:drop-shadow(0 3px 10px rgba(0,0,0,.5));height:calc(100% - 40px);left:20px;pointer-events:none;position:absolute;top:20px;-webkit-user-select:none;user-select:none;width:calc(100% - 40px)}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container{background:#222;color:#eee;grid-area:note;position:relative;z-index:1}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container button{height:1.5em;line-height:1.5em;width:1.5em}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-presenter-note-wrapper{display:block;inset:0;position:absolute}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-presenter-note-buttons{background:rgba(0,0,0,.65);border-radius:4px;bottom:0;display:flex;gap:4px;margin:12px;opacity:0;padding:6px;pointer-events:none;position:absolute;right:0;transition:opacity .2s linear}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-presenter-note-buttons:focus-within,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-presenter-note-wrapper:focus-within+.bespoke-marp-presenter-note-buttons,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container:hover .bespoke-marp-presenter-note-buttons{opacity:1;pointer-events:auto}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note{word-wrap:break-word;box-sizing:border-box;font-size:calc(1.1em*var(--bespoke-marp-note-font-scale, 1));height:calc(100% - 40px);margin:20px;overflow:auto;padding-right:3px;scrollbar-color:hsla(0,0%,93%,.5) transparent;scrollbar-width:thin;white-space:pre-wrap;width:calc(100% - 40px)}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note::-webkit-scrollbar{width:6px}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note::-webkit-scrollbar-track{background:transparent}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note::-webkit-scrollbar-thumb{background:hsla(0,0%,93%,.5);border-radius:6px}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note:empty{pointer-events:none}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note.active{display:block}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note p:first-child{margin-top:0}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-note-container .bespoke-marp-note p:last-child{margin-bottom:0}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container{align-items:center;box-sizing:border-box;color:#eee;display:flex;flex-wrap:nowrap;grid-area:info;justify-content:center;overflow:hidden;padding:0 10px}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-page,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-time,body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-timer{box-sizing:border-box;display:block;padding:0 10px;white-space:nowrap;width:100%}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container button{height:1.5em;line-height:1.5em;width:1.5em}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-page{order:2;text-align:center}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-page .bespoke-marp-presenter-info-page-text{display:inline-block;min-width:120px;text-align:center}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-time{color:#999;order:1;text-align:left}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-timer{color:#999;order:3;text-align:right}body[data-bespoke-view=presenter] .bespoke-marp-presenter-container .bespoke-marp-presenter-info-container .bespoke-marp-presenter-info-timer:hover{cursor:pointer}}@media print{.bespoke-marp-presenter-info-container,.bespoke-marp-presenter-next-container,.bespoke-marp-presenter-note-container{display:none}}</style><style>@charset "UTF-8";@import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap');div#\:\$p>svg>foreignObject>section{width:1280px;height:720px;box-sizing:border-box;overflow:hidden;position:relative;scroll-snap-align:center center}div#\:\$p>svg>foreignObject>section:after{bottom:0;content:attr(data-marpit-pagination);padding:inherit;pointer-events:none;position:absolute;right:0}div#\:\$p>svg>foreignObject>section:not([data-marpit-pagination]):after{display:none}/* Normalization */div#\:\$p>svg>foreignObject>section :is(h1,marp-h1){font-size:2em;margin:0.67em 0}div#\:\$p>svg>foreignObject>section video::-webkit-media-controls{will-change:transform}@page{size:1280px 720px;margin:0}@media print{body,html{background-color:#fff;margin:0;page-break-inside:avoid;break-inside:avoid-page}div#\:\$p>svg>foreignObject>section{page-break-before:always;break-before:page}div#\:\$p>svg>foreignObject>section,div#\:\$p>svg>foreignObject>section *{-webkit-print-color-adjust:exact!important;animation-delay:0s!important;animation-duration:0s!important;color-adjust:exact!important;transition:none!important}div#\:\$p>svg[data-marpit-svg]{display:block;height:100vh;width:100vw}}div#\:\$p>svg>foreignObject>:where(section){container-type:size}div#\:\$p>svg>foreignObject>section img[data-marp-twemoji]{background:transparent;height:1em;margin:0 .05em 0 .1em;vertical-align:-.1em;width:1em}
/*!
 * Marp gem5 theme
 * @theme gem5
 * @author Jason Lowe-Power
 *
 * @auto-scaling true
 * @size 16:9 1280px 720px
 * @size 4:3 960px 720px
 */div#\:\$p>svg>foreignObject>:where(section):not([root]){--gem5-gem5:#008EB0;--gem5-background:#F6F8FA;--gem5-light:#c8eaf3;--gem5-dark:#00627a;--gem5-gray:#77787b;--code-line-height:calc(var(--marpit-root-font-size, 1rem) * 2);--code-font-size:calc(var(--marpit-root-font-size, 1rem) * 1.4)}div#\:\$p>svg>foreignObject>section{color:black;font-size:calc(var(--marpit-root-font-size, 1rem) * 1.6);font-family:sans-serif;line-height:calc(var(--marpit-root-font-size, 1rem) * 2);padding:70px;background-color:var(--gem5-background);background-image:url("../themes/gem5ColorLong.svg");background-repeat:no-repeat;background-position-x:center;background-size:220px;background-position-y:97%}div#\:\$p>svg>foreignObject>section{--marpit-root-font-size:calc(var(--marpit-root-font-size, 1rem) * 1.6)}div#\:\$p>svg>foreignObject>section li{margin-bottom:calc(var(--marpit-root-font-size, 1rem) * 0.2)}div#\:\$p>svg>foreignObject>section ul{margin-bottom:calc(var(--marpit-root-font-size, 1rem) * 0.5)}

/* Move the title of the slide up a bit */div#\:\$p>svg>foreignObject>section>:first-child,div#\:\$p>svg>foreignObject>section>header:first-child+*{margin-top:0}

/* Draw a triangle on the left of the title */div#\:\$p>svg>foreignObject>section :is(h2,marp-h2):before{content:"";position:absolute;top:65px;left:-10px;width:0;height:0;border-left:30px solid transparent;border-right:30px solid transparent;border-bottom:40px solid var(--gem5-gem5);rotate:90deg}

/* Draw a triangle in the lower right */div#\:\$p>svg>foreignObject>section:before{content:"";position:absolute;bottom:0;right:0;width:0;height:0;border-left:100px solid transparent;border-top:100px solid var(--gem5-gem5);rotate:90deg}

/* Add an image to the bottom center of the page */div#\:\$p>svg>foreignObject>section footer{position:fixed;left:0;right:0;bottom:60px;height:100px;margin-bottom:-80px}div#\:\$p>svg>foreignObject>section footer img{height:60px;display:block;margin:0 auto}

/* For the page number */div#\:\$p>svg>foreignObject>section:after{right:-50px;bottom:-55px;font-size:80%;color:var(--gem5-light)}div#\:\$p>svg>foreignObject>section:after{--marpit-root-font-size:80%}div#\:\$p>svg>foreignObject>section a{color:var(--gem5-gem5)}div#\:\$p>svg>foreignObject>section blockquote{position:relative;margin:calc(var(--marpit-root-font-size, 1rem) * 0.6) 0;padding:0 calc(var(--marpit-root-font-size, 1rem) * 1.2);border-left:4px solid var(--gem5-gem5);background-color:var(--gem5-light)}div#\:\$p>svg>foreignObject>section blockquote a{color:var(--gem5-dark)}

/****************************************************/
/* For title page */
/* Remove the triangle */div#\:\$p>svg>foreignObject>section.title :is(h2,marp-h2):before{border:none}

/* Remove the triangle in the lower right */div#\:\$p>svg>foreignObject>section.title:before{border:none}

/* Remove the page number */div#\:\$p>svg>foreignObject>section.title:after{display:none}

/* Remove the bottom image */div#\:\$p>svg>foreignObject>section.title footer img{display:none}div#\:\$p>svg>foreignObject>section.title :is(h2,marp-h2){font-size:calc(var(--marpit-root-font-size, 1rem) * 5);line-height:calc(var(--marpit-root-font-size, 1rem) * 5);margin-top:50px;display:block;text-align:center;width:60%}

/* gem5 logo on the right */div#\:\$p>svg>foreignObject>section.title{background-image:url("../../slides/themes/gem5ColorVert.svg");background-repeat:no-repeat;background-position:86% 50%;background-size:440px}

/* title on the left */div#\:\$p>svg>foreignObject>section.title p{width:60%;font-size:calc(var(--marpit-root-font-size, 1rem) * 2.5);line-height:calc(var(--marpit-root-font-size, 1rem) * 2.5)}

/****************************************************/
/* For two-column layout */div#\:\$p>svg>foreignObject>section.two-col{columns:2;display:block}div#\:\$p>svg>foreignObject>section.two-col :is(h2,marp-h2){column-span:all}div#\:\$p>svg>foreignObject>section.two-col :is(h3,marp-h3){break-before:column}

/****************************************************/
/* For centering images */div#\:\$p>svg>foreignObject>section.center-image img{display:block;margin:auto}

/* For adding a border to images */div#\:\$p>svg>foreignObject>section.border-image img{border:1px solid var(--gem5-dark)}

/* For altering logo position/appearance */div#\:\$p>svg>foreignObject>section.logo-left{background-position-x:21%}div#\:\$p>svg>foreignObject>section.no-logo{background-image:none}

/****************************************************/
/* For title cards at the beginning of a section, e.g. Intro to ..., etc.
   Has a blue gradient. From Erin and Mysore
*/div#\:\$p>svg>foreignObject>section.start :is(h2,marp-h2){display:flex;flex-direction:column;justify-content:center;align-items:center;width:100%;height:100%;font-size:calc(var(--marpit-root-font-size, 1rem) * 4);font-weight:bold;line-height:75px;background:linear-gradient(to right,rgb(67,124,205),rgb(69,214,202));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}

/* Remove the triangle */div#\:\$p>svg>foreignObject>section.start :is(h2,marp-h2):before{border:none}

/****************************************************/
/* For 5 column/full outline */div#\:\$p>svg>foreignObject>section.outline :is(h2,marp-h2){column-span:all}div#\:\$p>svg>foreignObject>section.outline{column-count:5;font-size:calc(var(--marpit-root-font-size, 1rem) * 1.3);line-height:calc(var(--marpit-root-font-size, 1rem) * 1.3)}div#\:\$p>svg>foreignObject>section.outline{--marpit-root-font-size:calc(var(--marpit-root-font-size, 1rem) * 1.3)}div#\:\$p>svg>foreignObject>section.outline ul{list-style-type:none;padding:0;margin:0;padding-bottom:10px}div#\:\$p>svg>foreignObject>section.outline li{margin:0;padding-bottom:5px}div#\:\$p>svg>foreignObject>section.outline ul ul{list-style-type:"- ";padding-left:20px}div#\:\$p>svg>foreignObject>section.outline ul ul ul{display:none}div#\:\$p>svg>foreignObject>section.outline :is(h3,marp-h3){break-before:column}

/****************************************************/
/* For reducing size of code blocks */div#\:\$p>svg>foreignObject>section.code-50-percent :is(pre,marp-pre){line-height:calc(var(--code-line-height) * 0.33)}div#\:\$p>svg>foreignObject>section.code-50-percent :is(pre,marp-pre) code{font-size:calc(var(--code-font-size) * 0.5)}div#\:\$p>svg>foreignObject>section.code-60-percent :is(pre,marp-pre){line-height:calc(var(--code-line-height) * 0.48)}div#\:\$p>svg>foreignObject>section.code-60-percent :is(pre,marp-pre) code{font-size:calc(var(--code-font-size) * 0.6)}div#\:\$p>svg>foreignObject>section.code-70-percent :is(pre,marp-pre){line-height:calc(var(--code-line-height) * 0.65)}div#\:\$p>svg>foreignObject>section.code-70-percent :is(pre,marp-pre) code{font-size:calc(var(--code-font-size) * 0.7)}div#\:\$p>svg>foreignObject>section.code-80-percent :is(pre,marp-pre){line-height:calc(var(--code-line-height) * 0.8)}div#\:\$p>svg>foreignObject>section.code-80-percent :is(pre,marp-pre) code{font-size:calc(var(--code-font-size) * 0.8)}

/****************************************************/
/* For code block */div#\:\$p>svg>foreignObject>section :is(pre,marp-pre){padding:10px;border-radius:5px;line-height:var(--code-line-height);background-color:#ffffff;box-shadow:1px 2px 4px var(--gem5-gray)}div#\:\$p>svg>foreignObject>section code{font-family:"Roboto Mono",monospace;background-color:#ffffff;font-size:var(--code-font-size)}

/* Forces inherited height for code in headers */div#\:\$p>svg>foreignObject>section :is(:is(h1,marp-h1),:is(h2,marp-h2),:is(h3,marp-h3),:is(h4,marp-h4),:is(h5,marp-h5),:is(h6,marp-h6)) code{font-size:inherit!important}

/* Targets only inline code */div#\:\$p>svg>foreignObject>section :not(:is(pre,marp-pre))>code{font-size:calc(var(--code-font-size) * 0.9);padding:2px 6px;border:1px solid var(--gem5-gray);border-radius:5px}

/* Targets hyperlinks that contain code */div#\:\$p>svg>foreignObject>section a:has(code){
    /* Removes underlines */text-decoration:none}

/*!
  Theme: Default
  Description: Original highlight.js style
  Author: (c) Ivan Sagalaev <maniac@softwaremaniacs.org>
  Maintainer: @highlightjs/core-team
  Website: https://highlightjs.org/
  License: see project LICENSE
  Touched: 2021
*/

/*
This is left on purpose making default.css the single file that can be lifted
as-is from the repository directly without the need for a build step

Typically this "required" baseline CSS is added by `makestuff.js` during build.
*/div#\:\$p>svg>foreignObject>section :is(pre,marp-pre) code.hljs{display:block;overflow-x:auto;padding:calc(var(--marpit-root-font-size, 1rem) * 1);background-color:#ffffff}div#\:\$p>svg>foreignObject>section code.hljs{padding:3px 5px}

/* end baseline CSS */div#\:\$p>svg>foreignObject>section .hljs{background:#ffffff;color:#444}

/* Base color: saturation 0; */div#\:\$p>svg>foreignObject>section .hljs-subst{
    /* default */}

/* purposely ignored */div#\:\$p>svg>foreignObject>section .hljs-attr,div#\:\$p>svg>foreignObject>section .hljs-formula,div#\:\$p>svg>foreignObject>section .hljs-params,div#\:\$p>svg>foreignObject>section .hljs-property{}div#\:\$p>svg>foreignObject>section .hljs-comment{color:#697070}div#\:\$p>svg>foreignObject>section .hljs-punctuation,div#\:\$p>svg>foreignObject>section .hljs-tag{color:#444a}div#\:\$p>svg>foreignObject>section .hljs-tag .hljs-attr,div#\:\$p>svg>foreignObject>section .hljs-tag .hljs-name{color:#444}div#\:\$p>svg>foreignObject>section .hljs-attribute,div#\:\$p>svg>foreignObject>section .hljs-doctag,div#\:\$p>svg>foreignObject>section .hljs-keyword,div#\:\$p>svg>foreignObject>section .hljs-meta .hljs-keyword,div#\:\$p>svg>foreignObject>section .hljs-name,div#\:\$p>svg>foreignObject>section .hljs-selector-tag{font-weight:bold}


/* User color: hue: 0 */div#\:\$p>svg>foreignObject>section .hljs-deletion,div#\:\$p>svg>foreignObject>section .hljs-number,div#\:\$p>svg>foreignObject>section .hljs-quote,div#\:\$p>svg>foreignObject>section .hljs-selector-class,div#\:\$p>svg>foreignObject>section .hljs-selector-id,div#\:\$p>svg>foreignObject>section .hljs-string,div#\:\$p>svg>foreignObject>section .hljs-template-tag,div#\:\$p>svg>foreignObject>section .hljs-type{color:#880000}div#\:\$p>svg>foreignObject>section .hljs-section,div#\:\$p>svg>foreignObject>section .hljs-title{color:#880000;font-weight:bold}div#\:\$p>svg>foreignObject>section .hljs-link,div#\:\$p>svg>foreignObject>section .hljs-operator,div#\:\$p>svg>foreignObject>section .hljs-regexp,div#\:\$p>svg>foreignObject>section .hljs-selector-attr,div#\:\$p>svg>foreignObject>section .hljs-selector-pseudo,div#\:\$p>svg>foreignObject>section .hljs-symbol,div#\:\$p>svg>foreignObject>section .hljs-template-variable,div#\:\$p>svg>foreignObject>section .hljs-variable{color:#ab5656}

/* Language color: hue: 90; */div#\:\$p>svg>foreignObject>section .hljs-literal{color:#695}div#\:\$p>svg>foreignObject>section .hljs-addition,div#\:\$p>svg>foreignObject>section .hljs-built_in,div#\:\$p>svg>foreignObject>section .hljs-bullet,div#\:\$p>svg>foreignObject>section .hljs-code{color:#397300}


/* Meta color: hue: 200 */div#\:\$p>svg>foreignObject>section .hljs-meta{color:#1f7199}div#\:\$p>svg>foreignObject>section .hljs-meta .hljs-string{color:#38a}


/* Misc effects */div#\:\$p>svg>foreignObject>section .hljs-emphasis{font-style:italic}div#\:\$p>svg>foreignObject>section .hljs-strong{font-weight:bold}div#\:\$p>svg>foreignObject>section[data-marpit-advanced-background=background]{columns:initial!important;display:block!important;padding:0!important}div#\:\$p>svg>foreignObject>section[data-marpit-advanced-background=background]:after,div#\:\$p>svg>foreignObject>section[data-marpit-advanced-background=background]:before,div#\:\$p>svg>foreignObject>section[data-marpit-advanced-background=content]:after,div#\:\$p>svg>foreignObject>section[data-marpit-advanced-background=content]:before{display:none!important}div#\:\$p>svg>foreignObject>section[data-marpit-advanced-background=background]>div[data-marpit-advanced-background-container]{all:initial;display:flex;flex-direction:row;height:100%;overflow:hidden;width:100%}div#\:\$p>svg>foreignObject>section[data-marpit-advanced-background=background]>div[data-marpit-advanced-background-container][data-marpit-advanced-background-direction=vertical]{flex-direction:column}div#\:\$p>svg>foreignObject>section[data-marpit-advanced-background=background][data-marpit-advanced-background-split]>div[data-marpit-advanced-background-container]{width:var(--marpit-advanced-background-split,50%)}div#\:\$p>svg>foreignObject>section[data-marpit-advanced-background=background][data-marpit-advanced-background-split=right]>div[data-marpit-advanced-background-container]{margin-left:calc(100% - var(--marpit-advanced-background-split, 50%))}div#\:\$p>svg>foreignObject>section[data-marpit-advanced-background=background]>div[data-marpit-advanced-background-container]>figure{all:initial;background-position:center;background-repeat:no-repeat;background-size:cover;flex:auto;margin:0}div#\:\$p>svg>foreignObject>section[data-marpit-advanced-background=background]>div[data-marpit-advanced-background-container]>figure>figcaption{position:absolute;border:0;clip:rect(0,0,0,0);height:1px;margin:-1px;overflow:hidden;padding:0;white-space:nowrap;width:1px}div#\:\$p>svg>foreignObject>section[data-marpit-advanced-background=content],div#\:\$p>svg>foreignObject>section[data-marpit-advanced-background=pseudo]{background:transparent!important}div#\:\$p>svg>foreignObject>section[data-marpit-advanced-background=pseudo],div#\:\$p>svg[data-marpit-svg]>foreignObject[data-marpit-advanced-background=pseudo]{pointer-events:none!important}div#\:\$p>svg>foreignObject>section[data-marpit-advanced-background-split]{width:100%;height:100%}</style></head><body><div class="bespoke-marp-osc"><button data-bespoke-marp-osc="prev" tabindex="-1" title="Previous slide">Previous slide</button><span data-bespoke-marp-osc="page"></span><button data-bespoke-marp-osc="next" tabindex="-1" title="Next slide">Next slide</button><button data-bespoke-marp-osc="fullscreen" tabindex="-1" title="Toggle fullscreen (f)">Toggle fullscreen</button><button data-bespoke-marp-osc="presenter" tabindex="-1" title="Open presenter view (p)">Open presenter view</button></div><div id=":$p"><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="1" data-paginate="true" data-class="title" data-theme="gem5" lang="en-US" class="title" data-marpit-pagination="1" style="--paginate:true;--class:title;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="modeling-memory-objects-in-gem5-ports">Modeling memory objects in gem5: Ports</h2>
<p><strong>IMPORTANT</strong>: This slide deck builds on top of what has already been developed in <a href="./01-sim-objects-intro.md">Introduction to SimObjects</a>, <a href="./02-debugging-gem5.md">Debugging gem5</a>, and <a href="./03-event-driven-sim.md">Event Driven Simulation</a>.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="2" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="2" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="ports">Ports</h2>
<p>In gem5, <code>SimObjects</code> can use <code>Ports</code> to send/request data. <code>Ports</code> are gem5's <strong>main interface to the memory</strong>. There are two types of <code>Ports</code> in gem5: <code>RequestPort</code> and <code>ResponsePort</code>.</p>
<p>As their names would suggest:</p>
<ul>
<li><code>RequestPorts</code>  make <code>requests</code> and await <code>responses</code>.</li>
<li><code>ResponsePorts</code> await <code>requests</code> and send <code>responses</code>.</li>
</ul>
<p>Make sure to differentiate between <code>request</code>/<code>response</code> and <code>data</code>. Both <code>requests</code> and <code>response</code> can carry <code>data</code> with them.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="3" data-paginate="true" data-class="two-col code-50-percent" data-theme="gem5" lang="en-US" class="two-col code-50-percent" data-marpit-pagination="3" style="--paginate:true;--class:two-col code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="packets">Packets</h2>
<p><code>Packets</code> facilitate communication through ports. They can be either <code>request</code> or <code>response</code> packets.</p>
<blockquote>
<p><strong>NOTE</strong>: <code>Packet</code> in gem5 can change from a <code>request</code> to a <code>response</code>. This happens when the <code>request</code> arrives at a <code>SimObject</code> that can respond to it.</p>
</blockquote>
<p>Every <code>Packet</code> has the following fields:</p>
<ul>
<li><code>Addr</code>: Address of the memory location being accessed.</li>
<li><code>Data</code>: Data associated with the <code>Packet</code> (the data that <code>Packet</code> carries).</li>
<li><code>MemCmd</code>: Denotes the kind of <code>Packet</code> and what it should do.
<ul>
<li>Examples include: <code>readReq</code>/<code>readResp</code>/<code>writeReq</code>/<code>writeResp</code>.</li>
</ul>
</li>
<li><code>RequestorID</code>: ID for the <code>SimObject</code> that created the request (requestor).</li>
</ul>
<p>Class <code>Packet</code> is defined in <a href="../../gem5/src/mem/packet.hh"><code>gem5/src/mem/packet.hh</code></a>. Note that, in our tutorial, we will deal with <code>Packet</code> in pointers. <code>PacketPtr</code> is a type in gem5 that is equivalent to <code>Packet*</code>.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="4" data-paginate="true" data-class="no-logo code-50-percent" data-theme="gem5" lang="en-US" class="no-logo code-50-percent" data-marpit-pagination="4" style="--paginate:true;--class:no-logo code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="ports-in-gem5">Ports in gem5</h2>
<p>Let's take a look at <a href="../../gem5/src/mem/port.hh"><code>gem5/src/mem/port.hh</code></a> to see the declarations for <code>Port</code> classes.</p>
<p>Let's focus on the following functions. These functions make communication possible. Notice how <code>recvTimingReq</code> and <code>recvTimingResp</code> are <code>pure virtual</code> functions. This means that you can <strong>not</strong> instantiate an object of <code>RequestPort</code> or <code>ResponsePort</code> and instead you must extend them to fit your use case.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestPort</span> {
  ...
  <span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">sendTimingReq</span><span class="hljs-params">(PacketPtr pkt)</span></span>;
    <span class="hljs-comment">// inherited from TimingRequestProtocol in `src/mem/protocol/timing.hh`</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">recvTimingResp</span><span class="hljs-params">(PacketPtr pkt)</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">sendRetryResp</span><span class="hljs-params">()</span></span>;
   ...
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ResponsePort</span> {
  ...
  <span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">sendTimingResp</span><span class="hljs-params">(PacketPtr pkt)</span></span>;
    <span class="hljs-comment">// inherited from TimingResponseProtocol in `src/mem/protocol/timing.hh`</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">recvTimingReq</span><span class="hljs-params">(PacketPtr pkt)</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">sendRetryReq</span><span class="hljs-params">()</span></span>;
   ...
};
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="5" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="5" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="access-modes-timing-atomic-functional">Access Modes: Timing, Atomic, Functional</h2>
<p><code>Ports</code> allow 3 memory access modes:</p>
<p>1: In <strong><code>timing</code></strong> mode, accesses advance simulator time. In this mode, <code>requests</code> propagate down the memory hierarchy while each level imposes its latency and can potentially interleave processing of multiple requests. This mode is the only realistic mode in accessing the memory.<br />
2: In <strong><code>atomic</code></strong> mode, accesses do not directly advance simulator time, rather it's left to the <strong>original</strong> <code>requestor</code> to move simulator time. Accesses are done atomically (are <strong>not</strong> interleaved). This access mode is useful for fast-forwarding simulation.<br />
3: In <strong><code>functional</code></strong> mode, accesses to the memory are done through a chain of function calls. <code>Functional</code> mode does not advance simulator time. All accesses are done in series and are not interleaved. This access mode is useful for initializing simulation from files, i.e. talking from the host to the simulator.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="6" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="6" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="timing-protocol-in-action">Timing Protocol in Action</h2>
<blockquote>
<p><strong>IMPORTANT</strong>: A <code>Port</code> can only be connected to <strong>one other</strong> <code>Port</code> and it must be of a different type: <code>RequestPort</code>/<code>ResponsePort</code> can only be connected to <code>ResponsePort</code>/<code>RequestPort</code>.</p>
</blockquote>
<p>If you look at <a href="../../gem5/src/mem/port.hh"><code>gem5/src/mem/port.hh</code></a> you'll see that class <code>RequestPort</code> has a <code>private</code> member called <code>ResponsePort* _responsePort</code> that holds a pointer to the <code>ResponsePort</code> that the <code>RequestPort</code> object is connected to (its <code>peer</code>).</p>
<p>Moreover, if you look at the definition of <code>sendTimingReq</code>/<code>sendTimingResp</code> in <a href="../../gem5/src/mem/port.hh"><code>gem5/src/mem/port.hh</code></a> you'll see that they will call and return <code>peer::recvTimingReq</code>/<code>peer::recvTimingResp</code>.</p>
<p>Now let's look at 2 scenarios for communication, in these scenarios let's assume:</p>
<ul>
<li><code>Requestor</code> is a <code>SimObject</code> that has a <code>RequestPort</code>.</li>
<li><code>Responder</code> is a <code>SimObject</code> that has a <code>ReponsePort</code>.</li>
</ul>
<p><strong>NOTE</strong>: Note that while in our scenarios <code>Requestor</code> and <code>Responder</code> have one <code>Port</code>, <code>SimObjects</code> can have multiple ports of different types.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="7" data-paginate="true" data-class="center-image" data-theme="gem5" lang="en-US" class="center-image" data-marpit-pagination="7" style="--paginate:true;--class:center-image;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="scenario-everything-goes-smoothly">Scenario: Everything Goes Smoothly</h2>
<p><img src="04-ports-imgs/port_ladder_no_retry.drawio.svg" alt="port-ladder-no-retry" style="width:500px;height:500px;" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="8" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="8" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="scenario-everything-goes-smoothly-1">Scenario: Everything Goes Smoothly</h2>
<p>In this scenario:</p>
<p>1: <strong><code>Requestor</code></strong> sends a <code>Packet</code> as the <code>request</code> (e.g. a <code>readReq</code>). In C++ terms <code>Requestor::RequestPort::sendTimingReq</code> is called which in turn calls <code>Responder::ResponsePort::recvTimingReq</code>.<br />
2: <strong><code>Responder</code></strong> is not busy and accepts the <code>request</code>. In C++ terms <code>Responder::ResponsePort::recvTimingReq</code> returns <strong>true</strong>. Since <code>Requestor</code> has received true, it will receive a <code>response</code> in the future.<br />
3: Simulator time advances, <code>Requestor</code> and <code>Responder</code> continues execution. When <code>Responder</code> has the <code>response</code> (e.g. <code>readResp</code>) ready, it will send the <code>response</code> to the <code>requestor</code>. In C++ terms <code>Responder::ResponsePort::sendTimingResp</code> is called which in turn calls <code>Requestor::RequestPort::recvTimingResp</code>.<br />
4: <strong><code>Requestor</code></strong> is not busy and accepts the <code>response</code>. In C++ terms <code>Requestor::RequestPort::recvTimingResp</code> returns true. Since <code>Responder</code> has received true, the transaction is complete.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="9" data-paginate="true" data-class="center-image" data-theme="gem5" lang="en-US" class="center-image" data-marpit-pagination="9" style="--paginate:true;--class:center-image;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="scenario-responder-is-busy-diagram">Scenario: Responder Is Busy: Diagram</h2>
<p><img src="04-ports-imgs/port_ladder_req_retry.drawio.svg" alt="port-ladder-no-retry" style="width:500px;height:500px;" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="10" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="10" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="scenario-responder-is-busy">Scenario: Responder Is Busy</h2>
<p>In this scenario:</p>
<p>1: <strong><code>Requestor</code></strong> sends a <code>Packet</code> as the <code>request</code> (e.g. a <code>readReq</code>).<br />
2: <strong><code>Responder</code></strong> is busy and rejects the <code>request</code>. In C++ terms <code>Responder::ResponsePort::recvTimingReq</code> returns <strong>false</strong>. Since <code>Requestor</code> has received false, it waits for a <code>retry request</code> from <code>Responder</code>.<br />
3: When <strong><code>Responder</code></strong> becomes available (is not busy anymore), it will send a <code>retry request</code> to <code>Requestor</code>. In C++ terms <code>Responder::ResponsePort::sendReqRetry</code> is called which in turn calls <code>Requestor::RequestPort::recvReqRetry</code>.<br />
4: <strong><code>Requestor</code></strong> sends the <code>blocked Packet</code> as the <code>request</code> (e.g. a <code>readReq</code>).<br />
5: <strong><code>Responder</code></strong> is not busy and accepts the <code>request</code>.<br />
6: Simulator time advances, <code>Requestor</code> and <code>Responder</code> continue execution. When <code>Responder</code> has the <code>response</code> ready it will send the <code>response</code> to the <code>Requestor</code>.<br />
7: <strong><code>Requestor</code></strong> is not busy and can accept the <code>response</code>.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="11" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="11" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="other-scenarios">Other Scenarios</h2>
<p>There are two other possible scenarios:</p>
<p>1- A scenario where the <code>Requestor</code> is busy.<br />
2- A scenario where both <code>Requestor</code> and <code>Responder</code> are busy.</p>
<p><strong>CAUTION</strong>: Scenarios where <code>Requestor</code> is busy should not happen normally. In reality, the <code>Requestor</code> makes sure it can receive the <code>response</code> for a <code>request</code> when it sends the request. I have never run into a situation where I had to design my <code>SimObjects</code> in a way that the <code>Requestor</code> will return false when <code>recvTimingResp</code> is called. That's not to say that if you find yourself in a situation like this, you have done something wrong; BUT I would look really hard into my code/design and verify I'm simulating something realistic.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="12" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="12" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadget">InspectorGadget</h2>
<p>In this step, we will implement our new <code>SimObject</code> called <code>InspectorGadget</code>. <code>InspectorGadget</code> will monitor all the traffic to the memory and make sure all the traffic is safe. In this tutorial, we will do this in multiple steps as laid out below.</p>
<ul>
<li>Step 1: We will implement <code>InspectorGadget</code> to forward traffic from CPU to memory and back, causing latency for queueing traffic.</li>
<li>Step 2: We will extend <code>InspectorGadget</code> to <em>inspect</em> the traffic, causing further delay (for <code>1 cycle</code>) for inspection.</li>
<li>Step 3: We will extend <code>InpsectorGadget</code> like below:
<ul>
<li>It will do multiple inspection every cycle, resulting in higher traffic throughput.</li>
<li>It will expose <code>inspection_latency</code> as a parameter.</li>
</ul>
</li>
<li>Step 4: We will extend <code>InspectorGadget</code> to allow for pipelining of the inspections.</li>
</ul>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="13" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="13" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadget-diagram">InspectorGadget: Diagram</h2>
<p>Here is a diagram of what <code>InspectorGadget</code> will look like eventually.</p>
<p><img src="04-ports-imgs/inspector-gadget.drawio.svg" alt="inspector-gadget" /></p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="14" data-paginate="true" data-class="start" data-theme="gem5" lang="en-US" class="start" data-marpit-pagination="14" style="--paginate:true;--class:start;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="step-1-buffering-traffic">Step 1: Buffering Traffic</h2>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="15" data-paginate="true" data-class="no-logo code-50-percent" data-theme="gem5" lang="en-US" class="no-logo code-50-percent" data-marpit-pagination="15" style="--paginate:true;--class:no-logo code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="clockedobject">ClockedObject</h2>
<p>A <code>ClockedObject</code> is a child class of <code>SimObject</code> that provides facilities for managing time in <code>cycles</code>. Every <code>ClockedObject</code> has a <code>clk_domain</code> parameter that defines its clock frequency. Using the <code>clk_domain</code>, the <code>ClockedObject</code> provides functionalities like below:</p>
<ul>
<li><code>clockEdge(Cycles n)</code>: A function that returns the time of the <code>nth</code> clock edge into the future.</li>
<li><code>nextCycle()</code>: A function that returns the time of first clock edge into the future, i.e. <code>nextCycle() := clockEdge(Cycles(1))</code>.</li>
</ul>
<p>This class is defined in <a href="../../gem5/src/sim/clocked_object.hh"><code>gem5/src/sim/clocked_object.hh</code></a> as shown below:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ClockedObject</span> : <span class="hljs-keyword">public</span> SimObject, <span class="hljs-keyword">public</span> Clocked
{
  <span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">ClockedObject</span>(<span class="hljs-type">const</span> ClockedObjectParams &amp;p);

    <span class="hljs-comment">/** Parameters of ClockedObject */</span>
    <span class="hljs-keyword">using</span> Params = ClockedObjectParams;

    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">serialize</span><span class="hljs-params">(CheckpointOut &amp;cp)</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">unserialize</span><span class="hljs-params">(CheckpointIn &amp;cp)</span> <span class="hljs-keyword">override</span></span>;

    PowerState *powerState;
};
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="16" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="16" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadget-adding-files">InspectorGadget: Adding Files</h2>
<p>Now let's go ahead and create a <code>SimObject</code> declaration file for <code>InspectorGadget</code>. Do it by running the following commands:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-sh"><span class="hljs-built_in">cd</span> /workspaces/2024/gem5/src
<span class="hljs-built_in">mkdir</span> -p bootcamp/inspector-gadget
<span class="hljs-built_in">cd</span> bootcamp/inspector-gadget
<span class="hljs-built_in">touch</span> InspectorGadget.py
</code></pre>
<p>Now, let's also create a <code>SConscript</code> for registering <code>InspectorGadget</code>. Do it by running the following command:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-sh"><span class="hljs-built_in">touch</span> SConscript
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="17" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="17" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectogadget-simobject-declaration-file">InspectoGadget: SimObject Declaration File</h2>
<p>Now, inside <code>InspectorGadget.py</code>, let's define <code>InspectorGadget</code> as a <code>ClockedObject</code>. To do that, we need to import <code>ClockedObject</code>. Do it by adding the following line to <code>InspectorGadget.py</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-python"><span class="hljs-keyword">from</span> m5.objects.ClockedObject <span class="hljs-keyword">import</span> ClockedObject
</code></pre>
<p>The remaining part of the declaration is for now similar to that of <code>HelloSimObject</code> in <a href="01-sim-objects-intro.md">Introduction to SimObjects</a>. Do that part on your own. When you are done, you can find my version of the code in the next slide.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="18" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="18" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadget-simobject-declaration-file-so-far">InspectorGadget: SimObject Declaration File So Far</h2>
<p>This is what should be in <code>InspectorGadget.py</code> now:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-python"><span class="hljs-keyword">from</span> m5.objects.ClockedObject <span class="hljs-keyword">import</span> ClockedObject

<span class="hljs-keyword">class</span> <span class="hljs-title class_">InspectorGadget</span>(<span class="hljs-title class_ inherited__">ClockedObject</span>):
    <span class="hljs-built_in">type</span> = <span class="hljs-string">&quot;InspectorGadget&quot;</span>
    cxx_header = <span class="hljs-string">&quot;bootcamp/inspector-gadget/inspector_gadget.hh&quot;</span>
    cxx_class = <span class="hljs-string">&quot;gem5::InspectorGadget&quot;</span>
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="19" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="19" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadget-ports-in-python">InspectorGadget: Ports in Python</h2>
<p>So far we have looked at the declaration of <code>Ports</code> in C++. However, to create an instance of a C++ class in Python we need a declaration of that class in Python. <code>Ports</code> are defined under <a href="../../gem5/src/python/m5/params.py"><code>gem5/src/python/m5/params.py</code></a>. However, <code>Ports</code> do not inherit from class <code>Param</code>. I strongly recommend that you take a short look at <a href="../../gem5/src/python/m5/params.py"><code>gem5/src/python/m5/params.py</code></a>.</p>
<p>Try to find what kind of parameters you can add to any <code>SimObject</code>/<code>ClockedObject</code>.</p>
<p>Our next step is to define a <code>RequestPort</code> and a <code>ResponsePort</code> for <code>InspectorGadget</code>. To do this add the following import line to <code>InspectorGadget.py</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-python"><span class="hljs-keyword">from</span> m5.params <span class="hljs-keyword">import</span> *
</code></pre>
<p><strong>NOTE</strong>: My personal preference in Python is to import modules very explicitly. However, when importing <code>m5.params</code>, I think it's ok to do import <code>*</code>. This is mainly because, when I'm creating <code>SimObjects</code>, I might need different kinds of parameters that I might not know about in advance.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="20" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="20" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadget-adding-ports">InspectorGadget: Adding Ports</h2>
<p>Now, let's finally add two ports to <code>InspectorGadget</code>; One port will be on the side where the CPU would be in the computer system and one port will be on the side where the memory would be. Therefore, let's call them <code>cpu_side_port</code> and <code>mem_side_port</code> respectively.</p>
<p><strong>Question</strong>: What type should <code>cpu_side_port</code> and <code>mem_side_port</code> be?</p>
<p>Before looking at the answer, try to answer the question for yourself.</p>
<p><strong>Answer</strong>: <code>cpu_side_port</code> should be a <code>ResponsePort</code> and <code>mem_side_port</code> should be a <code>RequestPort</code>.</p>
<p>Make sure this answer makes sense to you before moving on to the next slide.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="21" data-paginate="true" data-class="no-logo" data-theme="gem5" lang="en-US" class="no-logo" data-marpit-pagination="21" style="--paginate:true;--class:no-logo;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadget-adding-ports-cont">InspectorGadget: Adding Ports cont.</h2>
<p>Add the following two lines under the declaration of <code>InspectorGadget</code> to add <code>cpu_side_port</code> and <code>mem_side_port</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-python">cpu_side_port = ResponsePort(<span class="hljs-string">&quot;ResponsePort to receive requests from CPU side.&quot;</span>)
mem_side_port = RequestPort(<span class="hljs-string">&quot;RequestPort to send received requests to memory side.&quot;</span>)
</code></pre>
<p>To buffer traffic, we need two FIFOs: one for <code>requests</code> (from <code>cpu_side_port</code> to <code>mem_side_port</code>) and one for <code>responses</code> (from <code>mem_side_port</code> to <code>cpu_side_port</code>). For the the FIFO in the <code>request</code> path, we know that in the future we want to <em>inspect</em> the requests. Therefore, let's call it <code>inspectionBuffer</code>. We also need a parameter to determine the the number of entries in this buffer so let's call that parameter <code>inspection_buffer_entries</code>. For the <code>response</code> path, we will simply call the buffer <code>response_buffer</code> and add a parameter for its entries named <code>response_buffer_entries</code>. Do it by adding the following lines under the declaration of <code>InspectorGadget</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-python">inspection_buffer_entries = Param.Int(<span class="hljs-string">&quot;Number of entries in the inspection buffer.&quot;</span>)
response_buffer_entries = Param.Int(<span class="hljs-string">&quot;Number of entries in the response buffer.&quot;</span>)
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="22" data-paginate="true" data-class="code-80-percent" data-theme="gem5" lang="en-US" class="code-80-percent" data-marpit-pagination="22" style="--paginate:true;--class:code-80-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadget-simobject-declaration-file">InspectorGadget: SimObject Declaration File</h2>
<p>This is what should be in <code>InspectorGadget.py</code> now:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-python"><span class="hljs-keyword">from</span> m5.objects.ClockedObject <span class="hljs-keyword">import</span> ClockedObject
<span class="hljs-keyword">from</span> m5.params <span class="hljs-keyword">import</span> *


<span class="hljs-keyword">class</span> <span class="hljs-title class_">InspectorGadget</span>(<span class="hljs-title class_ inherited__">ClockedObject</span>):
    <span class="hljs-built_in">type</span> = <span class="hljs-string">&quot;InspectorGadget&quot;</span>
    cxx_header = <span class="hljs-string">&quot;bootcamp/inspector-gadget/inspector_gadget.hh&quot;</span>
    cxx_class = <span class="hljs-string">&quot;gem5::InspectorGadget&quot;</span>

    cpu_side_port = ResponsePort(<span class="hljs-string">&quot;ResponsePort to received requests from CPU side.&quot;</span>)
    mem_side_port = RequestPort(<span class="hljs-string">&quot;RequestPort to send received requests to memory side.&quot;</span>)

    inspection_buffer_entries = Param.Int(<span class="hljs-string">&quot;Number of entries in the inspection buffer.&quot;</span>)
    response_buffer_entries = Param.Int(<span class="hljs-string">&quot;Number of entries in the response buffer.&quot;</span>)
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="23" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="23" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="updating-sconscript">Updating SConscript</h2>
<p>Remember to register <code>InspectorGadget</code> as a <code>SimObject</code> as well as create a <code>DebugFlag</code> for it.</p>
<p>To do this, put the following in <code>gem5/src/bootcamp/inspector-gadget/SConscript</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-python">Import(<span class="hljs-string">&quot;*&quot;</span>)

SimObject(<span class="hljs-string">&quot;InspectorGadget.py&quot;</span>, sim_objects=[<span class="hljs-string">&quot;InspectorGadget&quot;</span>])

Source(<span class="hljs-string">&quot;inspector_gadget.cc&quot;</span>)

DebugFlag(<span class="hljs-string">&quot;InspectorGadget&quot;</span>)
</code></pre>
<blockquote>
<p><strong>NOTE</strong>: In the next steps we will create <code>inspector_gadget.hh</code> and <code>inspector_gadget.cc</code>.</p>
</blockquote>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="24" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="24" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadget-c-files">InspectorGadget: C++ Files</h2>
<p>Now, let's go ahead and create a header and source file for <code>InspectorGadget</code> in <code>gem5/src/bootcamp/inspector-gadget</code>. Remember to make sure the path to your header file matches that of what you specified in <code>cxx_header</code> in <code>InspectorGadget.py</code> and the path for your source file matches that of what you specified in <code>SConscript</code>. Run the following commands from within our <code>inspector-gadget</code> directory:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-sh"><span class="hljs-built_in">touch</span> inspector_gadget.hh
<span class="hljs-built_in">touch</span> inspector_gadget.cc
</code></pre>
<p>Now, let's simply declare <code>InspectorGadget</code> as a class that inherits from <code>ClockedObject</code>. This means you have to import <code>sim/clocked_object.hh</code> instead of <code>sim/sim_object.hh</code>. Let's add everything that we have added in the Python to our class except for the <code>Ports</code>.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="25" data-paginate="true" data-class="code-60-percent" data-theme="gem5" lang="en-US" class="code-60-percent" data-marpit-pagination="25" style="--paginate:true;--class:code-60-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadget-header-file">InspectorGadget: Header File</h2>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __BOOTCAMP_INSPECTOR_GADGET_INSPECTOR_GADGET_HH__</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __BOOTCAMP_INSPECTOR_GADGET_INSPECTOR_GADGET_HH__</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;params/InspectorGadget.hh&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;sim/clocked_object.hh&quot;</span></span>

<span class="hljs-keyword">namespace</span> gem5
{

<span class="hljs-keyword">class</span> <span class="hljs-title class_">InspectorGadget</span> : <span class="hljs-keyword">public</span> ClockedObject
{
  <span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> inspectionBufferEntries;
    <span class="hljs-type">int</span> responseBufferEntries;

  <span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">InspectorGadget</span>(<span class="hljs-type">const</span> InspectorGadgetParams&amp; params);
};


} <span class="hljs-comment">// namespace gem5</span>

<span class="hljs-meta">#<span class="hljs-keyword">endif</span> <span class="hljs-comment">// __BOOTCAMP_INSPECTOR_GADGET_INSPECTOR_GADGET_HH__</span></span>
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="26" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="26" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadgetalign-declaration">InspectorGadget::align Declaration</h2>
<p>Since we're dealing with clocks and <code>Ticks</code>, let's add a function <code>align</code> that will return the time of the next clock cycle (in <code>Ticks</code>) after a given time (in <code>Ticks</code>).</p>
<p>To do this add the following lines under the <code>private</code> scope of <code>InspectorGadget</code> in <code>inspector_gadget.hh</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    <span class="hljs-function">Tick <span class="hljs-title">align</span><span class="hljs-params">(Tick when)</span></span>;
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="27" data-paginate="true" data-class="code-80-percent" data-theme="gem5" lang="en-US" class="code-80-percent" data-marpit-pagination="27" style="--paginate:true;--class:code-80-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadgetalign-definition">InspectorGadget::align Definition</h2>
<p>To define <code>align</code>, add the following code to <code>inspector_gadget.cc</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-keyword">namespace</span> gem5
{

<span class="hljs-function">Tick
<span class="hljs-title">InspectorGadget::align</span><span class="hljs-params">(Tick when)</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">clockEdge</span>((Cycles) std::<span class="hljs-built_in">ceil</span>((when - <span class="hljs-built_in">curTick</span>()) / <span class="hljs-built_in">clockPeriod</span>()));
}

} <span class="hljs-comment">// namespace gem5</span>
</code></pre>
<p>Make sure to add the following include statement to the top of the file since we're using <code>std::ceil</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;cmath&gt;</span></span>
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="28" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="28" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="extending-ports">Extending Ports</h2>
<p>Recall, <code>RequestPort</code> and <code>ResponsePort</code> classes were abstract classes, i.e. they had <code>pure virtual</code> functions which means objects cannot be instantiated from that class. Therefore, for us to use <code>Ports</code> we need to extend the classes and implement their <code>pure virtual</code> functions.</p>
<p>Before anything, let's go ahead and import the header file that contains the declaration for <code>Port</code> classes. We also need to include <a href="../../gem5/src/mem/packet.hh"><code>mem/packet.hh</code></a> since we will be dealing with and moving around <code>Packets</code> a lot. Do it by adding the following lines to <code>inspector_gadget.hh</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mem/packet.hh&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;mem/port.hh&quot;</span></span>
</code></pre>
<blockquote>
<p><strong>REMEMBER</strong> to follow the right include order based on gem5's convention.</p>
</blockquote>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="29" data-paginate="true" data-class="no-logo code-50-percent" data-theme="gem5" lang="en-US" class="no-logo code-50-percent" data-marpit-pagination="29" style="--paginate:true;--class:no-logo code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="extending-responseport">Extending ResponsePort</h2>
<p>Now, let's get to extending <code>ResponsePort</code> class. Let's do it inside the scope of our <code>InspectorGadget</code> class to prevent using names used by other gem5 developers. Let's go ahead an create <code>CPUSidePort</code> class that inherits from <code>ResponsePort</code> in the <code>private</code> scope. To do this, add the following code to <code>inspector_gadget.hh</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">CPUSidePort</span>: <span class="hljs-keyword">public</span> ResponsePort
    {
      <span class="hljs-keyword">private</span>:
        InspectorGadget* owner;
        <span class="hljs-type">bool</span> needToSendRetry;
        PacketPtr blockedPacket;

      <span class="hljs-keyword">public</span>:
        <span class="hljs-built_in">CPUSidePort</span>(InspectorGadget* owner, <span class="hljs-type">const</span> std::string&amp; name):
            <span class="hljs-built_in">ResponsePort</span>(name), <span class="hljs-built_in">owner</span>(owner), <span class="hljs-built_in">needToSendRetry</span>(<span class="hljs-literal">false</span>), <span class="hljs-built_in">blockedPacket</span>(<span class="hljs-literal">nullptr</span>)
        {}
        <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">needRetry</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> needToSendRetry; }
        <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">blocked</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> blockedPacket != <span class="hljs-literal">nullptr</span>; }
        <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">sendPacket</span><span class="hljs-params">(PacketPtr pkt)</span></span>;

        <span class="hljs-function"><span class="hljs-keyword">virtual</span> AddrRangeList <span class="hljs-title">getAddrRanges</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span>;
        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">recvTimingReq</span><span class="hljs-params">(PacketPtr pkt)</span> <span class="hljs-keyword">override</span></span>;
        <span class="hljs-function"><span class="hljs-keyword">virtual</span> Tick <span class="hljs-title">recvAtomic</span><span class="hljs-params">(PacketPtr pkt)</span> <span class="hljs-keyword">override</span></span>;
        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">recvFunctional</span><span class="hljs-params">(PacketPtr pkt)</span> <span class="hljs-keyword">override</span></span>;
        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">recvRespRetry</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span></span>;
    };
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="30" data-paginate="true" data-class="no-logo" data-theme="gem5" lang="en-US" class="no-logo" data-marpit-pagination="30" style="--paginate:true;--class:no-logo;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="extending-responseport-deeper-look">Extending ResponsePort: Deeper Look</h2>
<p>Here is a deeper look into the declaration of <code>CPUSidePort</code>.</p>
<p>1: <code>InspectorGadget* owner</code> is a pointer to the instance of <code>InspectorGadget</code> that owns this instance of <code>CPUSidePort</code>. We need to access the owner when we receive <code>requests</code>, i.e. when <code>recvTimingReq</code> is called.<br />
2: <code>bool needToSendRetry</code> tells us if we need to send a <code>retry request</code>. This happens when we reject a <code>request</code> because we are busy. When we are not busy, we check this before sending a <code>retry request</code>.<br />
3: In addition to all the functions that are used for moving packets, the class <code>ResponsePort</code> has another <code>pure virtual</code> function that will return an <code>AddrRangeList</code> which represents all the address ranges for which the port can respond. Note that, in a system, the memory addresses can be partitioned among ports. Class <code>RequestPort</code> has a function with the same name, but it is already implemented and will just ask its peer <code>ResponsePort</code> for the ranges by calling <code>peer::getAddrRanges</code>.<br />
4: We will need to implement all of the functions that relate to moving packets  the ones that start with <code>recv</code>. We will use <code>owner</code> to implement most of the functionality of these functions within <code>InspectorGadget</code>.<br />
5: We'll talk about <code>PacketPtr blockedPacket</code> in the next slides.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="31" data-paginate="true" data-class="no-logo code-60-percent" data-theme="gem5" lang="en-US" class="no-logo code-60-percent" data-marpit-pagination="31" style="--paginate:true;--class:no-logo code-60-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="extending-requestport">Extending RequestPort</h2>
<p>We're going to follow a similar approach for extending <code>RequestPort</code>. Let's create class <code>MemSidePort</code> that inherits from <code>RequestPort</code>. Again we'll do it in the <code>private</code> scope of <code>InspectorGadget</code>. Do it by adding the following code to <code>inspector_gadget.hh</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemSidePort</span>: <span class="hljs-keyword">public</span> RequestPort
    {
      <span class="hljs-keyword">private</span>:
        InspectorGadget* owner;
        <span class="hljs-type">bool</span> needToSendRetry;
        PacketPtr blockedPacket;

      <span class="hljs-keyword">public</span>:
        <span class="hljs-built_in">MemSidePort</span>(InspectorGadget* owner, <span class="hljs-type">const</span> std::string&amp; name):
            <span class="hljs-built_in">RequestPort</span>(name), <span class="hljs-built_in">owner</span>(owner), <span class="hljs-built_in">needToSendRetry</span>(<span class="hljs-literal">false</span>), <span class="hljs-built_in">blockedPacket</span>(<span class="hljs-literal">nullptr</span>)
        {}
        <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">needRetry</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> needToSendRetry; }
        <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">blocked</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> blockedPacket != <span class="hljs-literal">nullptr</span>; }
        <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">sendPacket</span><span class="hljs-params">(PacketPtr pkt)</span></span>;

        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">recvTimingResp</span><span class="hljs-params">(PacketPtr pkt)</span> <span class="hljs-keyword">override</span></span>;
        <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">recvReqRetry</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span></span>;
    };
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="32" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="32" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="extending-requestport-deeper-look">Extending RequestPort: Deeper Look</h2>
<p>Let's take a deeper look into what we added for class <code>MemSidePort</code>.</p>
<p>1: Like <code>CPUSidePort</code>, a <code>MemSidePort</code> instance holds a pointer to its <code>owner</code> with <code>InspectorGadget* owner</code>. We do this to access the owner when we receive <code>responses</code>, i.e. when <code>recvTimingResp</code> is called.<br />
2: When <code>MemSidePort::sendTimingReq</code> receives false, it means the request was blocked. We track a pointer to this blocked <code>Packet</code> in <code>PacketPtr blockedPacket</code> so that we can retry the request later.<br />
3: Function <code>blocked</code> tells us if we are blocked by the memory side, i.e. still waiting to receive a <code>retry request</code> from memory side.<br />
4: Function <code>sendPacket</code> is a wrapper around <code>sendTimingReq</code> to give our code more structure. Notice we don't need to definte <code>sendTimingReq</code> as it is already defined by <code>TimingRequestProtocol</code>.<br />
5: We will need to implement all of the functions that relate to moving packets  the ones that start with <code>recv</code>. We will use <code>owner</code> to implement most of the functionality of these functions within <code>InspectorGadget</code>.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="33" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="33" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="creating-instances-of-ports-in-inspectorgadget">Creating Instances of Ports in InspectorGadget</h2>
<p>Now that we have declared <code>CPUSidePort</code> and <code>MemSidePort</code> classes (which are not abstract classes), we can go ahead and create an instance of each class in <code>InspectorGadget</code>. To do that, add the following two lines to <code>inspector_gadget.hh</code></p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    CPUSidePort cpuSidePort;
    MemSidePort memSidePort;
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="34" data-paginate="true" data-class="code-50-percent" data-theme="gem5" lang="en-US" class="code-50-percent" data-marpit-pagination="34" style="--paginate:true;--class:code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="simobjectgetport">SimObject::getPort</h2>
<p>Let's take a look at <a href="../../gem5/src/sim/sim_object.hh"><code>gem5/src/sim/sim_object.hh</code></a> again. Below is a snippet of code from the declaration of the function <code>getPort</code> in the class <code>SimObject</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">public</span>:
<span class="hljs-comment">/**
     * Get a port with a given name and index. This is used at binding time
     * and returns a reference to a protocol-agnostic port.
     *
     * gem5 has a request and response port interface. All memory objects
     * are connected together via ports. These ports provide a rigid
     * interface between these memory objects. These ports implement
     * three different memory system modes: timing, atomic, and
     * functional. The most important mode is the timing mode and here
     * timing mode is used for conducting cycle-level timing
     * experiments. The other modes are only used in special
     * circumstances and should *not* be used to conduct cycle-level
     * timing experiments. The other modes are only used in special
     * circumstances. These ports allow SimObjects to communicate with
     * each other.
     *
     * @param if_name Port name
     * @param idx Index in the case of a VectorPort
     *
     * @return A reference to the given port
     *
     * @ingroup api_simobject
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> Port &amp;<span class="hljs-title">getPort</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string &amp;if_name, PortID idx=InvalidPortID)</span></span>;
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="35" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="35" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="simobjectgetport-cont">SimObject::getPort cont.</h2>
<p>This function is used for connecting ports to each other. As far as we are concerned, we need to create a mapping between our <code>Port</code> objects in C++ and the <code>Ports</code> that we declare in Python. To the best of my knowledge, we will never have to call this function on our own.</p>
<p>For now, let's implement this function to return a <code>Port&amp;</code> when we recognize <code>if_name</code> (which would be the name that we gave to a <code>Port</code> in Python) and, otherwise, we will pass this up to the parent class <code>ClockedObject</code> to handle the function call.</p>
<p>Let's go ahead and add the declaration for this function to <code>inspector_gadget.hh</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> Port&amp; <span class="hljs-title">getPort</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; if_name, PortID idxInvalidPortID)</span></span>;
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="36" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="36" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="enough-with-the-declarations-for-now">Enough with the Declarations! For Now!</h2>
<p>So far, we have declared quite a few functions that we need to implement. Let's start defining some of them. In the next several slides, we will be defining functions from <code>CPUSidePort</code> and <code>MemSidePort</code>, as well as <code>getPort</code> from <code>InspectorGadget</code>.</p>
<p>Open <code>inspector_gadget.cc</code> and let's start by adding  the following include statements:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;bootcamp/inspector-gadget/inspector_gadget.hh&quot;</span></span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;debug/InspectorGadget.hh&quot;</span></span>
</code></pre>
<p>As we start defining functions, we will likely find the need to declare and define more functions. To keep things organized, let's just note them down as we go. We will then go back to declaring and defining them.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="37" data-paginate="true" data-class="no-logo code-60-percent" data-theme="gem5" lang="en-US" class="no-logo code-60-percent" data-marpit-pagination="37" style="--paginate:true;--class:no-logo code-60-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="defining-inspectorgadgetgetport">Defining InspectorGadget::getPort</h2>
<p>Let's start by implementing <code>InspectorGadget::getPort</code>. Add the following code inside <code>namespace gem5</code> in <code>inspector_gadget.cc</code> to do this  (all code in such definition files should go inside <code>namespace gem5</code>):</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function">Port&amp;
<span class="hljs-title">InspectorGadget::getPort</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string &amp;if_name, PortID idx)</span>
</span>{
    <span class="hljs-keyword">if</span> (if_name == <span class="hljs-string">&quot;cpu_side_port&quot;</span>) {
        <span class="hljs-keyword">return</span> cpuSidePort;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (if_name == <span class="hljs-string">&quot;mem_side_port&quot;</span>) {
        <span class="hljs-keyword">return</span> memSidePort;
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> ClockedObject::<span class="hljs-built_in">getPort</span>(if_name, idx);
    }
}
</code></pre>
<p>If you remember, <code>getPort</code> needs to create a mapping between <code>Port</code> objects in Python and <code>Port</code> objects in C++. In this function when <code>if_name == &quot;cpu_side_port&quot;</code> we will return <code>cpuSidePort</code> (the name comes from the Python declaration, look at <code>InspectorGadget.py</code>) . We do the same thing to map <code>&quot;mem_side_port&quot;</code> to our instance <code>memSidePort</code>. For now, you don't have to worry about <code>idx</code>. We will talk about it later in the context of <code>VectorPorts</code>  ports that can connect to multiple peers.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="38" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="38" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="defining-functions-from-cpusideport">Defining Functions from CPUSidePort</h2>
<p>Now, that we have implemented <code>InspectorGadget::getPort</code>, we can start declaring and defining the functions that simulate the <code>request</code> path (from <code>cpu_side_port</code> to <code>mem_side_port</code>) in <code>InspectorGadget</code>. Here are all the functions that we need to define from <code>CPUSidePort</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-keyword">virtual</span> AddrRangeList <span class="hljs-title">getAddrRanges</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span></span>;

<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">bool</span> <span class="hljs-title">recvTimingReq</span><span class="hljs-params">(PacketPtr pkt)</span> <span class="hljs-keyword">override</span></span>;
<span class="hljs-function"><span class="hljs-keyword">virtual</span> Tick <span class="hljs-title">recvAtomic</span><span class="hljs-params">(PacketPtr pkt)</span> <span class="hljs-keyword">override</span></span>;
<span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">recvFunctional</span><span class="hljs-params">(PacketPtr pkt)</span> <span class="hljs-keyword">override</span></span>;
</code></pre>
<p>As we start defining these functions you will see that <code>Ports</code> are interfaces that facilitate communication between <code>SimObjects</code>. Most of these functions rely on <code>InspectorGadget</code> to provide the bulk of the functionality.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="39" data-paginate="true" data-class="no-logo code-50-percent" data-theme="gem5" lang="en-US" class="no-logo code-50-percent" data-marpit-pagination="39" style="--paginate:true;--class:no-logo code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="cpusideportrecvatomic-cpusideportrecvfunctional">CPUSidePort::recvAtomic, CPUSidePort::recvFunctional</h2>
<p>These two functions are very simple to define. Basically, our responsibility is to pass the <code>PacketPtr</code> to <code>SimObjects</code> further down in the memory hierarchy. To implement them we will call functions with the same name from <code>InspectorGadget</code>. Add the following code to <code>inspector_gadget.cc</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">Tick
InspectorGadget::CPUSidePort::<span class="hljs-built_in">recvAtomic</span>(PacketPtr pkt)
{
    <span class="hljs-built_in">DPRINTF</span>(InspectorGadget, <span class="hljs-string">&quot;%s: Received pkt: %s in atomic mode.\n&quot;</span>, __func__, pkt-&gt;<span class="hljs-built_in">print</span>());
    <span class="hljs-keyword">return</span> owner-&gt;<span class="hljs-built_in">recvAtomic</span>(pkt);
}

<span class="hljs-type">void</span>
InspectorGadget::CPUSidePort::<span class="hljs-built_in">recvFunctional</span>(PacketPtr pkt)
{
    <span class="hljs-built_in">DPRINTF</span>(InspectorGadget, <span class="hljs-string">&quot;%s: Received pkt: %s in functional mode.\n&quot;</span>, __func__, pkt-&gt;<span class="hljs-built_in">print</span>());
    owner-&gt;<span class="hljs-built_in">recvFunctional</span>(pkt);
}
</code></pre>
<p>We will also need to eventually declare the functions that we call from the owner, which is an <code>InspectorGadget</code>. Keep these in mind:</p>
<blockquote>
<p><strong>Declarations:</strong><br />
<code>Tick InspectorGadget::recvAtomic(PacketPtr);</code><br />
<code>void InspectorGadget::recvFunctional(PakcetPtr);</code></p>
</blockquote>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="40" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="40" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="cpusideportgetaddrranges">CPUSidePort::getAddrRanges</h2>
<p>Reminder: This function returns an <code>AddrRangeList</code> that represents the address ranges for which the port is a responder. To understand this better, think about dual channel memory. Each channel in the memory is responsible for a subset of all the addresses in your computer.</p>
<p>To define this function, we are again going to rely on <code>InspectorGadget</code> and call a function with the same name from <code>InspectorGadget</code>. Do this by adding the following code to <code>inspector_gadget.cc</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">AddrRangeList
InspectorGadget::CPUSidePort::<span class="hljs-built_in">getAddrRanges</span>() <span class="hljs-type">const</span>
{
    <span class="hljs-keyword">return</span> owner-&gt;<span class="hljs-built_in">getAddrRanges</span>();
}
</code></pre>
<blockquote>
<p><strong>Declarations:</strong><br />
<code>AddrRangeList InspectorGadget::getAddrRanges() const;</code></p>
</blockquote>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="41" data-paginate="true" data-class="no-logo code-50-percent" data-theme="gem5" lang="en-US" class="no-logo code-50-percent" data-marpit-pagination="41" style="--paginate:true;--class:no-logo code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="cpusideportrecvtimingreq">CPUSidePort::recvTimingReq</h2>
<p>In this function we will do the following:</p>
<p>Ask the owner to receive the <code>Packet</code> the <code>Port</code> is receiving. To do this we will call a function with the same name from <code>InspectorGadget</code>. If <code>InspectorGadget</code> can accept the <code>Packet</code> then the <code>Port</code> will return true. Otherwise, the <code>Port</code> will return false as well as remember that we need to send a <code>retry request</code> in the future, i.e. we will set <code>needToSendRetry = true</code>.</p>
<p>To define this function add the following code to <code>inspector_gadget.cc</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-type">bool</span>
InspectorGadget::CPUSidePort::<span class="hljs-built_in">recvTimingReq</span>(PacketPtr pkt)
{
    <span class="hljs-built_in">DPRINTF</span>(InspectorGadget, <span class="hljs-string">&quot;%s: Received pkt: %s in timing mode.\n&quot;</span>, __func__, pkt-&gt;<span class="hljs-built_in">print</span>());
    <span class="hljs-keyword">if</span> (owner-&gt;<span class="hljs-built_in">recvTimingReq</span>(pkt)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
    needToSendRetry = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<blockquote>
<p><strong>Declarations:</strong><br />
<code>bool InspectorGadget::recvTimingReq(PacketPtr);</code></p>
</blockquote>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="42" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="42" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="back-to-declaration">Back to Declaration</h2>
<p>Now that we are finished with defining functions from <code>CPUSidePort</code>, let's go ahead and declare the functions from <code>InspectorGadget</code> that we noted down.</p>
<p>To do this add the following code to the <code>public</code> scope of <code>InspectorGadget</code> in <code>inspector_gadget.hh</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">public</span>:
    <span class="hljs-function">AddrRangeList <span class="hljs-title">getAddrRanges</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">recvTimingReq</span><span class="hljs-params">(PacketPtr pkt)</span></span>;
    <span class="hljs-function">Tick <span class="hljs-title">recvAtomic</span><span class="hljs-params">(PacketPtr pkt)</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">recvFunctional</span><span class="hljs-params">(PacketPtr pkt)</span></span>;
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="43" data-paginate="true" data-class="no-logo" data-theme="gem5" lang="en-US" class="no-logo" data-marpit-pagination="43" style="--paginate:true;--class:no-logo;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="timedqueue">TimedQueue</h2>
<p>As we mentioned, in this first step, all <code>InspectorGadget</code> does is buffer the traffic, forwarding <code>requests</code> and <code>responses</code>. To do that, let's create a &quot;first in first out&quot; (FIFO) structure for <code>inspectionBuffer</code> and <code>responseBuffer</code>. The purpose of this structure is impose a minimum latency between the times when items are pushed to the queue and when they can be accessed. We will add a member variable called <code>latency</code> to make this delay configurable. We will wrap <code>std::queue</code> to expose the following functionalities.</p>
<p>1: Method <code>front</code> that will return a reference to the oldest item in the queue, similar to <code>std::queue</code>.<br />
2: Method <code>pop</code> that will remove the oldest item in the queue, similar to <code>std::queue</code>.<br />
3: Method <code>push</code> that will add a new item to the queue as well as tracking the simulation time the item was inserted. This is useful for ensuring a minimum amount of time has passed before making it ready to be accessed, modeling the latency.<br />
4: Method <code>empty</code> that will return true if queue is empty, similar to <code>std::queue</code>.<br />
5: Method <code>size</code> that will return the number of items in the queue, similar to <code>std::queue</code>.<br />
6: Method <code>hasReady</code> will return true if an item in the queue can be accessed at a given time (i.e. has spent a minimum latency in the queue).<br />
7: Method <code>firstReadyTime</code> will return the time at which the oldest item becomes accessible.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="44" data-paginate="true" data-class="two-col code-50-percent" data-theme="gem5" lang="en-US" class="two-col code-50-percent" data-marpit-pagination="44" style="--paginate:true;--class:two-col code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h3 id="timed-queue-details">Timed Queue: Details</h3>
<p>Like <code>CPUSidePort</code> and <code>MemSidePort</code>, let's declare our class <code>TimedQueue</code> in the <code>private</code> scope of <code>InspectorGadget</code>. Do this by adding the lines on the right side of this slide to <code>inspector_gadget.hh</code>.</p>
<p>Make sure to add the following include statement to the top of the file as well.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;queue&gt;</span></span>
</code></pre>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
    <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimedQueue</span>
    {
      <span class="hljs-keyword">private</span>:
        Tick latency;

        std::queue&lt;T&gt; items;
        std::queue&lt;Tick&gt; insertionTimes;

      <span class="hljs-keyword">public</span>:
        <span class="hljs-built_in">TimedQueue</span>(Tick latency): <span class="hljs-built_in">latency</span>(latency) {}

        <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">push</span><span class="hljs-params">(T item, Tick insertion_time)</span> </span>{
            items.<span class="hljs-built_in">push</span>(item);
            insertionTimes.<span class="hljs-built_in">push</span>(insertion_time);
        }
        <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">pop</span><span class="hljs-params">()</span> </span>{
            items.<span class="hljs-built_in">pop</span>();
            insertionTimes.<span class="hljs-built_in">pop</span>();
        }

        <span class="hljs-function">T&amp; <span class="hljs-title">front</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> items.<span class="hljs-built_in">front</span>(); }
        <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">empty</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> items.<span class="hljs-built_in">empty</span>(); }
        <span class="hljs-function"><span class="hljs-type">size_t</span> <span class="hljs-title">size</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> items.<span class="hljs-built_in">size</span>(); }
        <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">hasReady</span><span class="hljs-params">(Tick current_time)</span> <span class="hljs-type">const</span> </span>{
            <span class="hljs-keyword">if</span> (<span class="hljs-built_in">empty</span>()) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
            <span class="hljs-keyword">return</span> (current_time - insertionTimes.<span class="hljs-built_in">front</span>()) &gt;= latency;
        }
        <span class="hljs-function">Tick <span class="hljs-title">firstReadyTime</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> insertionTimes.<span class="hljs-built_in">front</span>() + latency; }
    };
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="45" data-paginate="true" data-class="code-60-percent" data-theme="gem5" lang="en-US" class="code-60-percent" data-marpit-pagination="45" style="--paginate:true;--class:code-60-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectionbuffer">inspectionBuffer</h2>
<p>Now, let's declare an instance of <code>TimedQueue</code> to buffer <code>PacketPtrs</code> that <code>InspectorGadget</code> receives from <code>InspectorGadget::cpuSidePort::recvTimingReq</code>. Add the following lines to the <code>private</code> scope of class <code>InspectorGadget</code> to do this:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    TimedQueue&lt;PacketPtr&gt; inspectionBuffer;
</code></pre>
<p>Now that we have declared <code>inspectionBuffer</code>, we are ready to define the following functions (these are already declared):</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function">AddrRangeList <span class="hljs-title">getAddrRanges</span><span class="hljs-params">()</span> <span class="hljs-type">const</span></span>;
<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">recvTimingReq</span><span class="hljs-params">(PacketPtr pkt)</span></span>;
<span class="hljs-function">Tick <span class="hljs-title">recvAtomic</span><span class="hljs-params">(PacketPtr pkt)</span></span>;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">recvFunctional</span><span class="hljs-params">(PacketPtr pkt)</span></span>;
</code></pre>
<blockquote>
<p><strong>NOTE</strong>: For now we are focusing on the <code>request</code> path, i.e. we're not going to define <code>recvRespRetry</code> just yet.</p>
</blockquote>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="46" data-paginate="true" data-class="code-60-percent" data-theme="gem5" lang="en-US" class="code-60-percent" data-marpit-pagination="46" style="--paginate:true;--class:code-60-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="lets-get-the-easy-ones-out-the-way">Let's Get the Easy Ones Out the Way</h2>
<p>Between the four functions, <code>getAddrRanges</code> and <code>recvFunctional</code> are the most straightforward to define. We just need to call the same functions from <code>memSidePort</code>. To define these two functions, add the following code under <code>namespace gem5</code> in <code>inspector_gadget.cc</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function">AddrRangeList
<span class="hljs-title">InspectorGadget::getAddrRanges</span><span class="hljs-params">()</span> <span class="hljs-type">const</span>
</span>{
    <span class="hljs-keyword">return</span> memSidePort.<span class="hljs-built_in">getAddrRanges</span>();
}

<span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::recvFunctional</span><span class="hljs-params">(PacketPtr pkt)</span>
</span>{
    memSidePort.<span class="hljs-built_in">sendFunctional</span>(pkt);
}
</code></pre>
<blockquote>
<p><strong>NOTE</strong>: These two functions are already defined by <code>RequestPort</code> and we don't need to redefine them. Notice how, for <code>Ports</code>, you only have to define functions that relate to receiving signals.</p>
</blockquote>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="47" data-paginate="true" data-class="no-log code-80-percent" data-theme="gem5" lang="en-US" class="no-log code-80-percent" data-marpit-pagination="47" style="--paginate:true;--class:no-log code-80-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadgetrecvatomic">InspectorGadget::recvAtomic</h2>
<p>Looking at <code>recvAtomic</code>, this function returns a value of type <code>Tick</code>. This value is supposed to represent the latency of the access if that access was done in singularity, i.e atomically/without being interleaved. <strong>CAUTION</strong>: This latency is not an accurate representation of the actual latency of the access in a real setup. In a real setup there are many accesses happening at the same time and most of the time accesses do not happen atomically.</p>
<p>Let's add <em>one</em> cycle to the latency of accesses from the lower level of memory hierarchy. To do this we are going to call <code>clockPeriod</code> from the parent class of <code>InspectorGadget</code>, which is <code>ClockedObject</code>. This function returns the period of the <code>clk_domain</code> in <code>Ticks</code>. Add the following code to define of <code>InspectorGadget::recvAtomic</code> in <code>inspector_gadget.cc</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function">Tick
<span class="hljs-title">InspectorGadget::recvAtomic</span><span class="hljs-params">(PacketPtr pkt)</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">clockPeriod</span>() + memSidePort.<span class="hljs-built_in">sendAtomic</span>(pkt);
}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="48" data-paginate="true" data-class="no-logo code-70-percent" data-theme="gem5" lang="en-US" class="no-logo code-70-percent" data-marpit-pagination="48" style="--paginate:true;--class:no-logo code-70-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="on-to-the-hard-part">On to the Hard Part</h2>
<p>As we discussed before, <code>timing</code> accesses are the accesses that advance simulator time and represent real setups.</p>
<p><code>InspectorGadget::recvTimingReq</code> will need to check if there is at least one available entry in the <code>inspectionBuffer</code>. If there are no entries left, it should return false; otherwise, it should place the <code>Packet</code> at the end of the buffer  i.e. <code>push</code> into <code>inspectionBuffer</code>  and return true.</p>
<p>To define <code>InspectorGadget::recvTimingReq</code>, add the following code to <code>inspector-gadget.cc</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">bool</span>
<span class="hljs-title">InspectorGadget::recvTimingReq</span><span class="hljs-params">(PacketPtr pkt)</span>
</span>{
    <span class="hljs-keyword">if</span> (inspectionBuffer.<span class="hljs-built_in">size</span>() &gt;= inspectionBufferEntries) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    inspectionBuffer.<span class="hljs-built_in">push</span>(pkt, <span class="hljs-built_in">curTick</span>());
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="49" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="49" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="were-not-done-yet">We're Not Done Yet!</h2>
<p>So far, we have managed to program the movement of <code>Packets</code> from <code>cpuSidePort</code> into <code>inspectionBuffer</code>. Now, we need to send the <code>Packets</code> that are inside <code>inspectionBuffer</code> to <code>memSidePort</code>.</p>
<p>One would ask, why not call <code>memSidePort.sendTimingReq</code> inside <code>InspectorGadget::recvTimingReq</code>? The answer is because we want to impose a latency on the movement of the <code>Packet</code> through <code>inspectionBuffer</code>. Think about how the real hardware would work. If the <code>Packet</code> is available on <code>cpuSidePort</code> on the rising edge of the clock, it would go inside <code>inspectionBuffer</code> by the falling edge of the clock, i.e. time will pass. Now, assuming that <code>Packet</code> is at the front of <code>inspectionBuffer</code>, it will be available on the rising edge of the next clock cycle. If you remember, we use <code>events</code> to make things happen in the future by defining callback functions.</p>
<p>Now, let's go ahead and declare an <code>EventFunctionWrapper</code> for picking the <code>Packet</code> at the front of <code>inspectionBuffer</code> and sending it through <code>memSidePort</code>.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="50" data-paginate="true" data-class="no-logo code-70-percent" data-theme="gem5" lang="en-US" class="no-logo code-70-percent" data-marpit-pagination="50" style="--paginate:true;--class:no-logo code-70-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="nextreqsendevent">nextReqSendEvent</h2>
<p>We're going to declare a function <code>EventFunctionWrapper nextReqSendEvent</code> to send <code>Packets</code> through <code>memSidePort</code>. Remember what we need to do?</p>
<p>Add the following include statement to <code>inspector_gadget.hh</code> to include the appropriate header file for the class <code>EventFunctionWrapper</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;sim/eventq.hh&quot;</span></span>
</code></pre>
<p>If you remember from <a href="./03-event-driven-sim.md">Event Driven Simulation</a>, we also need to declare a <code>std::function&lt;void&gt;()</code> to pass as the callback function for <code>nextReqSendEvent</code>. I would like to name these functions with <code>process</code> prefixing the name of the <code>event</code>. Let's go ahead and declare <code>nextReqSendEvent</code> as well as its callback function in the <code>private</code> scope of <code>InspectorGadget</code>. Do it by adding the following lines to <code>inspector_gadget.hh</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    EventFunctionWrapper nextReqSendEvent;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">processNextReqSendEvent</span><span class="hljs-params">()</span></span>;
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="51" data-paginate="true" data-class="no-logo" data-theme="gem5" lang="en-US" class="no-logo" data-marpit-pagination="51" style="--paginate:true;--class:no-logo;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="managing-the-schedule-of-nextreqsendevent">Managing the Schedule of nextReqSendEvent</h2>
<p>Now, that we have declared <code>nextReqSendEvent</code>, we can schedule <code>nextReqSendEvent</code> in <code>InspectorGadget::recvTimingReq</code>. We will see in a few slides why it is helpful to have a function that decides if and when <code>nextReqSendEvent</code> should be scheduled.</p>
<p>What I do when I write <code>SimObjects</code> is that, for every <code>event</code>, I create a function to schedule that event. I name these functions with <code>schedule</code> prefixing the name of the event. Let's go ahead and a declare <code>scheduleNextReqSendEvent</code> under the <code>private</code> scope in <code>InspectorGadget</code>.</p>
<p>Open <code>inspector_gadget.hh</code> and add the following lines:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">scheduleNextReqSendEvent</span><span class="hljs-params">(Tick when)</span></span>;
</code></pre>
<p>We'll see that one <code>event</code> might be scheduled in multiple locations in the code. At every location, we might have a different perspective on when an <code>event</code> should be scheduled. <code>Tick when</code> denotes the earliest we think that <code>event</code> should be scheduled from the perspective of the location.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="52" data-paginate="true" data-class="code-80-percent" data-theme="gem5" lang="en-US" class="code-80-percent" data-marpit-pagination="52" style="--paginate:true;--class:code-80-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="back-to-inspectorgadgetrecvtimingreq">Back to InspectorGadget::recvTimingReq</h2>
<p>Now, we can finally go ahead and add a function call to <code>scheduleNextReqSendEvent</code> in <code>InspectorGadget::recvTimingReq</code>. Since we are assuming it will take <strong>one</strong> <code>cycle</code> to insert an item to <code>inspectionBuffer</code>, we're going to pass <code>nextCycle()</code> as <code>when</code> argument.</p>
<p>This is how <code>InspectorGadget::recvTimingReq</code> should look after all the changes.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">bool</span>
<span class="hljs-title">InspectorGadget::recvTimingReq</span><span class="hljs-params">(PacketPtr pkt)</span>
</span>{
    <span class="hljs-keyword">if</span> (inspectionBuffer.<span class="hljs-built_in">size</span>() &gt;= inspectionBufferEntries) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    inspectionBuffer.<span class="hljs-built_in">push</span>(pkt, <span class="hljs-built_in">curTick</span>());
    <span class="hljs-built_in">scheduleNextReqSendEvent</span>(<span class="hljs-built_in">nextCycle</span>());
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="53" data-paginate="true" data-class="no-logo code-50-percent" data-theme="gem5" lang="en-US" class="no-logo code-50-percent" data-marpit-pagination="53" style="--paginate:true;--class:no-logo code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="memsideportsendpacket">MemSidePort::sendPacket</h2>
<p>As mentioned before, it's a good idea to create a function for sending <code>Packets</code> through <code>memSidePort</code>. To do this, let's go ahead and define <code>MemSidePort::sendPacket</code>. We define this function now since we're going to need it in <code>processNextReqSendEvent</code>.</p>
<p>To define <code>MemSidePort::sendPacket</code> add the following code to <code>inspector_gadget.cc</code></p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-type">void</span>
InspectorGadget::MemSidePort::<span class="hljs-built_in">sendPacket</span>(PacketPtr pkt)
{
    <span class="hljs-built_in">panic_if</span>(<span class="hljs-built_in">blocked</span>(), <span class="hljs-string">&quot;Should never try to send if blocked!&quot;</span>);

    <span class="hljs-built_in">DPRINTF</span>(InspectorGadget, <span class="hljs-string">&quot;%s: Sending pkt: %s.\n&quot;</span>, __func__, pkt-&gt;<span class="hljs-built_in">print</span>());
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">sendTimingReq</span>(pkt)) {
        <span class="hljs-built_in">DPRINTF</span>(InspectorGadget, <span class="hljs-string">&quot;%s: Failed to send pkt: %s.\n&quot;</span>, __func__, pkt-&gt;<span class="hljs-built_in">print</span>());
        blockedPacket = pkt;
    }
}
</code></pre>
<blockquote>
<p><strong>NOTE</strong>: We call <code>panic</code> if this function is called when we have a blocked <code>Packet</code>. This is because if there is already a <code>Packet</code> that is rejected, we expect consequent <code>Packets</code> be rejected until we receive a <code>retry request</code>. We make sure to follow this by not trying to send <code>Packets</code> when blocked prior.</p>
</blockquote>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="54" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="54" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadgetprocessnextreqsendevent-cont">InspectorGadget::processNextReqSendEvent cont.</h2>
<p>Now that we have defined <code>sendPacket</code>, we can use it in <code>processNextReqSendEvent</code>. Add the following definition to <code>inspector_gadget.cc</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::processNextReqSendEvent</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">panic_if</span>(memSidePort.<span class="hljs-built_in">blocked</span>(), <span class="hljs-string">&quot;Should never try to send if blocked!&quot;</span>);
    <span class="hljs-built_in">panic_if</span>(!inspectionBuffer.<span class="hljs-built_in">hasReady</span>(<span class="hljs-built_in">curTick</span>()), <span class="hljs-string">&quot;Should never try to send if no ready packets!&quot;</span>);

    PacketPtr pkt = inspectionBuffer.<span class="hljs-built_in">front</span>();
    memSidePort.<span class="hljs-built_in">sendPacket</span>(pkt);
    inspectionBuffer.<span class="hljs-built_in">pop</span>();

    <span class="hljs-built_in">scheduleNextReqSendEvent</span>(<span class="hljs-built_in">nextCycle</span>());
}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="55" data-paginate="true" data-class="no-logo" data-theme="gem5" lang="en-US" class="no-logo" data-marpit-pagination="55" style="--paginate:true;--class:no-logo;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadgetprocessnextreqsendevent-deeper-look">InspectorGadget::processNextReqSendEvent: Deeper Look</h2>
<p>Here are a few things to note about <code>processNextReqSendEvent</code>:</p>
<p>1: We should not try to send a <code>Packet</code> if <code>memSidePort.blocked()</code> is true. We made this design decision and checked for it in <code>MemSidePort::sendPacket</code> to prevent <code>Packets</code> from being lost or accidentally changing the order of <code>Packets</code>.<br />
2: We should not try to send a <code>Packet</code> when there is no <code>Packet</code> ready at <code>curTick()</code>.<br />
3: When we are done, we need to try to schedule <code>nextReqSendEvent</code> in its callback event.</p>
<blockquote>
<p>Let's take a step back...</p>
</blockquote>
<p>Are we done with <code>cpuSidePort</code> yet? If we look at <code>InspectorGadget::recvTimingReq</code>, we return false when there is not enough space in <code>inspectionBuffer</code>. Also, if you remember, if the <code>reponsder</code> (in our case <code>InspectorGadget</code>) rejects a <code>request</code> because it's busy (in our case because we don't have enough space in <code>inspectionBuffer</code>), the <code>responder</code> has to send a <code>request retry</code> when it becomes available (in our case, when there is room freed in <code>inspectionBuffer</code>). So let's go ahead and send a <code>request retry</code> to the <code>peer</code> of <code>cpuSidePort</code>. We need to send that retry <strong>one cycle later</strong>. So, we need another event for that. Let's go ahead and add it.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="56" data-paginate="true" data-class="no-logo code-50-percent" data-theme="gem5" lang="en-US" class="no-logo code-50-percent" data-marpit-pagination="56" style="--paginate:true;--class:no-logo code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="nextreqretryevent">nextReqRetryEvent</h2>
<p>Let's add a declaration for <code>nextReqRetryEvent</code> as well as its callback function and its scheduler function. To do it add the following lines to the <code>private</code> scope of <code>InspectorGadget</code> in <code>inspector_gadget.hh</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    EventFunctionWrapper nextReqRetryEvent;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">processNextReqRetryEvent</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">scheduleNextReqRetryEvent</span><span class="hljs-params">(Tick when)</span></span>;
</code></pre>
<p>Define the functions by adding the following code in <code>inspector_gadget.cc</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::processNextReqRetryEvent</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">panic_if</span>(!cpuSidePort.<span class="hljs-built_in">needRetry</span>(), <span class="hljs-string">&quot;Should never try to send retry if not needed!&quot;</span>);
    cpuSidePort.<span class="hljs-built_in">sendRetryReq</span>();
}

<span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::scheduleNextReqRetryEvent</span><span class="hljs-params">(Tick when)</span>
</span>{
    <span class="hljs-keyword">if</span> (cpuSidePort.<span class="hljs-built_in">needRetry</span>() &amp;&amp; !nextReqRetryEvent.<span class="hljs-built_in">scheduled</span>()) {
        <span class="hljs-built_in">schedule</span>(nextReqRetryEvent, <span class="hljs-built_in">align</span>(when));
    }
}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="57" data-paginate="true" data-class="code-60-percent" data-theme="gem5" lang="en-US" class="code-60-percent" data-marpit-pagination="57" style="--paginate:true;--class:code-60-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="back-to-processnextreqsendevent">Back to processNextReqSendEvent</h2>
<p>Now all that is left to do in <code>processNextReqSendEvent</code> is to try scheduling <code>nextReqRetry</code> for <code>nextCycle</code> after we have sent a <code>Packet</code>. Let's go ahead and add that our code. This is how <code>processNextReqSendEvent</code> should look like after these changes:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::processNextReqSendEvent</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">panic_if</span>(memSidePort.<span class="hljs-built_in">blocked</span>(), <span class="hljs-string">&quot;Should never try to send if blocked!&quot;</span>);
    <span class="hljs-built_in">panic_if</span>(!inspectionBuffer.<span class="hljs-built_in">hasReady</span>(<span class="hljs-built_in">curTick</span>()), <span class="hljs-string">&quot;Should never try to send if no ready packets!&quot;</span>);

    PacketPtr pkt = inspectionBuffer.<span class="hljs-built_in">front</span>();
    memSidePort.<span class="hljs-built_in">sendPacket</span>(pkt);
    inspectionBuffer.<span class="hljs-built_in">pop</span>();

    <span class="hljs-built_in">scheduleNextReqRetryEvent</span>(<span class="hljs-built_in">nextCycle</span>());
    <span class="hljs-built_in">scheduleNextReqSendEvent</span>(<span class="hljs-built_in">nextCycle</span>());
}
</code></pre>
<p>Next we will see the details of the scheduler function for <code>nextReqSendEvent</code>.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="58" data-paginate="true" data-class="no-logo code-50-percent" data-theme="gem5" lang="en-US" class="no-logo code-50-percent" data-marpit-pagination="58" style="--paginate:true;--class:no-logo code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="schedulenextreqsendevent">scheduleNextReqSendEvent</h2>
<p>To define <code>scheduleNextReqSendEvent</code>, add the following code to <code>inspector_gadget.cc</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::scheduleNextReqSendEvent</span><span class="hljs-params">(Tick when)</span>
</span>{
    <span class="hljs-type">bool</span> port_avail = !memSidePort.<span class="hljs-built_in">blocked</span>();
    <span class="hljs-type">bool</span> have_items = !inspectionBuffer.<span class="hljs-built_in">empty</span>();

    <span class="hljs-keyword">if</span> (port_avail &amp;&amp; have_items &amp;&amp; !nextReqSendEvent.<span class="hljs-built_in">scheduled</span>()) {
        Tick schedule_time = <span class="hljs-built_in">align</span>(inspectionBuffer.<span class="hljs-built_in">firstReadyTime</span>());
        <span class="hljs-built_in">schedule</span>(nextReqSendEvent, schedule_time);
    }
}
</code></pre>
<p>You might wonder why we need to calculate <code>schedule_time</code> ourselves. As we mentioned, <code>Tick when</code> is passed from the perspective of the caller for when it thinks <code>nextReqSendEvent</code> should be scheduled. However, we need to make sure that we schedule the event at the time that simulates latencies correctly.</p>
<p>Make sure to add the following include statement as well since we're using <code>std::max</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;algorithm&gt;</span></span>
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="59" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="59" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="memsideportrecvreqretry">MemSidePort::recvReqRetry</h2>
<p>We're almost done with defining the whole <code>request</code> path. The only thing that remains is to react to <code>request retries</code> we receive from the <code>peer</code> of <code>memSidePort</code>.</p>
<p>Since we tracked the last <code>Packet</code> that we have tried to send, we can simply try sending that packet again. Let's consider the following for this function:</p>
<p>1: We shouldn't receive a <code>request retry</code> if we're not blocked.<br />
2: For now, let's accept that there might be scenarios when a <code>request retry</code> will arrive but when we try to send <code>blockedPacket</code>, it will be rejected again. So let's account for that when writing <code>MemSidePort::recvReqRetry</code>.<br />
3: If sending <code>blockedPacket</code> succeeds, we can now try to schedule <code>nextReqSendEvent</code> for <code>nextCycle</code> (we have to ask <code>owner</code> to do this).</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="60" data-paginate="true" data-class="code-60-percent" data-theme="gem5" lang="en-US" class="code-60-percent" data-marpit-pagination="60" style="--paginate:true;--class:code-60-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="memsideportrecvreqretry-cont">MemSidePort::recvReqRetry cont.</h2>
<p>Add the following code to <code>inspector_gadget.cc</code> to define <code>MemSidePort::recvReqRetry</code></p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-type">void</span>
InspectorGadget::MemSidePort::<span class="hljs-built_in">recvReqRetry</span>()
{
    <span class="hljs-built_in">panic_if</span>(!<span class="hljs-built_in">blocked</span>(), <span class="hljs-string">&quot;Should never receive retry if not blocked!&quot;</span>);

    <span class="hljs-built_in">DPRINTF</span>(InspectorGadget, <span class="hljs-string">&quot;%s: Received retry signal.\n&quot;</span>, __func__);
    PacketPtr pkt = blockedPacket;
    blockedPacket = <span class="hljs-literal">nullptr</span>;
    <span class="hljs-built_in">sendPacket</span>(pkt);

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">blocked</span>()) {
        owner-&gt;<span class="hljs-built_in">recvReqRetry</span>();
    }
}
</code></pre>
<blockquote>
<p><strong>Declarations</strong>:<br />
<code>void InspectorGadget::recvReqRetry();</code></p>
</blockquote>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="61" data-paginate="true" data-class="no-logo code-80-percent" data-theme="gem5" lang="en-US" class="no-logo code-80-percent" data-marpit-pagination="61" style="--paginate:true;--class:no-logo code-80-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadgetrecvreqretry">InspectorGadget::recvReqRetry</h2>
<p>Let's go ahead and declare and define <code>recvReqRetry</code> in the <code>public</code> scope of <code>InspectorGadget</code>. Add the following lines to <code>inspector_gadget.hh</code> to declare <code>InpsectorGadget::recvReqRetry</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">recvReqRetry</span><span class="hljs-params">()</span></span>;
</code></pre>
<p>Now, let's define it. We simply need to try to schedule <code>nextReqSendEvent</code> for the <code>nextCycle</code>. Add the following code to <code>inspector_gadget.cc</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::recvReqRetry</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">scheduleNextReqSendEvent</span>(<span class="hljs-built_in">nextCycle</span>());
}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="62" data-paginate="true" data-class="no-logo code-70-percent" data-theme="gem5" lang="en-US" class="no-logo code-70-percent" data-marpit-pagination="62" style="--paginate:true;--class:no-logo code-70-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="lets-do-all-of-this-for-response-path">Let's Do All of This for Response Path</h2>
<p>So far, we have completed the functions required for the <code>request</code> path (from <code>cpuSidePort</code> to <code>memSidePort</code>). Now we have to do all of that for the <code>response</code> path. I'm not going to go over the details of that since they are going to look very similar to the functions for the <code>request</code> path.</p>
<p>However, here is a high level representation of both paths.</p>
<p><strong>Request Path</strong> (without retries)</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">CPUSidePort.recvTimingReq
    -&gt;InspectorGadget.recvTimingReq
    -&gt;InspectorGadget.processNextReqSendEvent
    -&gt;MemSidePort.sendPacket
</code></pre>
<p><strong>Response Path</strong> (without retries)</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">MemSidePort.recvTimingResp
    -&gt;InspectorGadget.recvTimingResp
    -&gt;InspectorGadget.processNextRespSendEvent
    -&gt;CPUSidePort.sendPacket
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="63" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="63" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="response-path-additions-to-header-file">Response Path Additions to Header File</h2>
<p>Let's declare the following in <code>inspector_gadget.hh</code> to implement the <code>response</code> path.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    TimedQueue&lt;PacketPtr&gt; responseBuffer;

    EventFunctionWrapper nextRespSendEvent;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">processNextRespSendEvent</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">scheduleNextRespSendEvent</span><span class="hljs-params">(Tick when)</span></span>;

    EventFunctionWrapper nextRespRetryEvent;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">processNextRespRetryEvent</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">scheduleNextRespRetryEvent</span><span class="hljs-params">(Tick when)</span></span>;

  <span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">recvTimingResp</span><span class="hljs-params">(PacketPtr pkt)</span></span>;
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="64" data-paginate="true" data-class="code-80-percent" data-theme="gem5" lang="en-US" class="code-80-percent" data-marpit-pagination="64" style="--paginate:true;--class:code-80-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="defining-functions-for-the-response-path">Defining Functions for the Response Path</h2>
<p>Here is a comprehensive list of all the functions we need to declare and define for the <code>response</code> path. Let's not forget about <code>InspectorGadget::recvRespRetry</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">MemSidePort::recvTimingResp</span><span class="hljs-params">(PacketPtr pkt)</span></span>;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CPUSidePort::sendPacket</span><span class="hljs-params">(PacketPtr pkt)</span></span>;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CPUSidePort::recvRespRetry</span><span class="hljs-params">()</span></span>;
<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">InspectorGaget::recvTimingResp</span><span class="hljs-params">(PacketPtr pkt)</span></span>;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InspectorGaget::recvRespRetry</span><span class="hljs-params">()</span></span>;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InspectorGaget::processNextRespSendEvent</span><span class="hljs-params">()</span></span>;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InspectorGaget::scheduleNextRespSendEvent</span><span class="hljs-params">(Tick when)</span></span>;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InspectorGaget::processNextRespRetryEvent</span><span class="hljs-params">()</span></span>;
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">InspectorGaget::scheduleNextRespSendEvent</span><span class="hljs-params">(Tick when)</span></span>;
</code></pre>
<p>To find the definition for all these functions please look at the <a href="../../materials/03-Developing-gem5-models/04-ports/step-1/src/bootcamp/inspector-gadget/inspector_gadget.cc">complete version</a> of <code>inspector_gadget.cc</code>. You can search for <code>Too-Much-Code</code> to find these functions.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="65" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="65" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadgetinspectorgadget">InspectorGadget::InspectorGadget</h2>
<p>Now, what we have to do is define the constructor of <code>InspectorGadget</code>. To do it add the following code to <code>inspector_gadget.cc</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">InspectorGadget::<span class="hljs-built_in">InspectorGadget</span>(<span class="hljs-type">const</span> InspectorGadgetParams&amp; params):
    <span class="hljs-built_in">ClockedObject</span>(params),
    <span class="hljs-built_in">cpuSidePort</span>(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">name</span>() + <span class="hljs-string">&quot;.cpu_side_port&quot;</span>),
    <span class="hljs-built_in">memSidePort</span>(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">name</span>() + <span class="hljs-string">&quot;.mem_side_port&quot;</span>),
    <span class="hljs-built_in">inspectionBufferEntries</span>(params.inspection_buffer_entries),
    <span class="hljs-built_in">inspectionBuffer</span>(<span class="hljs-built_in">clockPeriod</span>()),
    <span class="hljs-built_in">responseBufferEntries</span>(params.response_buffer_entries),
    <span class="hljs-built_in">responseBuffer</span>(<span class="hljs-built_in">clockPeriod</span>()),
    <span class="hljs-built_in">nextReqSendEvent</span>([<span class="hljs-keyword">this</span>](){ <span class="hljs-built_in">processNextReqSendEvent</span>(); }, <span class="hljs-built_in">name</span>() + <span class="hljs-string">&quot;.nextReqSendEvent&quot;</span>),
    <span class="hljs-built_in">nextReqRetryEvent</span>([<span class="hljs-keyword">this</span>](){ <span class="hljs-built_in">processNextReqRetryEvent</span>(); }, <span class="hljs-built_in">name</span>() + <span class="hljs-string">&quot;.nextReqRetryEvent&quot;</span>),
    <span class="hljs-built_in">nextRespSendEvent</span>([<span class="hljs-keyword">this</span>](){ <span class="hljs-built_in">processNextRespSendEvent</span>(); }, <span class="hljs-built_in">name</span>() + <span class="hljs-string">&quot;.nextRespSendEvent&quot;</span>),
    <span class="hljs-built_in">nextRespRetryEvent</span>([<span class="hljs-keyword">this</span>](){ <span class="hljs-built_in">processNextRespRetryEvent</span>(); }, <span class="hljs-built_in">name</span>() + <span class="hljs-string">&quot;.nextRespRetryEvent&quot;</span>)
{}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="66" data-paginate="true" data-class="code-70-percent" data-theme="gem5" lang="en-US" class="code-70-percent" data-marpit-pagination="66" style="--paginate:true;--class:code-70-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="simobjectinit">SimObject::init</h2>
<p>Last step before compilation is to define the <code>init</code> function. Since <code>InspectorGadget</code> is a <code>Responder</code> object, the convention is to let <code>peer</code> ports know that they can ask for their address range when the ranges become known. <code>init</code> is a <code>virtual</code> and <code>public</code> function from <code>SimObject</code>. Let's go ahead and declare it to override it. To do this, add the following declaration to the <code>public</code> scope of <code>InspectorGadget</code> in <code>inspector-gadget.hh</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">init</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span></span>;
</code></pre>
<p>To define it, we need to simply call <code>sendRangeChange</code> from <code>cpuSidePort</code>. Add the following code to define <code>init</code> in <code>inspector-gadget.cc</code></p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::init</span><span class="hljs-params">()</span>
</span>{
    cpuSidePort.<span class="hljs-built_in">sendRangeChange</span>();
}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="67" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="67" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="lets-compile">Let's Compile</h2>
<p>We're ready to compile gem5. Let's do it and while we wait we will work on the configuration scripts. Run the following command in the base gem5 directory to rebuild gem5.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-sh"><span class="hljs-built_in">cd</span> /workspaces/2024/gem5
scons build/NULL/gem5.opt -j$(<span class="hljs-built_in">nproc</span>)
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="68" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="68" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="lets-create-a-configuration-script">Let's Create a Configuration Script</h2>
<p>For this step, we're going to borrow some of the material from <a href="../02-Using-gem5/03-running-in-gem5.md">Running Things in gem5</a>. We are specifically going to copy the materials for using <em>TrafficGenerators</em>. We are going to further expand that material by extending the <em>ChanneledMemory</em> class to put an <code>InspectorGadget</code> right before the memory controller.</p>
<p>Run the following commands in the base gem5 directory to create a directory for our configurations and copy the materials needed:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-sh"><span class="hljs-built_in">cp</span> -r ../materials/03-Developing-gem5-models/04-ports/step-1/configs/bootcamp configs/
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="69" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="69" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectedmemory">InspectedMemory</h2>
<p>We will need to do the following to extend <code>ChanneledMemory</code>:</p>
<p>1: In <code>InspectedMemory.__init__</code>, we should create an object of <code>InspectorGadget</code> for every memory channel. Let's store all of them in <code>self.inspectors</code>. We need to remember to expose <code>inspection_buffer_entries</code> and <code>response_buffer_entries</code> from <code>InspectorGadget</code> to the user. Make sure to also expose the input arguments of <code>ChanneledMemory.__init__</code>.<br />
2: Override <code>incorporate_memory</code> from <code>ChanneledMemory</code>. First call <code>ChanneledMemory.incorporate_memory</code> and then connect the <code>mem_side_port</code> from each <code>InspectorGadget</code> object to the <code>port</code> from one <code>MemCtrl</code> object.<br />
3: Override <code>get_mem_ports</code> from <code>ChanneledMemory</code> to replace <code>port</code> from <code>MemCtrl</code> objects with <code>cpu_side_port</code> from <code>InspectorGadget</code> objects.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="70" data-paginate="true" data-class="two-col no-logo code-50-percent" data-theme="gem5" lang="en-US" class="two-col no-logo code-50-percent" data-marpit-pagination="70" style="--paginate:true;--class:two-col no-logo code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h3 id="inspectedmemory-code">InspectedMemory: Code</h3>
<p>This is what should be in <code>gem5/configs/bootcamp/inspector-gadget/components/inspected_memory.py</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-python"><span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>, <span class="hljs-type">Sequence</span>, <span class="hljs-type">Tuple</span>, <span class="hljs-type">Union</span>, <span class="hljs-type">Type</span>

<span class="hljs-keyword">from</span> m5.objects <span class="hljs-keyword">import</span> (
    AddrRange,
    DRAMInterface,
    InspectorGadget,
    Port,
)

<span class="hljs-keyword">from</span> gem5.components.boards.abstract_board <span class="hljs-keyword">import</span> AbstractBoard
<span class="hljs-keyword">from</span> gem5.components.memory.memory <span class="hljs-keyword">import</span> ChanneledMemory
<span class="hljs-keyword">from</span> gem5.utils.override <span class="hljs-keyword">import</span> overrides

<span class="hljs-keyword">class</span> <span class="hljs-title class_">InspectedMemory</span>(<span class="hljs-title class_ inherited__">ChanneledMemory</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">
        self,
        dram_interface_class: <span class="hljs-type">Type</span>[DRAMInterface],
        num_channels: <span class="hljs-type">Union</span>[<span class="hljs-built_in">int</span>, <span class="hljs-built_in">str</span>],
        interleaving_size: <span class="hljs-type">Union</span>[<span class="hljs-built_in">int</span>, <span class="hljs-built_in">str</span>],
        size: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>,
        addr_mapping: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>,
        inspection_buffer_entries: <span class="hljs-built_in">int</span> = <span class="hljs-number">16</span>,
        response_buffer_entries: <span class="hljs-built_in">int</span> = <span class="hljs-number">32</span>,
    </span>) -&gt; <span class="hljs-literal">None</span>:
</code></pre>
<h3 id=""></h3>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-python">
        <span class="hljs-built_in">super</span>().__init__(
            dram_interface_class,
            num_channels,
            interleaving_size,
            size=size,
            addr_mapping=addr_mapping,
        )
        self.inspectors = [
            InspectorGadget(
                inspection_buffer_entries=inspection_buffer_entries,
                response_buffer_entries=response_buffer_entries,
            )
            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_channels)
        ]

<span class="hljs-meta">    @overrides(<span class="hljs-params">ChanneledMemory</span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">incorporate_memory</span>(<span class="hljs-params">self, board: AbstractBoard</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-built_in">super</span>().incorporate_memory(board)
        <span class="hljs-keyword">for</span> inspector, ctrl <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.inspectors, self.mem_ctrl):
            inspector.mem_side_port = ctrl.port

<span class="hljs-meta">    @overrides(<span class="hljs-params">ChanneledMemory</span>)</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_mem_ports</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-type">Sequence</span>[<span class="hljs-type">Tuple</span>[AddrRange, Port]]:
        <span class="hljs-keyword">return</span> [
            (ctrl.dram.<span class="hljs-built_in">range</span>, inspector.cpu_side_port)
            <span class="hljs-keyword">for</span> ctrl, inspector <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(self.mem_ctrl, self.inspectors)
        ]
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="71" data-paginate="true" data-class="code-60-percent no-logo" data-theme="gem5" lang="en-US" class="code-60-percent no-logo" data-marpit-pagination="71" style="--paginate:true;--class:code-60-percent no-logo;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="first-inspector-gadget-examplepy">first-inspector-gadget-example.py</h2>
<p>Now, let's just simply add the following imports to <code>gem5/configs/bootcamp/inspector-gadget/first-inspector-gadget-example.py</code>:</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-python"><span class="hljs-keyword">from</span> components.inspected_memory <span class="hljs-keyword">import</span> InspectedMemory
<span class="hljs-keyword">from</span> m5.objects.DRAMInterface <span class="hljs-keyword">import</span> DDR3_1600_8x8
</code></pre>
<p>Let's now create an object of <code>InspectedMemory</code> with the following parameters.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-python">memory = InspectedMemory(
    dram_interface_class=DDR3_1600_8x8,
    num_channels=<span class="hljs-number">2</span>,
    interleaving_size=<span class="hljs-number">128</span>,
    size=<span class="hljs-string">&quot;1GiB&quot;</span>,
)
</code></pre>
<p>Now, let's run the following command to simulate our configuration script.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-sh">./build/NULL/gem5.opt --debug-flags=InspectorGadget configs/bootcamp/inspector-gadget/first-inspector-gadget-example.py
</code></pre>
<p>In the next slide, there is a recording of my terminal when running the command above.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="72" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="72" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="output-first-inspector-gadget-examplepy">Output: first-inspector-gadget-example.py</h2>
<script src="https://asciinema.org/a/9j5QCBXn5098Oa63FpEmoYvLK.js" id="asciicast-9j5QCBXn5098Oa63FpEmoYvLK" async data-rows=32></script>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="73" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="73" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="statistics">Statistics</h2>
<p>In this step, we see how to add statistics to our <code>SimObjects</code> so that we can measure things with them. For now let's add statistics to measure the following.</p>
<p>1- The sum of the queueing latency in <code>inspectionBuffer</code> experienced by each <code>Packet</code>. Let's use the name <code>totalInspectionBufferLatency</code> for this statistic.<br />
2- Total number of <code>requests</code> forwarded. Let'use the name <code>numRequestsFwded</code>.<br />
3- The sum of the queueing latency in <code>responseBuffer</code> experienced by each <code>Packet</code>. Let's use the name <code>totalResponseBufferLatency</code> for this statistic.<br />
4- Total number of <code>requests</code> forwarded. Let'use the name <code>numResponsesFwded</code>.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="74" data-paginate="true" data-class="no-logo code-50-percent" data-theme="gem5" lang="en-US" class="no-logo code-50-percent" data-marpit-pagination="74" style="--paginate:true;--class:no-logo code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="statistics-header-file">Statistics:: Header File</h2>
<p>gem5 has its own internal classes for measuring statistics (stats for short). Let's go ahead and include the header files for them in <code>src/bootcamp/inspector-gadget.hh</code></p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;base/statistics.hh&quot;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;base/stats/group.hh&quot;</span></span>
</code></pre>
<p>gem5 stats have multiple types, each useful for measuring specific types of data. We will look at using <code>statistics::Scalar</code> stats since all the things we want to measure are scalars.</p>
<p>Let's go ahead a declare a new <code>struct</code> called <code>InspectorGadgetStats</code> inside the <code>private</code> scope of <code>InspectorGadget</code> and also declare an instance of it. It will inherit from <code>statistics::Group</code>. Add the following lines to <code>src/bootcamp/inspector-gadget.hh</code> to do this.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">InspectorGadgetStats</span>: <span class="hljs-keyword">public</span> statistics::Group
    {
        statistics::Scalar totalInspectionBufferLatency;
        statistics::Scalar numRequestsFwded;
        statistics::Scalar totalResponseBufferLatency;
        statistics::Scalar numResponsesFwded;
        <span class="hljs-built_in">InspectorGadgetStats</span>(InspectorGadget* inspector_gadget);
    };
    InspectorGadgetStats stats;
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="75" data-paginate="true" data-class="no-logo code-50-percent" data-theme="gem5" lang="en-US" class="no-logo code-50-percent" data-marpit-pagination="75" style="--paginate:true;--class:no-logo code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="statistics-source-file">Statistics: Source File</h2>
<p>Let's define the constructor of <code>InspectorGadgetStats</code>. Add the following code under <code>namespace gem5</code> to do this.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">
InspectorGadget::InspectorGadgetStats::<span class="hljs-built_in">InspectorGadgetStats</span>(InspectorGadget* inspector_gadget):
    statistics::<span class="hljs-built_in">Group</span>(inspector_gadget),
    <span class="hljs-built_in">ADD_STAT</span>(totalInspectionBufferLatency, statistics::units::Tick::<span class="hljs-built_in">get</span>(), <span class="hljs-string">&quot;Total inspection buffer latency.&quot;</span>),
    <span class="hljs-built_in">ADD_STAT</span>(numRequestsFwded, statistics::units::Count::<span class="hljs-built_in">get</span>(), <span class="hljs-string">&quot;Number of requests forwarded.&quot;</span>),
    <span class="hljs-built_in">ADD_STAT</span>(totalResponseBufferLatency, statistics::units::Tick::<span class="hljs-built_in">get</span>(), <span class="hljs-string">&quot;Total response buffer latency.&quot;</span>),
    <span class="hljs-built_in">ADD_STAT</span>(numResponsesFwded, statistics::units::Count::<span class="hljs-built_in">get</span>(), <span class="hljs-string">&quot;Number of responses forwarded.&quot;</span>)
{}
</code></pre>
<p>Few things to note:</p>
<p>1- Initialize our stat object by adding <code>stats(this)</code> to the initialization list in the constructor <code>InspectorGdaget</code>.<br />
2- <code>statistics::Group::Group</code> takes a pointer to an object of <code>statistics::Group</code> that will be its parent. Class <code>SimObject</code> inherits from <code>statistics::Group</code> so we can use a pointer to <code>InspectorGadget</code> as that input.<br />
3- The macro <code>ADD_STAT</code> registers and initializes our statistics that we have defined under the struct. The order of arguments are <code>name</code>, <code>unit</code>, <code>description</code>. To rid yourself of any headache, make sure the order of <code>ADD_STAT</code> macros match that of statistic declaration.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="76" data-paginate="true" data-class="no-logo code-70-percent" data-theme="gem5" lang="en-US" class="no-logo code-70-percent" data-marpit-pagination="76" style="--paginate:true;--class:no-logo code-70-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="counting-things">Counting Things</h2>
<p>Now let's go ahead and start counting things with stats. We can simply count <code>numRequestsFwded</code> and <code>numResponsesFwded</code> in <code>processNextReqSendEvent</code> and <code>processNextRespSendEvent</code> respectively.</p>
<p>To do it, simply add the following lines inside the body of those functions.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::processNextReqSendEvent</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// ...</span>
    stats.numRequestsFwded++;
    PacketPtr pkt = inspectionBuffer.<span class="hljs-built_in">front</span>();
}

<span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::processNextReqSendEvent</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// ...</span>
    stats.numResponsesFwded++;
    PacketPtr pkt = responseBuffer.<span class="hljs-built_in">front</span>();
}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="77" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="77" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="measuring-queueing-latencies">Measuring Queueing Latencies</h2>
<p>To measure the queueing latency in <code>inspectionBuffer</code> and <code>responseBuffer</code> we need to track the time each <code>Packet</code> is inserted in these buffers as well the time they are removed. We already track the insertion time for each <code>Packet</code>. We only need to make it accessible from the outside. We can use <code>curTick()</code> in <code>processNextReqSendEvent</code> and <code>processNextRespSendEvent</code> to track the time each <code>Packet</code> is removed from <code>inspectionBuffer</code> and <code>responseBuffer</code> respectively.</p>
<p>Let's go ahead an add the following function inside the <code>public</code> scope of <code>TimedQueue</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">public</span>:
    <span class="hljs-function">Tick <span class="hljs-title">frontTime</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> insertionTimes.<span class="hljs-built_in">front</span>(); }
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="78" data-paginate="true" data-class="code-70-percent" data-theme="gem5" lang="en-US" class="code-70-percent" data-marpit-pagination="78" style="--paginate:true;--class:code-70-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="measuring-queueing-latencies-cont">Measuring Queueing Latencies cont.</h2>
<p>This is how <code>processNextReqSendEvent</code>, <code>processNextRespSendEvent</code> would look for measuring all statistics.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::processNextReqSendEvent</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// ...</span>
    stats.numRequestsFwded++;
    stats.totalInspectionBufferLatency += <span class="hljs-built_in">curTick</span>() - inspectionBuffer.<span class="hljs-built_in">frontTime</span>();
    PacketPtr pkt = inspectionBuffer.<span class="hljs-built_in">front</span>();
}

<span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::processNextReqSendEvent</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// ...</span>
    stats.numResponsesFwded++;
    stats.totalResponseBufferLatency += <span class="hljs-built_in">curTick</span>() - responseBuffer.<span class="hljs-built_in">frontTime</span>();
    PacketPtr pkt = responseBuffer.<span class="hljs-built_in">front</span>();
}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="79" data-paginate="true" data-class="no-logo code-50-percent" data-theme="gem5" lang="en-US" class="no-logo code-50-percent" data-marpit-pagination="79" style="--paginate:true;--class:no-logo code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="lets-rebuild-and-simulate">Let's Rebuild and Simulate</h2>
<p>We're ready to compile gem5. Let's do it and while we wait we will work on the configuration scripts. Run the following command in the base gem5 directory to rebuild gem5.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-sh">scons build/NULL/gem5.opt -j$(<span class="hljs-built_in">nproc</span>)
</code></pre>
<p>Now, let's go ahead and run the simulation again. We don't need to make any changes to our configuration script. Run the following command in the base gem5 directory to run the simulation.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-sh">./build/NULL/gem5.opt configs/bootcamp/inspector-gadget/first-inspector-gadget-example.py
</code></pre>
<p>Now if you search for the name of the stats we added in <code>m5out/stats.txt</code>. This is what we will see. <strong>NOTE</strong>: I did by searching for the name of the <code>InspectorGadget</code> objects in the file using <code>grep inspectors m5out/stats.txt</code> in the base gem5 directory.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-sh">system.memory.inspectors0.totalInspectionBufferLatency         7334                       <span class="hljs-comment"># Total inspection buffer latency. (Tick)</span>
system.memory.inspectors0.numRequestsFwded           22                       <span class="hljs-comment"># Number of requests forwarded. (Count)</span>
system.memory.inspectors0.totalResponseBufferLatency         8608                       <span class="hljs-comment"># Total response buffer latency. (Tick)</span>
system.memory.inspectors0.numResponsesFwded           22                       <span class="hljs-comment"># Number of responses forwarded. (Count)</span>
system.memory.inspectors0.power_state.pwrStateResidencyTicks::UNDEFINED   1000000000                       <span class="hljs-comment"># Cumulative time (in ticks) in various power states (Tick)</span>
system.memory.inspectors1.totalInspectionBufferLatency         6003                       <span class="hljs-comment"># Total inspection buffer latency. (Tick)</span>
system.memory.inspectors1.numRequestsFwded           18                       <span class="hljs-comment"># Number of requests forwarded. (Count)</span>
system.memory.inspectors1.totalResponseBufferLatency         7746                       <span class="hljs-comment"># Total response buffer latency. (Tick)</span>
system.memory.inspectors1.numResponsesFwded           18                       <span class="hljs-comment"># Number of responses forwarded. (Count)</span>
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="80" data-paginate="true" data-class="start" data-theme="gem5" lang="en-US" class="start" data-marpit-pagination="80" style="--paginate:true;--class:start;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="end-of-step-1">End of Step 1</h2>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="81" data-paginate="true" data-class="start" data-theme="gem5" lang="en-US" class="start" data-marpit-pagination="81" style="--paginate:true;--class:start;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="step-2-inspecting-traffic">Step 2: Inspecting Traffic</h2>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="82" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="82" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="adding-inspection">Adding Inspection</h2>
<p>In this step, we're going to add an <em>inspection</em> step to the process of forwarding requests that we receive. You'll see that we will <strong>not</strong> create any class that models the inspection. For the purposes of this tutorial, the process of <em>inspection</em> is completely trivial; we just care about its latency. In this step, let's just assume that inspection takes <code>1 cycle</code> to inspect the <code>request</code>.</p>
<p>This is how the <code>request path</code> will look like after our changes in this step.</p>
<p><code>CPUSidePort.recvTimingReq-&gt;InspectorGadget.recvTimingReq-&gt;[inspection]-&gt;InspectorGadget.processNextReqSendEvent-&gt;MemSidePort.sendPacket</code></p>
<p>Again, we need to model latency. Therefore, we need to declare a new event that moves the time for the process of <em>inspection</em>. In addition, we will need to add a <code>TimedQueue</code> called the <code>outputBuffer</code> to hold the <code>Packets</code> that are <em>inspected</em> and are not sent yet. We also need to add a parameter to limit the number of entries in <code>outputBuffer</code>, let's call that <code>output_buffer_entries</code>.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="83" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="83" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="adding-inspection-header-file">Adding Inspection: Header File</h2>
<p>To declare <code>nextInspectionEvent</code>, add the following lines under the <code>private</code> scope of <code>InspectorGadget</code> in <code>src/bootcamp/inspector-gadget/inspcetor_gadget.hh</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    TimedQueue&lt;PacketPtr&gt; outputBuffer;

    EventFunctionWrapper nextInspectionEvent;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">processNextInspectionEvent</span><span class="hljs-params">()</span></span>;
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">scheduleNextInspectionEvent</span><span class="hljs-params">(Tick when)</span></span>;
</code></pre>
<p>Add the following line under the declaration of <code>InspectorGadget</code> in <code>src/bootcamp/inspector-gadget/InspectorGadget.py</code></p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-python">    output_buffer_entries = Param.Int(<span class="hljs-string">&quot;Number of entries in output buffer.&quot;</span>)
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="84" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="84" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="changing-the-request-path">Changing the Request Path</h2>
<p>Now, what we want to do is add <code>nextInspectionEvent</code> after receiving a <code>Packet</code> in <code>InspectorGadget::recvTimingReq</code> and before sending a <code>Packet</code> in <code>InspectorGadget::processNextReqSendEvent</code>.</p>
<p>We also need to be careful to change the <code>retry path</code> to account for this change.</p>
<p>We'll go through this process in detail in the next slides.</p>
<p>Let's get rid of the easy things first. Add the lines below to the initialization list in <code>InspectorGadget::InspectorGadget</code> in <code>src/bootcamp/inspector-gadget/inspector_gadget.cc</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">    <span class="hljs-built_in">outputBufferEntries</span>(params.output_buffer_entries),
    <span class="hljs-built_in">outputBuffer</span>(<span class="hljs-built_in">clockPeriod</span>()),
    <span class="hljs-built_in">nextInspectionEvent</span>([<span class="hljs-keyword">this</span>]() { <span class="hljs-built_in">processNextInspectionEvent</span>(); }, <span class="hljs-built_in">name</span>() + <span class="hljs-string">&quot;.nextInspectionEvent&quot;</span>)
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="85" data-paginate="true" data-class="two-col code-50-percent" data-theme="gem5" lang="en-US" class="two-col code-50-percent" data-marpit-pagination="85" style="--paginate:true;--class:two-col code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h3 id="changing-the-request-path-inspectorgadgetrecvtimingreq">Changing the Request Path: InspectorGadget::recvTimingReq</h3>
<p>The next thing we need to is schedule <code>nextInspectionEvent</code> in <code>InspectorGadget::recvTimingReq</code>. Currently, we schedule <code>nextReqSendEvent</code> in <code>InspectorGadget::recvTimingReq</code>. This is how the code in <code>src/bootcamp/inspector-gadget/inspector_gadget.cc</code> looks like right now (before our changes).</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">bool</span>
<span class="hljs-title">InspectorGadget::recvTimingReq</span><span class="hljs-params">(PacketPtr pkt)</span>
</span>{
    <span class="hljs-keyword">if</span> (inspectionBuffer.<span class="hljs-built_in">size</span>() &gt;= inspectionBufferEntries) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    inspectionBuffer.<span class="hljs-built_in">push</span>(pkt, <span class="hljs-built_in">curTick</span>());
    <span class="hljs-built_in">scheduleNextReqSendEvent</span>(<span class="hljs-built_in">nextCycle</span>());
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h3 id="-1"></h3>
<p>We will just simply replace <code>scheduleNextReqSendEvent(nextCycle());</code> with <code>scheduleNextInspectionEvent(nextCycle());</code> in this function. This is how the function should look like after the changes.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">bool</span>
<span class="hljs-title">InspectorGadget::recvTimingReq</span><span class="hljs-params">(PacketPtr pkt)</span>
</span>{
    <span class="hljs-keyword">if</span> (inspectionBuffer.<span class="hljs-built_in">size</span>() &gt;= inspectionBufferEntries) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
    inspectionBuffer.<span class="hljs-built_in">push</span>(pkt, <span class="hljs-built_in">curTick</span>());
    <span class="hljs-built_in">scheduleNextInspectionEvent</span>(<span class="hljs-built_in">nextCycle</span>());
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="86" data-paginate="true" data-class="no-logo code-60-percent" data-theme="gem5" lang="en-US" class="no-logo code-60-percent" data-marpit-pagination="86" style="--paginate:true;--class:no-logo code-60-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="changing-the-request-path-inspectorgadgetschedulenextinspectionevent">Changing the Request Path: InspectorGadget::scheduleNextInspectionEvent</h2>
<p>Let's take a step back. Each <em>inspection</em> takes a <code>request</code> from <code>inspectionBuffer</code>, <em>inspects</em> the <code>request</code> and puts it in <code>outputBuffer</code>. To determine whether <code>nextInspectionEvent</code> has to be scheduled we need to check <strong>a</strong>) if there is a <code>Packet</code> in <code>inspectionBuffer</code> and <strong>b</strong>) if there is at least one empty entry in <code>outputBuffer</code>. If both conditions are satisfied, we need to calculate the right time it should be scheduled for like we have been doing it already.</p>
<p>Add the following code to <code>src/bootcamp/inspector-gadget/inspector_gadget.cc</code> under <code>namespace gem5</code> to define <code>InspectorGadget::scheduleNextInspectionEvent</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::scheduleNextInspectionEvent</span><span class="hljs-params">(Tick when)</span>
</span>{
    <span class="hljs-type">bool</span> have_packet = !inspectionBuffer.<span class="hljs-built_in">empty</span>();
    <span class="hljs-type">bool</span> have_entry = outputBuffer.<span class="hljs-built_in">size</span>() &lt; outputBufferEntries;

    <span class="hljs-keyword">if</span> (have_packet &amp;&amp; have_entry &amp;&amp; !nextInspectionEvent.<span class="hljs-built_in">scheduled</span>()) {
        Tick schedule_time = <span class="hljs-built_in">align</span>(std::<span class="hljs-built_in">max</span>(when, inspectionBuffer.<span class="hljs-built_in">firstReadyTime</span>()));
        <span class="hljs-built_in">schedule</span>(nextInspectionEvent, schedule_time);
    }
}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="87" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="87" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="little-bit-about-senderstate">Little Bit About SenderState</h2>
<p>As I mentioned before, for the purposes of this tutorial functionality of <em>inspection</em> is trivial. Let's take advantage of this and learn about <code>Packet::SenderState</code>. We will use <code>SenderState</code> to attach a <em>sequence number</em> to <code>requests</code> that we inspect to count the number of displacements in the order <code>responses</code> arrive.</p>
<h3 id="packetsenderstate">Packet::SenderState</h3>
<p>Struct <code>Packet::SenderState</code> allows adding additional information to a <code>Packet</code> object. This is specifically useful when you want to design a <code>SimObject</code> that interacts with the memory (like we are doing right now).</p>
<p>We don't really have to concern ourselves with the details of <code>Packet::SenderState</code>. All we need is to extend this struct to store a <em>sequence number</em>.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="88" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="88" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="changing-the-request-path-sequencenumbertag">Changing the Request Path: SequenceNumberTag</h2>
<p>Now, let's declare a new class that inherits from <code>Packet::SenderState</code>. Let's do it under the <code>private</code> scope of <code>InspectorGadget</code> in <code>src/bootcamp/inspector-gadget/inspector_gadget.hh</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">SequenceNumberTag</span>: <span class="hljs-keyword">public</span> Packet::SenderState
    {
        <span class="hljs-type">uint64_t</span> sequenceNumber;
        <span class="hljs-built_in">SequenceNumberTag</span>(<span class="hljs-type">uint64_t</span> sequenceNumber):
            <span class="hljs-built_in">SenderState</span>(), (sequenceNumber)
        {}
    };
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="89" data-paginate="true" data-class="code-50-percent" data-theme="gem5" lang="en-US" class="code-50-percent" data-marpit-pagination="89" style="--paginate:true;--class:code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadgetinspectrequest-declaring-additional-members">InspectorGadget::inspectRequest: Declaring Additional Members</h2>
<p>Now, let's go ahead and declare and define a function that does the inspection for us. To count the number of displacements we need to keep track of the next <em>sequence number</em> we expect. We need to increment this variable every time we receive a response. In addition, we need to generate new <em>sequence numbers</em> as well. Therefore, we need to keep track of the next available <em>sequence number</em>. Lastly, we need to count the number of displacement in a variable. Let's add that to <code>InspectorGadgetStats</code>. Add the following lines under the <code>private</code> scope of <code>InspectorGadgetStats</code> in <code>src/bootcamp/inspector-gadget/inspector_gadget.hh</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    <span class="hljs-type">uint64_t</span> nextAvailableSeqNum;
    <span class="hljs-type">uint64_t</span> nextExpectedSeqNum;
</code></pre>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">InspectorGadgetStats</span>: <span class="hljs-keyword">public</span> statistics::Group
    {
        <span class="hljs-comment">// ...</span>
        statistics::Scalar numReqRespDisplacements;
        <span class="hljs-built_in">InspectorGadgetStats</span>(InspectorGadget* inspector_gadget);
    };
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="90" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="90" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadgetinspectrequest-initializing-additional-members">InspectorGadget::inspectRequest: Initializing Additional Members</h2>
<p>Now, let's go ahead and add the following lines to the initialization list in <code>InspectorGadget::InspectorGadget</code> in <code>src/bootcamp/inspector-gadget/inspector_gadget.cc</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">    <span class="hljs-built_in">nextAvailableSeqNum</span>(<span class="hljs-number">0</span>), <span class="hljs-built_in">nextExpectedSeqNum</span>(<span class="hljs-number">0</span>)
</code></pre>
<p>Add the following line to the initialization list in <code>InspectorGadget::InspectorGadget::InspectorGadgetStats</code> in <code>src/bootcamp/inspector-gadget/inspector_gadget.cc</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">    <span class="hljs-built_in">ADD_STAT</span>(numReqRespDisplacements, statistics::units::Count::<span class="hljs-built_in">get</span>(), <span class="hljs-string">&quot;Number of request-response displacements.&quot;</span>)
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="91" data-paginate="true" data-class="no-logo code-50-percent" data-theme="gem5" lang="en-US" class="no-logo code-50-percent" data-marpit-pagination="91" style="--paginate:true;--class:no-logo code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadgetinspectrequest">InspectorGadget::inspectRequest</h2>
<p>Now, let's go ahead an declare a function that <em>inspects</em> <code>requests</code> as they are popped from <code>inspectionBuffer</code>. To do this, add the following line under the <code>private</code> scope of <code>InspectorGadget</code> in <code>src/bootcamp/inspector-gadget/inspector-gadget.hh</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">inspectRequest</span><span class="hljs-params">(PacketPtr pkt)</span></span>;
</code></pre>
<p>Add the following code under <code>namespace gem5</code> in <code>src/bootcamp/inspector-gadget/inspector_gadget.cc</code> to define <code>inspectRequest</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::inspectRequest</span><span class="hljs-params">(PacketPtr pkt)</span>
</span>{
    <span class="hljs-built_in">panic_if</span>(!pkt-&gt;<span class="hljs-built_in">isRequest</span>(), <span class="hljs-string">&quot;Should only inspect requests!&quot;</span>);
    SequenceNumberTag* seq_num_tag = <span class="hljs-keyword">new</span> <span class="hljs-built_in">SequenceNumberTag</span>(nextAvailableSeqNum);
    pkt-&gt;<span class="hljs-built_in">pushSenderState</span>(seq_num_tag);
    nextAvailableSeqNum++;
}
</code></pre>
<p><strong>NOTE</strong>: In this function we call <code>pushSenderState</code> from <code>Packet</code> to attach our <code>SequenceNumberTag</code> to the <code>pkt</code>. We can use this tag on the <strong>response path</strong> to identify displacements.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="92" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="92" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadgetprocessnextinspectionevent">InspectorGadget::processNextInspectionEvent</h2>
<p>Now, we need to define the callback function for <code>nextInspectionEvent</code>.</p>
<p>To simulate inspection and its latency, we need to pop the first item in <code>inspectionBuffer</code>, <em>inspect</em> it and push it in the <code>outputBuffer</code> for it to be sent to the memory.  Then we can schedule <code>nextReqSendEvent</code>  for <code>nextCycle</code>.</p>
<p>Now, since <code>processNextInspectionEvent</code> is popping items off of <code>inspectionBuffer</code>, it now becomes responsible for sending <code>retry requests</code> from <code>cpuSidePort</code>. This means we need to schedule <code>nextReqRetryEvent</code> for <code>nextCycle</code> as well.</p>
<p>We also need to schedule <code>nextInspectionEvent</code> for <code>nextCycle</code>. We discussed why before. So far we have added <code>nextInspectionEvent</code> after <code>recvTimingReq</code>. In the next slides, we change <code>nextReqSendEvent</code> accordingly.</p>
<p>Lastly, we need to measure <code>totalInspectionBufferLatency</code> in this function now.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="93" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="93" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadgetprocessnextinspectionevent-cont">InspectorGadget::processNextInspectionEvent cont.</h2>
<p>Add the following code under <code>namespace gem5</code> in <code>src/bootcamp/inspector-gadget/inspector_gadget.cc</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::processNextInspectionEvent</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">panic_if</span>(!inspectionBuffer.<span class="hljs-built_in">hasReady</span>(<span class="hljs-built_in">curTick</span>()), <span class="hljs-string">&quot;Should never try to inspect if no ready packets!&quot;</span>);

    stats.totalInspectionBufferLatency += <span class="hljs-built_in">curTick</span>() - inspectionBuffer.<span class="hljs-built_in">frontTime</span>();
    PacketPtr pkt = inspectionBuffer.<span class="hljs-built_in">front</span>();
    <span class="hljs-built_in">inspectRequest</span>(pkt);
    outputBuffer.<span class="hljs-built_in">push</span>(pkt, <span class="hljs-built_in">curTick</span>());
    inspectionBuffer.<span class="hljs-built_in">pop</span>();

    <span class="hljs-built_in">scheduleNextReqSendEvent</span>(<span class="hljs-built_in">nextCycle</span>());
    <span class="hljs-built_in">scheduleNextReqRetryEvent</span>(<span class="hljs-built_in">nextCycle</span>());
    <span class="hljs-built_in">scheduleNextInspectionEvent</span>(<span class="hljs-built_in">nextCycle</span>());
}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="94" data-paginate="true" data-class="two-col code-50-percent" data-theme="gem5" lang="en-US" class="two-col code-50-percent" data-marpit-pagination="94" style="--paginate:true;--class:two-col code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadgetschedulenextreqsendevent">InspectorGadget::scheduleNextReqSendEvent</h2>
<p>Now that we have add <code>nextInspectionEvent</code> and <code>outputBuffer</code>, we need to change the way we schedule <code>nextReqSendEvent</code>.</p>
<p>What we are going to change is that <code>nextReqSendEvent</code> is going to pop items off of <code>outputBuffer</code> instead of <code>inspectionBuffer</code>.</p>
<p>This is how <code>scheduleNextReqSendEvent</code> in <code>src/bootcamp/inspector-gadget/inspector_gadget.cc</code> looks like before the changes.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::scheduleNextReqSendEvent</span><span class="hljs-params">(Tick when)</span>
</span>{
    <span class="hljs-type">bool</span> port_avail = !memSidePort.<span class="hljs-built_in">blocked</span>();
    <span class="hljs-type">bool</span> have_items = !inspectionBuffer.<span class="hljs-built_in">empty</span>();

    <span class="hljs-keyword">if</span> (port_avail &amp;&amp; have_items &amp;&amp; !nextReqSendEvent.<span class="hljs-built_in">scheduled</span>()) {
        Tick schedule_time = <span class="hljs-built_in">align</span>(std::<span class="hljs-built_in">max</span>(when, inspectionBuffer.<span class="hljs-built_in">firstReadyTime</span>()));
        <span class="hljs-built_in">schedule</span>(nextReqSendEvent, schedule_time);
    }
}
</code></pre>
<p>This is how it should look like after the changes.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::scheduleNextReqSendEvent</span><span class="hljs-params">(Tick when)</span>
</span>{
    <span class="hljs-type">bool</span> port_avail = !memSidePort.<span class="hljs-built_in">blocked</span>();
    <span class="hljs-type">bool</span> have_items = !outputBuffer.<span class="hljs-built_in">empty</span>();

    <span class="hljs-keyword">if</span> (port_avail &amp;&amp; have_items &amp;&amp; !nextReqSendEvent.<span class="hljs-built_in">scheduled</span>()) {
        Tick schedule_time = <span class="hljs-built_in">align</span>(std::<span class="hljs-built_in">max</span>(when, inspectionBuffer.<span class="hljs-built_in">firstReadyTime</span>()));
        <span class="hljs-built_in">schedule</span>(nextReqSendEvent, schedule_time);
    }
}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="95" data-paginate="true" data-class="two-col code-50-percent" data-theme="gem5" lang="en-US" class="two-col code-50-percent" data-marpit-pagination="95" style="--paginate:true;--class:two-col code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadgetprocessnextreqsendevent">InspectorGadget::processNextReqSendEvent</h2>
<p>Now, let's go ahead and change the definition of <code>processNextReqSendEvent</code>. We need to do the following.</p>
<p>1- Pop items off of <code>outputBuffer</code> instead of <code>inspectionBuffer</code>.<br />
2- Schedule <code>nextInspectionEvent</code> for <code>nextCycle</code>.<br />
3- Remove scheduling of <code>nextReqRetryEvent</code>.<br />
4- Remove measuring of <code>totalInspectionBufferLatency</code>.</p>
<p>This is how this function looks like right now.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::processNextReqSendEvent</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">panic_if</span>(memSidePort.<span class="hljs-built_in">blocked</span>(), <span class="hljs-string">&quot;Should never try to send if blocked!&quot;</span>);
    <span class="hljs-built_in">panic_if</span>(!inspectionBuffer.<span class="hljs-built_in">hasReady</span>(<span class="hljs-built_in">curTick</span>()), <span class="hljs-string">&quot;Should never try to send if no ready packets!&quot;</span>);

    stats.numRequestsFwded++;
    stats.totalInspectionBufferLatency += <span class="hljs-built_in">curTick</span>() - inspectionBuffer.<span class="hljs-built_in">frontTime</span>();

    PacketPtr pkt = inspectionBuffer.<span class="hljs-built_in">front</span>();
    memSidePort.<span class="hljs-built_in">sendPacket</span>(pkt);
    inspectionBuffer.<span class="hljs-built_in">pop</span>();

    <span class="hljs-built_in">scheduleNextReqRetryEvent</span>(<span class="hljs-built_in">nextCycle</span>());
    <span class="hljs-built_in">scheduleNextReqSendEvent</span>(<span class="hljs-built_in">nextCycle</span>());
}
</code></pre>
<p>This is how it should look like after the changes.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::processNextReqSendEvent</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">panic_if</span>(memSidePort.<span class="hljs-built_in">blocked</span>(), <span class="hljs-string">&quot;Should never try to send if blocked!&quot;</span>);
    <span class="hljs-built_in">panic_if</span>(!inspectionBuffer.<span class="hljs-built_in">hasReady</span>(<span class="hljs-built_in">curTick</span>()), <span class="hljs-string">&quot;Should never try to send if no ready packets!&quot;</span>);

    stats.numRequestsFwded++;
    PacketPtr pkt = outputBuffer.<span class="hljs-built_in">front</span>();
    memSidePort.<span class="hljs-built_in">sendPacket</span>(pkt);
    outputBuffer.<span class="hljs-built_in">pop</span>();

    <span class="hljs-built_in">scheduleNextInspectionEvent</span>(<span class="hljs-built_in">nextCycle</span>());
    <span class="hljs-built_in">scheduleNextReqSendEvent</span>(<span class="hljs-built_in">nextCycle</span>());
}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="96" data-paginate="true" data-class="two-col code-50-percent" data-theme="gem5" lang="en-US" class="two-col code-50-percent" data-marpit-pagination="96" style="--paginate:true;--class:two-col code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadgetinspectresponse">InspectorGadget::inspectResponse</h2>
<p>We're not going to change anything in the <strong>response path</strong>. However, we are going to add the process of counting displacement when we put <code>Packets</code> in the <code>responseBuffer</code>.</p>
<p>Let's declare <code>inspectResponse</code> under the <code>private</code> scope of <code>InspectorGadget</code> in <code>src/bootcamp/inspector-gadget/inspector_gadget.hh</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">inspectResponse</span><span class="hljs-params">(PacketPtr pkt)</span></span>;
</code></pre>
<p>All we need to do is to count the number of the times <code>pkt</code> has a different sequence number than what we expect to see. To define <code>inspectResponse</code>, add the following code under <code>namespace gem5</code> in <code>src/bootcamp/inspector-gadget/inspector_gadget.cc</code>.</p>
<p>We will use <code>Packet::findNextSenderState</code> to find the <code>SequenceNumberTag</code> object we attach to the request. After we're done, we should make sure to release the memory location for the object and remove it from <code>pkt</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::inspectResponse</span><span class="hljs-params">(PacketPtr pkt)</span>
</span>{
    <span class="hljs-built_in">panic_if</span>(!pkt-&gt;<span class="hljs-built_in">isResponse</span>(), <span class="hljs-string">&quot;Should only inspect responses!&quot;</span>);
    SequenceNumberTag* seq_num_tag = pkt-&gt;<span class="hljs-built_in">findNextSenderState</span>&lt;SequenceNumberTag&gt;();
    <span class="hljs-built_in">panic_if</span>(seq_num_tag == <span class="hljs-literal">nullptr</span>, <span class="hljs-string">&quot;There is not tag attached to pkt!&quot;</span>);
    <span class="hljs-keyword">if</span> (seq_num_tag-&gt;sequenceNumber != nextExpectedSeqNum) {
        stats.numReqRespDisplacements++;
    }
    <span class="hljs-keyword">delete</span> pkt-&gt;<span class="hljs-built_in">popSenderState</span>();
    nextExpectedSeqNum++;
}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="97" data-paginate="true" data-class="no-logo code-50-percent" data-theme="gem5" lang="en-US" class="no-logo code-50-percent" data-marpit-pagination="97" style="--paginate:true;--class:no-logo code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadgetprocessnextrespsendevent">InspectorGadget::processNextRespSendEvent</h2>
<p>Now, let's go ahead and call <code>inspectResponse</code> in the response path. Do it by adding a function call to <code>inspectResponse</code> in <code>processNextRespSendEvent</code>. This is how the function should look like after the changes.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::processNextRespSendEvent</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">panic_if</span>(cpuSidePort.<span class="hljs-built_in">blocked</span>(), <span class="hljs-string">&quot;Should never try to send if blocked!&quot;</span>);
    <span class="hljs-built_in">panic_if</span>(!responseBuffer.<span class="hljs-built_in">hasReady</span>(<span class="hljs-built_in">curTick</span>()), <span class="hljs-string">&quot;Should never try to send if no ready packets!&quot;</span>);

    stats.numResponsesFwded++;
    stats.totalResponseBufferLatency += <span class="hljs-built_in">curTick</span>() - responseBuffer.<span class="hljs-built_in">frontTime</span>();

    PacketPtr pkt = responseBuffer.<span class="hljs-built_in">front</span>();
    <span class="hljs-built_in">inspectResponse</span>(pkt);
    cpuSidePort.<span class="hljs-built_in">sendPacket</span>(pkt);
    responseBuffer.<span class="hljs-built_in">pop</span>();

    <span class="hljs-built_in">scheduleNextRespRetryEvent</span>(<span class="hljs-built_in">nextCycle</span>());
    <span class="hljs-built_in">scheduleNextRespSendEvent</span>(<span class="hljs-built_in">nextCycle</span>());
}
</code></pre>
<h3 id="lets-rebuild">Let's Rebuild</h3>
<p>We are now done with making all the required changes. Let's run the following command in the base gem5 directory to rebuild gem5.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-sh">scons build/NULL/gem5.opt -j$(<span class="hljs-built_in">nproc</span>)
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="98" data-paginate="true" data-class="two-col code-50-percent" data-theme="gem5" lang="en-US" class="two-col code-50-percent" data-marpit-pagination="98" style="--paginate:true;--class:two-col code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="lets-extend-inspectedmemory">Let's Extend InspectedMemory</h2>
<p>Now that we have added a new parameter to class <code>InspectorGadget</code>, let's go ahead and extend <code>InspectedMemory</code> to expose <code>output_buffer_entries</code> as an argument to its constructor (<code>__init__</code>).</p>
<p>Open <code>configs/bootcamp/inspector-gadget/components/inspected_memory.py</code> and make the appropriate changes. You only need to change <code>InspecteMemory.__init__</code>. This is how the function should look like after the changes.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">InspectedMemory</span>(<span class="hljs-title class_ inherited__">ChanneledMemory</span>):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">
        self,
        dram_interface_class: <span class="hljs-type">Type</span>[DRAMInterface],
        num_channels: <span class="hljs-type">Union</span>[<span class="hljs-built_in">int</span>, <span class="hljs-built_in">str</span>],
        interleaving_size: <span class="hljs-type">Union</span>[<span class="hljs-built_in">int</span>, <span class="hljs-built_in">str</span>],
        size: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>,
        addr_mapping: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>,
        inspection_buffer_entries: <span class="hljs-built_in">int</span> = <span class="hljs-number">8</span>,
        output_buffer_entries: <span class="hljs-built_in">int</span> = <span class="hljs-number">8</span>,
        response_buffer_entries: <span class="hljs-built_in">int</span> = <span class="hljs-number">32</span>,
    </span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-built_in">super</span>().__init__(
            dram_interface_class,
            num_channels,
            interleaving_size,
            size=size,
            addr_mapping=addr_mapping,
        )
        self.inspectors = [
            InspectorGadget(
                inspection_buffer_entries=inspection_buffer_entries,
                output_buffer_entries=output_buffer_entries,
                response_buffer_entries=response_buffer_entries,
            )
            <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(num_channels)
        ]
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="99" data-paginate="true" data-class="two-col code-50-percent" data-theme="gem5" lang="en-US" class="two-col code-50-percent" data-marpit-pagination="99" style="--paginate:true;--class:two-col code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="lets-simulate">Let's Simulate</h2>
<p>Now, let's remove <code>data_limit</code> when configuring <code>HybridGenerator</code> in <code>configs/inspector-gadget/first-inspector-gadget-example.py</code>. This is how I configured it in my code.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-python">generator = HybridGenerator(
    num_cores=<span class="hljs-number">6</span>,
    rate=<span class="hljs-string">&quot;1GB/s&quot;</span>,
    duration=<span class="hljs-string">&quot;1ms&quot;</span>,
)
</code></pre>
<p>After the compilation is over, run the following command in the base gem5 directory to simulate the new version of <code>InspectorGadget</code>. You should now see a stat for <code>numReqRespDisplacements</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-sh">./build/NULL/gem5.opt configs/bootcamp/inspector-gadget/first-inspector-gadget-example.py
</code></pre>
<p>Now, if you do <code>grep numReqRespDisplacements m5out/stats.txt</code> in the base gem5 directory, this is what you'll see.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-sh">system.memory.inspectors0.numReqRespDisplacements           14                       <span class="hljs-comment"># Number of request-response displacements. (Count)</span>
system.memory.inspectors1.numReqRespDisplacements            6                       <span class="hljs-comment"># Number of request-response displacements. (Count)</span>
</code></pre>
<p><strong>PRACTICE</strong>: Add as stat for <code>totalOutputBufferLatency</code>.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="100" data-paginate="true" data-class="start" data-theme="gem5" lang="en-US" class="start" data-marpit-pagination="100" style="--paginate:true;--class:start;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="end-of-step-2">End of Step 2</h2>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="101" data-paginate="true" data-class="start" data-theme="gem5" lang="en-US" class="start" data-marpit-pagination="101" style="--paginate:true;--class:start;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="step-3-more-inspection-throughput-more-latency">Step 3: More Inspection Throughput, More Latency</h2>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="102" data-paginate="true" data-class="no-logo code-70-percent" data-theme="gem5" lang="en-US" class="no-logo code-70-percent" data-marpit-pagination="102" style="--paginate:true;--class:no-logo code-70-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadget-new-parameters-modeling-bandwidth">InspectorGadget: New Parameters: Modeling Bandwidth</h2>
<p>In this step, let's go ahead and add three more parameters to <code>InspectorGadget</code>. Here is what they represent.</p>
<ul>
<li><code>insp_window</code>: Number of entries in front of <code>inspectionBuffer</code> to try to inspect every cycle.</li>
<li><code>num_insp_units</code>: Number of inspection units.</li>
<li><code>insp_tot_latency</code>: Latency to complete one inspection (latency of an inspection unit).</li>
</ul>
<p>Now, let's go ahead and add their declarations under class <code>InspectorGadget</code> in <code>src/bootcamp/inspector-gadget/InspectorGadget.py</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-python">    insp_window = Param.Int(
        <span class="hljs-string">&quot;Number of entries in front of inspectionBuffer &quot;</span>
        <span class="hljs-string">&quot;to try to inspect every cycle.&quot;</span>
    )
    num_insp_units = Param.Int(<span class="hljs-string">&quot;Number of inspection units.&quot;</span>)
    insp_tot_latency = Param.Cycles(
        <span class="hljs-string">&quot;Latency to complete one inspection (latency of an inspection unit).&quot;</span>
    )
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="103" data-paginate="true" data-class="two-col code-50-percent" data-theme="gem5" lang="en-US" class="two-col code-50-percent" data-marpit-pagination="103" style="--paginate:true;--class:two-col code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadget-new-parameters-header-file">InspectorGadget: New Parameters: Header File</h2>
<p>Now let's go ahead and declare counterparts for these parameters in C++. Add the following lines under the <code>private</code> scope of <code>InspectorGadget</code> in <code>src/bootcamp/inspector-gadget/inspector-gadget.hh</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> inspectionWindow;
    <span class="hljs-type">int</span> numInspectionUnits;
    Cycles totalInspectionLatency;
</code></pre>
<p>As we mentioned we do <strong>not</strong> create a class for inspection units. However, now that we are going to make it possible to have multiple inspection units that might take more than <code>1 cycle</code> to complete inspection, we need to keep track of the availability of each inspection unit. To do this we will create an array with <code>numInspectionUnits</code> elements of type <code>Tick</code> that stores when each inspection unit is available. Let's go ahead and declare that array. Add the following lines under the <code>private</code> scope of <code>InspectorGadget</code> to declare it.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">  <span class="hljs-keyword">private</span>:
    std::vector&lt;Tick&gt; inspectionUnitAvailableTimes;
</code></pre>
<p><strong>NOTE</strong>: Since we're using <code>std::vector</code>, let's go ahead and include its header file by adding the line below to <code>src/bootcamp/inspector-gadget/inspector-gadget.hh</code>.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="104" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="104" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="inspectorgadget-new-parameters-source-file">InspectorGadget: New Parameters: Source File</h2>
<p>Now, let's add the following lines to the initialization list in <code>InspectorGadget::InspectorGadget</code> in <code>src/bootcamp/inspector-gadget/inspector_gadget.cc</code> to initialize our params.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp">    <span class="hljs-built_in">inspectionWindow</span>(params.insp_window),
    <span class="hljs-built_in">numInspectionUnits</span>(params.num_insp_units),
    <span class="hljs-built_in">totalInspectionLatency</span>(params.insp_tot_latency),
    <span class="hljs-built_in">inspectionUnitAvailableTimes</span>((<span class="hljs-type">size_t</span>) params.num_insp_units, <span class="hljs-number">0</span>),
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="105" data-paginate="true" data-class="no-logo code-50-percent" data-theme="gem5" lang="en-US" class="no-logo code-50-percent" data-marpit-pagination="105" style="--paginate:true;--class:no-logo code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="changing-the-behavior-schedulenextinspectionevent">Changing the Behavior: scheduleNextInspectionEvent</h2>
<p>Now, we need to account for inspection units being available when scheduling <code>nextInspectionEvent</code>. To do this we will need to find the first available inspection unit. We should not schedule <code>nextInspectionEvent</code> earlier than that.</p>
<p>Let's go ahead and change <code>scheduleNextInspectionEvent</code> in <code>src/bootcamp/inspector-gadget/inspector_gadget.cc</code>. This is how the function should look like after the changes.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::scheduleNextInspectionEvent</span><span class="hljs-params">(Tick when)</span>
</span>{
    <span class="hljs-type">bool</span> have_packet = !inspectionBuffer.<span class="hljs-built_in">empty</span>();
    <span class="hljs-type">bool</span> have_entry = outputBuffer.<span class="hljs-built_in">size</span>() &lt; outputBufferEntries;

    <span class="hljs-keyword">if</span> (have_packet &amp;&amp; have_entry &amp;&amp; !nextInspectionEvent.<span class="hljs-built_in">scheduled</span>()) {
        Tick first_avail_insp_unit_time = \
            std::<span class="hljs-built_in">min_element</span>(
                            inspectionUnitAvailableTimes.<span class="hljs-built_in">begin</span>(),
                            inspectionUnitAvailableTimes.<span class="hljs-built_in">end</span>()
                            );
        Tick schedule_time = <span class="hljs-built_in">align</span>(std::<span class="hljs-built_in">max</span>({when,
                                            inspectionBuffer.<span class="hljs-built_in">firstReadyTime</span>(),
                                            first_avail_insp_unit_time
                                            }));
        <span class="hljs-built_in">schedule</span>(nextInspectionEvent, schedule_time);
    }
}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="106" data-paginate="true" data-class="two-col code-50-percent" data-theme="gem5" lang="en-US" class="two-col code-50-percent" data-marpit-pagination="106" style="--paginate:true;--class:two-col code-50-percent;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="changing-the-behavior-processnextinspectionevent">Changing the Behavior: processNextInspectionEvent</h2>
<p>Change <code>processNextInspectionEvent</code> in <code>src/bootcamp/inspector-gadget/inspector_gadget.cc</code> to look like this.</p>
<pre is="marp-pre" data-auto-scaling="downscale-only"><code class="language-cpp"><span class="hljs-function"><span class="hljs-type">void</span>
<span class="hljs-title">InspectorGadget::processNextInspectionEvent</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-built_in">panic_if</span>(!inspectionBuffer.<span class="hljs-built_in">hasReady</span>(<span class="hljs-built_in">curTick</span>()), <span class="hljs-string">&quot;Should never try to inspect if no ready packets!&quot;</span>);

    <span class="hljs-type">int</span> insp_window_left = inspectionWindow;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; numInspectionUnits; i++) {
        <span class="hljs-keyword">if</span> (inspectionUnitAvailableTimes[i] &gt; <span class="hljs-built_in">curTick</span>()) {
            <span class="hljs-built_in">DPRINTF</span>(InspectorGadget, <span class="hljs-string">&quot;%s: Inspection unit %d is busy.\n&quot;</span>, __func__,  i);
            <span class="hljs-keyword">continue</span>;
        }
        <span class="hljs-keyword">if</span> (inspectionBuffer.<span class="hljs-built_in">empty</span>()) {
            <span class="hljs-built_in">DPRINTF</span>(InspectorGadget, <span class="hljs-string">&quot;%s: Inspection buffer is empty.\n&quot;</span>, __func__);
            <span class="hljs-keyword">break</span>;
        }
        <span class="hljs-keyword">if</span> (outputBuffer.<span class="hljs-built_in">size</span>() &gt;= outputBufferEntries) {
            <span class="hljs-built_in">DPRINTF</span>(InspectorGadget, <span class="hljs-string">&quot;%s: Output buffer is full.\n&quot;</span>, __func__);
            <span class="hljs-keyword">break</span>;
        }
        stats.totalInspectionBufferLatency += <span class="hljs-built_in">curTick</span>() - inspectionBuffer.<span class="hljs-built_in">frontTime</span>();
        PacketPtr pkt = inspectionBuffer.<span class="hljs-built_in">front</span>();
        <span class="hljs-built_in">inspectRequest</span>(pkt);
        outputBuffer.<span class="hljs-built_in">push</span>(pkt, <span class="hljs-built_in">curTick</span>());
        inspectionBuffer.<span class="hljs-built_in">pop</span>();
        inspectionUnitAvailableTimes[i] = <span class="hljs-built_in">clockEdge</span>(totalInspectionLatency);
        insp_window_left--;
        <span class="hljs-keyword">if</span> (insp_window_left == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; numInspectionUnits; i++) {
        inspectionUnitAvailableTimes[i] = std::<span class="hljs-built_in">max</span>(inspectionUnitAvailableTimes[i], <span class="hljs-built_in">nextCycle</span>());
    }

    <span class="hljs-built_in">scheduleNextReqSendEvent</span>(<span class="hljs-built_in">nextCycle</span>());
    <span class="hljs-built_in">scheduleNextReqRetryEvent</span>(<span class="hljs-built_in">nextCycle</span>());
    <span class="hljs-built_in">scheduleNextInspectionEvent</span>(<span class="hljs-built_in">nextCycle</span>());
}
</code></pre>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="107" data-paginate="true" data-class="no-logo" data-theme="gem5" lang="en-US" class="no-logo" data-marpit-pagination="107" style="--paginate:true;--class:no-logo;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="changing-the-behavior-processnextinspectionevent-deeper-look">Changing the Behavior: processNextInspectionEvent: Deeper Look</h2>
<p>Let's take a deeper look at how we process <code>nextInspectionEvent</code>. It's important to note the following.</p>
<p>1- We want to impose a limit on the number of entries at the front we will look at each time we process <code>nextInspectionEvent</code>. So we keep a copy of <code>inspectionWindow</code> and decrement each time we inspect a <code>request</code>. We break out of the loop as soon as <code>insp_window_left == 0</code><br />
2- Iterations of the for-loop represent assignment of inspection to one inspection unit. Therefore, we need to check the following: <strong>a</strong>) if the inspection unit is available at <code>curTick</code>, <strong>b</strong>) if <code>inspectionBuffer</code> has items, and <strong>c</strong>) if there is an entry available in <code>outputBuffer</code>. We skip the inspection units that are busy and will break out of the loop when <strong>b</strong> or <strong>c</strong> do not hold.<br />
3- If every check has passed, we can now do the actual inspection and impose the latency. Now that we have a parameter for the latency of inspection, we will push <code>pkt</code> with a timestamp that is equivalent to <code>curTick + totalInspectionLatency</code> (this is what <code>clockEdge(totalInspectionLatency)</code> returns). We also need to make the inspection unit that we just assigned work to until the same time.<br />
4- After all the assignment of work is done, we need to make sure that the available time of all inspection units are bigger than or equal to <code>nextCycle</code>. Why?</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="108" data-paginate="true" data-theme="gem5" lang="en-US" data-marpit-pagination="108" style="--paginate:true;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="practice">Practice</h2>
<p>Compile your gem5 and make the appropriate changes to your configuration script to make simulation possible.</p>
</section>
</foreignObject></svg><svg data-marpit-svg="" viewBox="0 0 1280 720"><foreignObject width="1280" height="720"><section id="109" data-paginate="true" data-class="start" data-theme="gem5" lang="en-US" class="start" data-marpit-pagination="109" style="--paginate:true;--class:start;--theme:gem5;" data-marpit-pagination-total="109">
<h2 id="end-of-step-3">End of Step 3</h2>
</section>
<script>!function(){"use strict";const t={h1:{proto:()=>HTMLHeadingElement,attrs:{role:"heading","aria-level":"1"},style:"display: block; font-size: 2em; margin-block-start: 0.67em; margin-block-end: 0.67em; margin-inline-start: 0px; margin-inline-end: 0px; font-weight: bold;"},h2:{proto:()=>HTMLHeadingElement,attrs:{role:"heading","aria-level":"2"},style:"display: block; font-size: 1.5em; margin-block-start: 0.83em; margin-block-end: 0.83em; margin-inline-start: 0px; margin-inline-end: 0px; font-weight: bold;"},h3:{proto:()=>HTMLHeadingElement,attrs:{role:"heading","aria-level":"3"},style:"display: block; font-size: 1.17em; margin-block-start: 1em; margin-block-end: 1em; margin-inline-start: 0px; margin-inline-end: 0px; font-weight: bold;"},h4:{proto:()=>HTMLHeadingElement,attrs:{role:"heading","aria-level":"4"},style:"display: block; margin-block-start: 1.33em; margin-block-end: 1.33em; margin-inline-start: 0px; margin-inline-end: 0px; font-weight: bold;"},h5:{proto:()=>HTMLHeadingElement,attrs:{role:"heading","aria-level":"5"},style:"display: block; font-size: 0.83em; margin-block-start: 1.67em; margin-block-end: 1.67em; margin-inline-start: 0px; margin-inline-end: 0px; font-weight: bold;"},h6:{proto:()=>HTMLHeadingElement,attrs:{role:"heading","aria-level":"6"},style:"display: block; font-size: 0.67em; margin-block-start: 2.33em; margin-block-end: 2.33em; margin-inline-start: 0px; margin-inline-end: 0px; font-weight: bold;"},span:{proto:()=>HTMLSpanElement},pre:{proto:()=>HTMLElement,style:"display: block; font-family: monospace; white-space: pre; margin: 1em 0; --marp-auto-scaling-white-space: pre;"}},e="data-marp-auto-scaling-wrapper",i="data-marp-auto-scaling-svg",n="data-marp-auto-scaling-container";class s extends HTMLElement{constructor(){super(),this.svgPreserveAspectRatio="xMinYMid meet";const t=t=>([e])=>{const{width:i,height:n}=e.contentRect;this[t]={width:i,height:n},this.updateSVGRect()};this.attachShadow({mode:"open"}),this.containerObserver=new ResizeObserver(t("containerSize")),this.wrapperObserver=new ResizeObserver(((...e)=>{t("wrapperSize")(...e),this.flushSvgDisplay()}))}static get observedAttributes(){return["data-downscale-only"]}connectedCallback(){var t,s,o,r,a;this.shadowRoot.innerHTML=`\n<style>\n  svg[${i}] { display: block; width: 100%; height: auto; vertical-align: top; }\n  span[${n}] { display: table; white-space: var(--marp-auto-scaling-white-space, nowrap); width: max-content; }\n</style>\n<div ${e}>\n  <svg part="svg" ${i}>\n    <foreignObject><span ${n}><slot></slot></span></foreignObject>\n  </svg>\n</div>\n    `.split(/\n\s*/).join(""),this.wrapper=null!==(t=this.shadowRoot.querySelector(`div[${e}]`))&&void 0!==t?t:void 0;const l=this.svg;this.svg=null!==(o=null===(s=this.wrapper)||void 0===s?void 0:s.querySelector(`svg[${i}]`))&&void 0!==o?o:void 0,this.svg!==l&&(this.svgComputedStyle=this.svg?window.getComputedStyle(this.svg):void 0),this.container=null!==(a=null===(r=this.svg)||void 0===r?void 0:r.querySelector(`span[${n}]`))&&void 0!==a?a:void 0,this.observe()}disconnectedCallback(){this.svg=void 0,this.svgComputedStyle=void 0,this.wrapper=void 0,this.container=void 0,this.observe()}attributeChangedCallback(){this.observe()}flushSvgDisplay(){const{svg:t}=this;t&&(t.style.display="inline",requestAnimationFrame((()=>{t.style.display=""})))}observe(){this.containerObserver.disconnect(),this.wrapperObserver.disconnect(),this.wrapper&&this.wrapperObserver.observe(this.wrapper),this.container&&this.containerObserver.observe(this.container),this.svgComputedStyle&&this.observeSVGStyle(this.svgComputedStyle)}observeSVGStyle(t){const e=()=>{const i=(()=>{const e=t.getPropertyValue("--preserve-aspect-ratio");if(e)return e.trim();return`x${(({textAlign:t,direction:e})=>{if(t.endsWith("left"))return"Min";if(t.endsWith("right"))return"Max";if("start"===t||"end"===t){let i="rtl"===e;return"end"===t&&(i=!i),i?"Max":"Min"}return"Mid"})(t)}YMid meet`})();i!==this.svgPreserveAspectRatio&&(this.svgPreserveAspectRatio=i,this.updateSVGRect()),t===this.svgComputedStyle&&requestAnimationFrame(e)};e()}updateSVGRect(){var t,e,i,n,s,o,r;let a=Math.ceil(null!==(e=null===(t=this.containerSize)||void 0===t?void 0:t.width)&&void 0!==e?e:0);const l=Math.ceil(null!==(n=null===(i=this.containerSize)||void 0===i?void 0:i.height)&&void 0!==n?n:0);void 0!==this.dataset.downscaleOnly&&(a=Math.max(a,null!==(o=null===(s=this.wrapperSize)||void 0===s?void 0:s.width)&&void 0!==o?o:0));const c=null===(r=this.svg)||void 0===r?void 0:r.querySelector(":scope > foreignObject");if(null==c||c.setAttribute("width",`${a}`),null==c||c.setAttribute("height",`${l}`),this.svg&&(this.svg.setAttribute("viewBox",`0 0 ${a} ${l}`),this.svg.setAttribute("preserveAspectRatio",this.svgPreserveAspectRatio),this.svg.style.height=a<=0||l<=0?"0":""),this.container){const t=this.svgPreserveAspectRatio.toLowerCase();this.container.style.marginLeft=t.startsWith("xmid")||t.startsWith("xmax")?"auto":"0",this.container.style.marginRight=t.startsWith("xmi")?"auto":"0"}}}const o=(t,{attrs:e={},style:i})=>class extends t{constructor(...t){super(...t);for(const[t,i]of Object.entries(e))this.hasAttribute(t)||this.setAttribute(t,i);this.attachShadow({mode:"open"})}static get observedAttributes(){return["data-auto-scaling"]}connectedCallback(){this._update()}attributeChangedCallback(){this._update()}_update(){const t=i?`<style>:host { ${i} }</style>`:"";let e="<slot></slot>";const{autoScaling:n}=this.dataset;if(void 0!==n){e=`<marp-auto-scaling exportparts="svg:auto-scaling" ${"downscale-only"===n?"data-downscale-only":""}>${e}</marp-auto-scaling>`}this.shadowRoot.innerHTML=t+e}};let r;const a=Symbol();let l;const c="marpitSVGPolyfill:setZoomFactor,",d=Symbol(),g=Symbol();const h=()=>{const t="Apple Computer, Inc."===navigator.vendor,e=t?[u]:[],i={then:e=>(t?(async()=>{if(void 0===l){const t=document.createElement("canvas");t.width=10,t.height=10;const e=t.getContext("2d"),i=new Image(10,10),n=new Promise((t=>{i.addEventListener("load",(()=>t()))}));i.crossOrigin="anonymous",i.src="data:image/svg+xml;charset=utf8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2210%22%20height%3D%2210%22%20viewBox%3D%220%200%201%201%22%3E%3CforeignObject%20width%3D%221%22%20height%3D%221%22%20requiredExtensions%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxhtml%22%3E%3Cdiv%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F1999%2Fxhtml%22%20style%3D%22width%3A%201px%3B%20height%3A%201px%3B%20background%3A%20red%3B%20position%3A%20relative%22%3E%3C%2Fdiv%3E%3C%2FforeignObject%3E%3C%2Fsvg%3E",await n,e.drawImage(i,0,0),l=e.getImageData(5,5,1,1).data[3]<128}return l})().then((t=>{null==e||e(t?[u]:[])})):null==e||e([]),i)};return Object.assign(e,i)};let p,m;function u(t){const e="object"==typeof t&&t.target||document,i="object"==typeof t?t.zoom:t;window[g]||(Object.defineProperty(window,g,{configurable:!0,value:!0}),document.body.style.zoom=1.0001,document.body.offsetHeight,document.body.style.zoom=1,window.addEventListener("message",(({data:t,origin:e})=>{if(e===window.origin)try{if(t&&"string"==typeof t&&t.startsWith(c)){const[,e]=t.split(","),i=Number.parseFloat(e);Number.isNaN(i)||(m=i)}}catch(t){console.error(t)}})));let n=!1;Array.from(e.querySelectorAll("svg[data-marpit-svg]"),(t=>{var e,s,o,r;t.style.transform||(t.style.transform="translateZ(0)");const a=i||m||t.currentScale||1;p!==a&&(p=a,n=a);const l=t.getBoundingClientRect(),{length:c}=t.children;for(let i=0;i<c;i+=1){const n=t.children[i];if(n.getScreenCTM){const t=n.getScreenCTM();if(t){const i=null!==(s=null===(e=n.x)||void 0===e?void 0:e.baseVal.value)&&void 0!==s?s:0,c=null!==(r=null===(o=n.y)||void 0===o?void 0:o.baseVal.value)&&void 0!==r?r:0,d=n.children.length;for(let e=0;e<d;e+=1){const s=n.children[e];if("SECTION"===s.tagName){const{style:e}=s;e.transformOrigin||(e.transformOrigin=`${-i}px ${-c}px`),e.transform=`scale(${a}) matrix(${t.a}, ${t.b}, ${t.c}, ${t.d}, ${t.e-l.left}, ${t.f-l.top}) translateZ(0.0001px)`;break}}}}}})),!1!==n&&Array.from(e.querySelectorAll("iframe"),(({contentWindow:t})=>{null==t||t.postMessage(`${c}${n}`,"null"===window.origin?"*":window.origin)}))}function v({once:t=!1,target:e=document}={}){const i=function(t=document){if(t[d])return t[d];let e=!0;const i=()=>{e=!1,delete t[d]};Object.defineProperty(t,d,{configurable:!0,value:i});let n=[],s=!1;(async()=>{try{n=await h()}finally{s=!0}})();const o=()=>{for(const e of n)e({target:t});s&&0===n.length||e&&window.requestAnimationFrame(o)};return o(),i}(e);return t?(i(),()=>{}):i}p=1,m=void 0;const b=Symbol(),w=(e=document)=>{if("undefined"==typeof window)throw new Error("Marp Core's browser script is valid only in browser context.");if(((e=document)=>{const i=window[a];i||customElements.define("marp-auto-scaling",s);for(const n of Object.keys(t)){const s=`marp-${n}`,a=t[n].proto();null!=r||(r=!!document.createElement("div",{is:"marp-auto-scaling"}).outerHTML.startsWith("<div is")),r&&a!==HTMLElement?i||customElements.define(s,o(a,{style:t[n].style}),{extends:n}):(i||customElements.define(s,o(HTMLElement,t[n])),e.querySelectorAll(`${n}[is="${s}"]`).forEach((t=>{t.outerHTML=t.outerHTML.replace(new RegExp(`^<${n}`,"i"),`<${s}`).replace(new RegExp(`</${n}>$`,"i"),`</${s}>`)})))}window[a]=!0})(e),e[b])return e[b];const i=v({target:e}),n=()=>{i(),delete e[b]},l=Object.assign(n,{cleanup:n,update:()=>w(e)});return Object.defineProperty(e,b,{configurable:!0,value:l}),l},y=document.currentScript;w(y?y.getRootNode():document)}();
</script></foreignObject></svg></div><script>/*!! License: https://unpkg.com/@marp-team/marp-cli@3.4.0/lib/bespoke.js.LICENSE.txt */
!function(){"use strict";function e(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var t={from:function(e,t){var n,r=1===(e.parent||e).nodeType?e.parent||e:document.querySelector(e.parent||e),o=[].filter.call("string"==typeof e.slides?r.querySelectorAll(e.slides):e.slides||r.children,(function(e){return"SCRIPT"!==e.nodeName})),i={},a=function(e,t){return(t=t||{}).index=o.indexOf(e),t.slide=e,t},s=function(e,t){i[e]=(i[e]||[]).filter((function(e){return e!==t}))},l=function(e,t){return(i[e]||[]).reduce((function(e,n){return e&&!1!==n(t)}),!0)},c=function(e,t){o[e]&&(n&&l("deactivate",a(n,t)),n=o[e],l("activate",a(n,t)))},d=function(e,t){var r=o.indexOf(n)+e;l(e>0?"next":"prev",a(n,t))&&c(r,t)},u={off:s,on:function(e,t){return(i[e]||(i[e]=[])).push(t),s.bind(null,e,t)},fire:l,slide:function(e,t){if(!arguments.length)return o.indexOf(n);l("slide",a(o[e],t))&&c(e,t)},next:d.bind(null,1),prev:d.bind(null,-1),parent:r,slides:o,destroy:function(e){l("destroy",a(n,e)),i={}}};return(t||[]).forEach((function(e){e(u)})),n||c(0),u}},n=e(t);const r=document.body,o=(...e)=>history.replaceState(...e),i="presenter",a="next",s=["",i,a],l="bespoke-marp-",c=`data-${l}`,d=(e,{protocol:t,host:n,pathname:r,hash:o}=location)=>{const i=e.toString();return`${t}//${n}${r}${i?"?":""}${i}${o}`},u=()=>r.dataset.bespokeView,f=e=>new URLSearchParams(location.search).get(e),m=(e,t={})=>{var n;const r={location,setter:o,...t},i=new URLSearchParams(r.location.search);for(const t of Object.keys(e)){const n=e[t];"string"==typeof n?i.set(t,n):i.delete(t)}try{r.setter({...null!==(n=window.history.state)&&void 0!==n?n:{}},"",d(i,r.location))}catch(e){console.error(e)}},g=(()=>{const e="bespoke-marp";try{return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch(e){return!1}})(),p=e=>{try{return localStorage.getItem(e)}catch(e){return null}},v=(e,t)=>{try{return localStorage.setItem(e,t),!0}catch(e){return!1}},h=e=>{try{return localStorage.removeItem(e),!0}catch(e){return!1}},y=(e,t)=>{const n="aria-hidden";t?e.setAttribute(n,"true"):e.removeAttribute(n)},b=e=>{e.parent.classList.add(`${l}parent`),e.slides.forEach((e=>e.classList.add(`${l}slide`))),e.on("activate",(t=>{const n=`${l}active`,r=t.slide,o=r.classList,i=!o.contains(n);if(e.slides.forEach((e=>{e.classList.remove(n),y(e,!0)})),o.add(n),y(r,!1),i){const e=`${n}-ready`;o.add(e),document.body.clientHeight,o.remove(e)}}))},w=e=>{let t=0,n=0;Object.defineProperty(e,"fragments",{enumerable:!0,value:e.slides.map((e=>[null,...e.querySelectorAll("[data-marpit-fragment]")]))});const r=r=>void 0!==e.fragments[t][n+r],o=(r,o)=>{t=r,n=o,e.fragments.forEach(((e,t)=>{e.forEach(((e,n)=>{if(null==e)return;const i=t<r||t===r&&n<=o;e.setAttribute(`${c}fragment`,(i?"":"in")+"active");const a=`${c}current-fragment`;t===r&&n===o?e.setAttribute(a,"current"):e.removeAttribute(a)}))})),e.fragmentIndex=o;const i={slide:e.slides[r],index:r,fragments:e.fragments[r],fragmentIndex:o};e.fire("fragment",i)};e.on("next",(({fragment:i=!0})=>{if(i){if(r(1))return o(t,n+1),!1;const i=t+1;e.fragments[i]&&o(i,0)}else{const r=e.fragments[t].length;if(n+1<r)return o(t,r-1),!1;const i=e.fragments[t+1];i&&o(t+1,i.length-1)}})),e.on("prev",(({fragment:i=!0})=>{if(r(-1)&&i)return o(t,n-1),!1;const a=t-1;e.fragments[a]&&o(a,e.fragments[a].length-1)})),e.on("slide",(({index:t,fragment:n})=>{let r=0;if(void 0!==n){const o=e.fragments[t];if(o){const{length:e}=o;r=-1===n?e-1:Math.min(Math.max(n,0),e-1)}}o(t,r)})),o(0,0)},x=document,k=()=>!(!x.fullscreenEnabled&&!x.webkitFullscreenEnabled),$=()=>!(!x.fullscreenElement&&!x.webkitFullscreenElement),E=e=>{e.fullscreen=()=>{k()&&(async()=>{return $()?null===(e=x.exitFullscreen||x.webkitExitFullscreen)||void 0===e?void 0:e.call(x):((e=x.body)=>{var t;return null===(t=e.requestFullscreen||e.webkitRequestFullscreen)||void 0===t?void 0:t.call(e)})();var e})()},document.addEventListener("keydown",(t=>{"f"!==t.key&&"F11"!==t.key||t.altKey||t.ctrlKey||t.metaKey||!k()||(e.fullscreen(),t.preventDefault())}))},L=`${l}inactive`,S=(e=2e3)=>({parent:t,fire:n})=>{const r=t.classList,o=e=>n(`marp-${e?"":"in"}active`);let i;const a=()=>{i&&clearTimeout(i),i=setTimeout((()=>{r.add(L),o()}),e),r.contains(L)&&(r.remove(L),o(!0))};for(const e of["mousedown","mousemove","touchend"])document.addEventListener(e,a);setTimeout(a,0)},P=["AUDIO","BUTTON","INPUT","SELECT","TEXTAREA","VIDEO"],_=e=>{e.parent.addEventListener("keydown",(e=>{if(!e.target)return;const t=e.target;(P.includes(t.nodeName)||"true"===t.contentEditable)&&e.stopPropagation()}))},T=e=>{window.addEventListener("load",(()=>{for(const t of e.slides){const e=t.querySelector("marp-auto-scaling, [data-auto-scaling], [data-marp-fitting]");t.setAttribute(`${c}load`,e?"":"hideable")}}))},I=({interval:e=250}={})=>t=>{document.addEventListener("keydown",(e=>{if(" "===e.key&&e.shiftKey)t.prev();else if("ArrowLeft"===e.key||"ArrowUp"===e.key||"PageUp"===e.key)t.prev({fragment:!e.shiftKey});else if(" "!==e.key||e.shiftKey)if("ArrowRight"===e.key||"ArrowDown"===e.key||"PageDown"===e.key)t.next({fragment:!e.shiftKey});else if("End"===e.key)t.slide(t.slides.length-1,{fragment:-1});else{if("Home"!==e.key)return;t.slide(0)}else t.next();e.preventDefault()}));let n,r,o=0;t.parent.addEventListener("wheel",(i=>{let a=!1;const s=(e,t)=>{e&&(a=a||((e,t)=>((e,t)=>{const n="X"===t?"Width":"Height";return e[`client${n}`]<e[`scroll${n}`]})(e,t)&&((e,t)=>{const{overflow:n}=e,r=e[`overflow${t}`];return"auto"===n||"scroll"===n||"auto"===r||"scroll"===r})(getComputedStyle(e),t))(e,t)),(null==e?void 0:e.parentElement)&&s(e.parentElement,t)};if(0!==i.deltaX&&s(i.target,"X"),0!==i.deltaY&&s(i.target,"Y"),a)return;i.preventDefault();const l=Math.sqrt(i.deltaX**2+i.deltaY**2);if(void 0!==i.wheelDelta){if(void 0===i.webkitForce&&Math.abs(i.wheelDelta)<40)return;if(i.deltaMode===i.DOM_DELTA_PIXEL&&l<4)return}else if(i.deltaMode===i.DOM_DELTA_PIXEL&&l<12)return;r&&clearTimeout(r),r=setTimeout((()=>{n=0}),e);const c=Date.now()-o<e,d=l<=n;if(n=l,c||d)return;let u;(i.deltaX>0||i.deltaY>0)&&(u="next"),(i.deltaX<0||i.deltaY<0)&&(u="prev"),u&&(t[u](),o=Date.now())}))},M=(e=`.${l}osc`)=>{const t=document.querySelector(e);if(!t)return()=>{};const n=(e,n)=>{t.querySelectorAll(`[${c}osc=${JSON.stringify(e)}]`).forEach(n)};return k()||n("fullscreen",(e=>e.style.display="none")),g||n("presenter",(e=>{e.disabled=!0,e.title="Presenter view is disabled due to restricted localStorage."})),e=>{t.addEventListener("click",(t=>{if(t.target instanceof HTMLElement){const{bespokeMarpOsc:n}=t.target.dataset;n&&t.target.blur();const r={fragment:!t.shiftKey};"next"===n?e.next(r):"prev"===n?e.prev(r):"fullscreen"===n?null==e||e.fullscreen():"presenter"===n&&e.openPresenterView()}})),e.parent.appendChild(t),e.on("activate",(({index:t})=>{n("page",(n=>n.textContent=`Page ${t+1} of ${e.slides.length}`))})),e.on("fragment",(({index:t,fragments:r,fragmentIndex:o})=>{n("prev",(e=>e.disabled=0===t&&0===o)),n("next",(n=>n.disabled=t===e.slides.length-1&&o===r.length-1))})),e.on("marp-active",(()=>y(t,!1))),e.on("marp-inactive",(()=>y(t,!0))),k()&&(e=>{for(const t of["","webkit"])x.addEventListener(t+"fullscreenchange",e)})((()=>n("fullscreen",(e=>e.classList.toggle("exit",k()&&$())))))}},O=e=>{window.addEventListener("message",(t=>{if(t.origin!==window.origin)return;const[n,r]=t.data.split(":");if("navigate"===n){const[t,n]=r.split(",");let o=Number.parseInt(t,10),i=Number.parseInt(n,10)+1;i>=e.fragments[o].length&&(o+=1,i=0),e.slide(o,{fragment:i})}}))};var A=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"];let C=e=>String(e).replace(/[&<>"']/g,(e=>`&${D[e]};`)),D={"&":"amp","<":"lt",">":"gt",'"':"quot","'":"apos"},N="dangerouslySetInnerHTML",B={className:"class",htmlFor:"for"},q={};function K(e,t){let n=[],r="";t=t||{};for(let e=arguments.length;e-- >2;)n.push(arguments[e]);if("function"==typeof e)return t.children=n.reverse(),e(t);if(e){if(r+="<"+e,t)for(let e in t)!1!==t[e]&&null!=t[e]&&e!==N&&(r+=` ${B[e]?B[e]:C(e)}="${C(t[e])}"`);r+=">"}if(-1===A.indexOf(e)){if(t[N])r+=t[N].__html;else for(;n.length;){let e=n.pop();if(e)if(e.pop)for(let t=e.length;t--;)n.push(e[t]);else r+=!0===q[e]?e:C(e)}r+=e?`</${e}>`:""}return q[r]=!0,r}const j=({children:e})=>K(null,null,...e),F=`${l}presenter-`,V={container:`${F}container`,dragbar:`${F}dragbar-container`,next:`${F}next`,nextContainer:`${F}next-container`,noteContainer:`${F}note-container`,noteWrapper:`${F}note-wrapper`,noteButtons:`${F}note-buttons`,infoContainer:`${F}info-container`,infoPage:`${F}info-page`,infoPageText:`${F}info-page-text`,infoPagePrev:`${F}info-page-prev`,infoPageNext:`${F}info-page-next`,noteButtonsBigger:`${F}note-bigger`,noteButtonsSmaller:`${F}note-smaller`,infoTime:`${F}info-time`,infoTimer:`${F}info-timer`},U=e=>{const{title:t}=document;document.title="[Presenter view]"+(t?` - ${t}`:"");const n={},r=e=>(n[e]=n[e]||document.querySelector(`.${e}`),n[e]);document.body.appendChild((e=>{const t=document.createElement("div");return t.className=V.container,t.appendChild(e),t.insertAdjacentHTML("beforeend",K(j,null,K("div",{class:V.nextContainer},K("iframe",{class:V.next,src:"?view=next"})),K("div",{class:V.dragbar}),K("div",{class:V.noteContainer},K("div",{class:V.noteWrapper}),K("div",{class:V.noteButtons},K("button",{class:V.noteButtonsSmaller,tabindex:"-1",title:"Smaller notes font size"},"Smaller notes font size"),K("button",{class:V.noteButtonsBigger,tabindex:"-1",title:"Bigger notes font size"},"Bigger notes font size"))),K("div",{class:V.infoContainer},K("div",{class:V.infoPage},K("button",{class:V.infoPagePrev,tabindex:"-1",title:"Previous"},"Previous"),K("span",{class:V.infoPageText}),K("button",{class:V.infoPageNext,tabindex:"-1",title:"Next"},"Next")),K("time",{class:V.infoTime,title:"Current time"}),K("time",{class:V.infoTimer,title:"Timer"})))),t})(e.parent)),(e=>{let t=!1;r(V.dragbar).addEventListener("mousedown",(()=>{t=!0,r(V.dragbar).classList.add("active")})),window.addEventListener("mouseup",(()=>{t=!1,r(V.dragbar).classList.remove("active")})),window.addEventListener("mousemove",(e=>{if(!t)return;const n=e.clientX/document.documentElement.clientWidth*100;r(V.container).style.setProperty("--bespoke-marp-presenter-split-ratio",`${Math.max(0,Math.min(100,n))}%`)})),r(V.nextContainer).addEventListener("click",(()=>e.next()));const n=r(V.next),o=(i=n,(e,t)=>{var n;return null===(n=i.contentWindow)||void 0===n?void 0:n.postMessage(`navigate:${e},${t}`,"null"===window.origin?"*":window.origin)});var i;n.addEventListener("load",(()=>{r(V.nextContainer).classList.add("active"),o(e.slide(),e.fragmentIndex),e.on("fragment",(({index:e,fragmentIndex:t})=>o(e,t)))}));const a=document.querySelectorAll(".bespoke-marp-note");a.forEach((e=>{e.addEventListener("keydown",(e=>e.stopPropagation())),r(V.noteWrapper).appendChild(e)})),e.on("activate",(()=>a.forEach((t=>t.classList.toggle("active",t.dataset.index==e.slide())))));let s=0;const l=e=>{s=Math.max(-5,s+e),r(V.noteContainer).style.setProperty("--bespoke-marp-note-font-scale",(1.2**s).toFixed(4))},c=()=>l(1),d=()=>l(-1),u=r(V.noteButtonsBigger),f=r(V.noteButtonsSmaller);u.addEventListener("click",(()=>{u.blur(),c()})),f.addEventListener("click",(()=>{f.blur(),d()})),document.addEventListener("keydown",(e=>{"+"===e.key&&c(),"-"===e.key&&d()}),!0),e.on("activate",(({index:t})=>{r(V.infoPageText).textContent=`${t+1} / ${e.slides.length}`}));const m=r(V.infoPagePrev),g=r(V.infoPageNext);m.addEventListener("click",(t=>{m.blur(),e.prev({fragment:!t.shiftKey})})),g.addEventListener("click",(t=>{g.blur(),e.next({fragment:!t.shiftKey})})),e.on("fragment",(({index:t,fragments:n,fragmentIndex:r})=>{m.disabled=0===t&&0===r,g.disabled=t===e.slides.length-1&&r===n.length-1}));let p=new Date;const v=()=>{const e=new Date,t=e=>`${Math.floor(e)}`.padStart(2,"0"),n=e.getTime()-p.getTime(),o=t(n/1e3%60),i=t(n/1e3/60%60),a=t(n/36e5%24);r(V.infoTime).textContent=e.toLocaleTimeString(),r(V.infoTimer).textContent=`${a}:${i}:${o}`};v(),setInterval(v,250),r(V.infoTimer).addEventListener("click",(()=>{p=new Date}))})(e)},X=e=>{if(!(e=>e.syncKey&&"string"==typeof e.syncKey)(e))throw new Error("The current instance of Bespoke.js is invalid for Marp bespoke presenter plugin.");Object.defineProperties(e,{openPresenterView:{enumerable:!0,value:H},presenterUrl:{enumerable:!0,get:R}}),g&&document.addEventListener("keydown",(t=>{"p"!==t.key||t.altKey||t.ctrlKey||t.metaKey||(t.preventDefault(),e.openPresenterView())}))};function H(){const{max:e,floor:t}=Math,n=e(t(.85*window.innerWidth),640),r=e(t(.85*window.innerHeight),360);return window.open(this.presenterUrl,F+this.syncKey,`width=${n},height=${r},menubar=no,toolbar=no`)}function R(){const e=new URLSearchParams(location.search);return e.set("view","presenter"),e.set("sync",this.syncKey),d(e)}const W=e=>{const t=u();return t===a&&e.appendChild(document.createElement("span")),{"":X,[i]:U,[a]:O}[t]},J=e=>{e.on("activate",(t=>{document.querySelectorAll(".bespoke-progress-parent > .bespoke-progress-bar").forEach((n=>{n.style.flexBasis=100*t.index/(e.slides.length-1)+"%"}))}))},Y=e=>{const t=Number.parseInt(e,10);return Number.isNaN(t)?null:t},z=(e={})=>{const t={history:!0,...e};return e=>{let n=!0;const r=e=>{const t=n;try{return n=!0,e()}finally{n=t}},o=(t={fragment:!0})=>{let n=t.fragment?Y(f("f")||""):null;((t,n)=>{const{min:r,max:o}=Math,{fragments:i,slides:a}=e,s=o(0,r(t,a.length-1)),l=o(0,r(n||0,i[s].length-1));s===e.slide()&&l===e.fragmentIndex||e.slide(s,{fragment:l})})((()=>{var t,r;if(location.hash){const[o]=location.hash.slice(1).split(":~:");if(/^\d+$/.test(o))return(null!==(t=Y(o))&&void 0!==t?t:1)-1;const i=document.getElementById(o)||document.querySelector(`a[name="${CSS.escape(o)}"]`);if(i){const{length:t}=e.slides;for(let o=0;o<t;o+=1)if(e.slides[o].contains(i)){const t=null===(r=e.fragments)||void 0===r?void 0:r[o],a=i.closest("[data-marpit-fragment]");if(t&&a){const e=t.indexOf(a);e>=0&&(n=e)}return o}}}return 0})(),n)};e.on("fragment",(({index:e,fragmentIndex:r})=>{n||m({f:0===r||r.toString()},{location:{...location,hash:`#${e+1}`},setter:(...e)=>t.history?history.pushState(...e):history.replaceState(...e)})})),setTimeout((()=>{o(),window.addEventListener("hashchange",(()=>r((()=>{o({fragment:!1}),m({f:void 0})})))),window.addEventListener("popstate",(()=>{n||r((()=>o()))})),n=!1}),0)}},G=(e={})=>{var t;const n=e.key||(null===(t=window.history.state)||void 0===t?void 0:t.marpBespokeSyncKey)||Math.random().toString(36).slice(2),r=`bespoke-marp-sync-${n}`;var i;i={marpBespokeSyncKey:n},m({},{setter:(e,...t)=>o({...e,...i},...t)});const a=()=>{const e=p(r);return e?JSON.parse(e):Object.create(null)},s=e=>{const t=a(),n={...t,...e(t)};return v(r,JSON.stringify(n)),n},l=()=>{window.removeEventListener("pageshow",l),s((e=>({reference:(e.reference||0)+1})))};return e=>{l(),Object.defineProperty(e,"syncKey",{value:n,enumerable:!0});let t=!0;setTimeout((()=>{e.on("fragment",(e=>{t&&s((()=>({index:e.index,fragmentIndex:e.fragmentIndex})))}))}),0),window.addEventListener("storage",(n=>{if(n.key===r&&n.oldValue&&n.newValue){const r=JSON.parse(n.oldValue),o=JSON.parse(n.newValue);if(r.index!==o.index||r.fragmentIndex!==o.fragmentIndex)try{t=!1,e.slide(o.index,{fragment:o.fragmentIndex,forSync:!0})}finally{t=!0}}}));const o=()=>{const{reference:e}=a();void 0===e||e<=1?h(r):s((()=>({reference:e-1})))};window.addEventListener("pagehide",(e=>{e.persisted&&window.addEventListener("pageshow",l),o()})),e.on("destroy",o)}},{PI:Q,abs:Z,sqrt:ee,atan2:te}=Math,ne={passive:!0},re=({slope:e=-.7,swipeThreshold:t=30}={})=>n=>{let r;const o=n.parent,i=e=>{const t=o.getBoundingClientRect();return{x:e.pageX-(t.left+t.right)/2,y:e.pageY-(t.top+t.bottom)/2}};o.addEventListener("touchstart",(({touches:e})=>{r=1===e.length?i(e[0]):void 0}),ne),o.addEventListener("touchmove",(e=>{if(r)if(1===e.touches.length){e.preventDefault();const t=i(e.touches[0]),n=t.x-r.x,o=t.y-r.y;r.delta=ee(Z(n)**2+Z(o)**2),r.radian=te(n,o)}else r=void 0})),o.addEventListener("touchend",(o=>{if(r){if(r.delta&&r.delta>=t&&r.radian){const t=(r.radian-e+Q)%(2*Q)-Q;n[t<0?"next":"prev"](),o.stopPropagation()}r=void 0}}),ne)},oe=new Map;oe.clear(),oe.set("none",{backward:{both:void 0,incoming:void 0,outgoing:void 0},forward:{both:void 0,incoming:void 0,outgoing:void 0}});const ie={both:"",outgoing:"outgoing-",incoming:"incoming-"},ae={forward:"",backward:"-backward"},se=e=>`--marp-bespoke-transition-animation-${e}`,le=e=>`--marp-transition-${e}`,ce=se("name"),de=se("duration"),ue=e=>new Promise((t=>{const n={},r=document.createElement("div"),o=e=>{r.remove(),t(e)};r.addEventListener("animationstart",(()=>o(n))),Object.assign(r.style,{animationName:e,animationDuration:"1s",animationFillMode:"both",animationPlayState:"paused",position:"absolute",pointerEvents:"none"}),document.body.appendChild(r);const i=getComputedStyle(r).getPropertyValue(le("duration"));i&&(n.defaultDuration=i),((e,t)=>{requestAnimationFrame((()=>{e.style.animationPlayState="running",requestAnimationFrame((()=>t(void 0)))}))})(r,o)})),fe=async e=>oe.has(e)?oe.get(e):(e=>{const t={},n=[];for(const[r,o]of Object.entries(ie))for(const[i,a]of Object.entries(ae)){const s=`marp-${o}transition${a}-${e}`;n.push(ue(s).then((e=>{t[i]=t[i]||{},t[i][r]=e?{...e,name:s}:void 0})))}return Promise.all(n).then((()=>t))})(e).then((t=>(oe.set(e,t),t))),me=e=>Object.values(e).flatMap(Object.values).every((e=>!e)),ge=(e,{type:t,backward:n})=>{const r=e[n?"backward":"forward"],o=(()=>{const e=r[t],n=e=>({[ce]:e.name});if(e)return n(e);if(r.both){const e=n(r.both);return"incoming"===t&&(e[se("direction")]="reverse"),e}})();return!o&&n?ge(e,{type:t,backward:!1}):o||{[ce]:"__bespoke_marp_transition_no_animation__"}},pe=e=>{if(e)try{const t=JSON.parse(e);if((e=>{if("object"!=typeof e)return!1;const t=e;return"string"==typeof t.name&&(void 0===t.duration||"string"==typeof t.duration)})(t))return t}catch(e){}},ve="_tSId",he="_tA",ye="bespoke-marp-transition-warming-up",be=window.matchMedia("(prefers-reduced-motion: reduce)"),we="__bespoke_marp_transition_reduced_outgoing__",xe="__bespoke_marp_transition_reduced_incoming__",ke={forward:{both:void 0,incoming:{name:xe},outgoing:{name:we}},backward:{both:void 0,incoming:{name:xe},outgoing:{name:we}}},$e=e=>{if(!document.startViewTransition)return;const t=t=>(void 0!==t&&(e._tD=t),e._tD);let n;t(!1),((...e)=>{const t=[...new Set(e).values()];return Promise.all(t.map((e=>fe(e)))).then()})(...Array.from(document.querySelectorAll("section[data-transition], section[data-transition-back]")).flatMap((e=>[e.dataset.transition,e.dataset.transitionBack].flatMap((e=>{const t=pe(e);return[null==t?void 0:t.name,(null==t?void 0:t.builtinFallback)?`__builtin__${t.name}`:void 0]})).filter((e=>!!e))))).then((()=>{document.querySelectorAll("style").forEach((e=>{e.innerHTML=e.innerHTML.replace(/--marp-transition-duration:[^;}]*[;}]/g,(e=>e.slice(0,-1)+"!important"+e.slice(-1)))}))}));const r=(n,{back:r,cond:o})=>i=>{var a;const s=t();if(s)return!!i[he]||!("object"!=typeof s||(s.skipTransition(),!i.forSync));if(!o(i))return!0;const l=e.slides[e.slide()],c=()=>{var e;return null!==(e=i.back)&&void 0!==e?e:r},d="data-transition"+(c()?"-back":""),u=l.querySelector(`section[${d}]`);if(!u)return!0;const f=pe(null!==(a=u.getAttribute(d))&&void 0!==a?a:void 0);return!f||((async(e,{builtinFallback:t=!0}={})=>{let n=await fe(e);if(me(n)){if(!t)return;return n=await fe(`__builtin__${e}`),me(n)?void 0:n}return n})(f.name,{builtinFallback:f.builtinFallback}).then((e=>{if(!e){t(!0);try{n(i)}finally{t(!1)}return}let r=e;be.matches&&(console.warn("Use a constant animation to transition because preferring reduced motion by viewer has detected."),r=ke);const o=document.getElementById(ve);o&&o.remove();const a=document.createElement("style");a.id=ve,document.head.appendChild(a),((e,t)=>{const n=[`:root{${le("direction")}:${t.backward?-1:1};}`,":root:has(.bespoke-marp-inactive){cursor:none;}"],r=t=>{var n,o,i;const a=(null===(n=e[t].both)||void 0===n?void 0:n.defaultDuration)||(null===(o=e[t].outgoing)||void 0===o?void 0:o.defaultDuration)||(null===(i=e[t].incoming)||void 0===i?void 0:i.defaultDuration);return"forward"===t?a:a||r("forward")},o=t.duration||r(t.backward?"backward":"forward");void 0!==o&&n.push(`::view-transition-group(*){${de}:${o};}`);const i=e=>Object.entries(e).map((([e,t])=>`${e}:${t};`)).join("");return n.push(`::view-transition-old(root){${i(ge(e,{...t,type:"outgoing"}))}}`,`::view-transition-new(root){${i(ge(e,{...t,type:"incoming"}))}}`),n})(r,{backward:c(),duration:f.duration}).forEach((e=>{var t;return null===(t=a.sheet)||void 0===t?void 0:t.insertRule(e)}));const s=document.documentElement.classList;s.add(ye);let l=!1;const d=()=>{l||(n(i),l=!0,s.remove(ye))},u=()=>{t(!1),a.remove(),s.remove(ye)};try{t(!0);const e=document.startViewTransition(d);t(e),e.finished.finally(u)}catch(e){console.error(e),d(),u()}})),!1)};e.on("prev",r((t=>e.prev({...t,[he]:!0})),{back:!0,cond:e=>{var t;return e.index>0&&!((null===(t=e.fragment)||void 0===t||t)&&n.fragmentIndex>0)}})),e.on("next",r((t=>e.next({...t,[he]:!0})),{cond:t=>t.index+1<e.slides.length&&!(n.fragmentIndex+1<n.fragments.length)})),setTimeout((()=>{e.on("slide",r((t=>e.slide(t.index,{...t,[he]:!0})),{cond:t=>{const n=e.slide();return t.index!==n&&(t.back=t.index<n,!0)}}))}),0),e.on("fragment",(e=>{n=e}))};let Ee;const Le=()=>(void 0===Ee&&(Ee="wakeLock"in navigator&&navigator.wakeLock),Ee),Se=async()=>{const e=Le();if(e)try{return await e.request("screen")}catch(e){console.warn(e)}return null},Pe=async()=>{if(!Le())return;let e;const t=()=>{e&&"visible"===document.visibilityState&&Se()};for(const e of["visibilitychange","fullscreenchange"])document.addEventListener(e,t);return e=await Se(),e};((e=document.getElementById(":$p"))=>{(()=>{const e=f("view");r.dataset.bespokeView=e===a||e===i?e:""})();const t=(e=>{const t=f(e);return m({[e]:void 0}),t})("sync")||void 0;n.from(e,((...e)=>{const t=s.findIndex((e=>u()===e));return e.map((([e,n])=>e[t]&&n)).filter((e=>e))})([[1,1,0],G({key:t})],[[1,1,1],W(e)],[[1,1,0],_],[[1,1,1],b],[[1,0,0],S()],[[1,1,1],T],[[1,1,1],z({history:!1})],[[1,1,0],I()],[[1,1,0],E],[[1,0,0],J],[[1,1,0],re()],[[1,0,0],M()],[[1,0,0],$e],[[1,1,1],w],[[1,1,0],Pe]))})()}();</script></body></html>